{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                colors: {
                    primary: {
                        50: 'var(--color-primary-50)',
                        100: 'var(--color-primary-100)',
                        200: 'var(--color-primary-200)',
                        300: 'var(--color-primary-300)',
                        400: 'var(--color-primary-400)',
                        500: 'var(--color-primary-500)',
                        600: 'var(--color-primary-600)',
                        700: 'var(--color-primary-700)',
                        800: 'var(--color-primary-800)',
                        900: 'var(--color-primary-900)',
                    },
                    success: {
                        50: '#f0fdf4',
                        500: '#22c55e',
                        600: '#16a34a',
                    },
                    warning: {
                        50: '#fffbeb',
                        500: '#f59e0b',
                        600: '#d97706',
                    }
                }
            }
        }
    }
</script>
<style>
    .required-field::after {
        content: " *";
        color: #ef4444;
    }

    .dark .required-field::after {
        color: #f87171;
    }

    .form-input {
        width: 100%;
        padding: 0.625rem 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        transition: all 0.2s;
        background-color: white;
        color: #374151;
    }

    .dark .form-input {
        background-color: var(--color-background-default);
        border-color: var(--color-border-default);
        color: var(--color-font-default);
    }

    .form-input:focus {
        outline: none;
        border-color: var(--color-primary-500);
        box-shadow: 0 0 0 2px var(--color-primary-500);
    }

    .form-select {
        width: 100%;
        padding: 0.625rem 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        background-color: white;
        color: #374151;
        transition: all 0.2s;
    }

    .dark .form-select {
        background-color: var(--color-background-default);
        border-color: var(--color-border-default);
        color: var(--color-font-default);
    }

    .form-select:focus {
        outline: none;
        border-color: var(--color-primary-500);
        box-shadow: 0 0 0 2px var(--color-primary-500);
    }

    .form-textarea {
        width: 100%;
        padding: 0.625rem 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        resize: none;
        transition: all 0.2s;
        background-color: white;
        color: #374151;
    }

    .dark .form-textarea {
        background-color: var(--color-background-default);
        border-color: var(--color-border-default);
        color: var(--color-font-default);
    }

    .form-textarea:focus {
        outline: none;
        border-color: var(--color-primary-500);
        box-shadow: 0 0 0 2px var(--color-primary-500);
    }

    .form-section {
        background: linear-gradient(to bottom right, #ffffff, #f9fafb);
        border-radius: 0.75rem;
        padding: 1.5rem;
        border: 1px solid #f3f4f6;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.2s;
    }

    .dark .form-section {
        background: linear-gradient(to bottom right, var(--color-background-elevated), var(--color-background-default));
        border-color: var(--color-border-default);
    }

    .form-section:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .form-section-header {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #f3f4f6;
    }

    .dark .form-section-header {
        border-bottom-color: var(--color-border-default);
    }

    .form-section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #374151;
        display: flex;
        align-items: center;
    }

    .dark .form-section-title {
        color: var(--color-font-default);
    }

    .form-section-icon {
        width: 2.5rem;
        height: 2.5rem;
        background-color: var(--color-primary-100);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
    }

    .total-display {
        background: linear-gradient(to right, var(--color-primary-50), var(--color-primary-100));
        border: 1px solid var(--color-primary-200);
        border-radius: 0.75rem;
        padding: 1.25rem;
    }

    .submit-button {
        background: linear-gradient(to right, var(--color-primary-600), var(--color-primary-700));
        color: white;
        font-weight: 600;
        padding: 0.75rem 2rem;
        border-radius: 0.75rem;
        transition: all 0.2s;
        transform: scale(1);
        outline: none;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .submit-button:hover {
        background: linear-gradient(to right, var(--color-primary-700), var(--color-primary-800));
        transform: scale(1.05);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .submit-button:focus {
        outline: none;
        box-shadow: 0 0 0 2px var(--color-primary-500), 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-primary {
        background-color: var(--color-primary-100);
        color: var(--color-primary-800);
    }

    .dark .badge-primary {
        background-color: var(--color-primary-900);
        color: var(--color-primary-200);
    }

    .badge-success {
        background-color: #dcfce7;
        color: #166534;
    }

    .dark .badge-success {
        background-color: #14532d;
        color: #bbf7d0;
    }

    .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    /* New styles for navigation buttons */
    .nav-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 0.75rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }

    .nav-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .nav-button:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .nav-button:not(:disabled):active {
        transform: translateY(0);
    }

    .nav-button.next {
        background: linear-gradient(135deg, var(--color-primary-600), var(--color-primary-700));
        color: white;
    }

    .nav-button.next:hover {
        background: linear-gradient(135deg, var(--color-primary-700), var(--color-primary-800));
    }

    .nav-button.prev {
        background: white;
        color: var(--color-primary-700);
        border: 2px solid var(--color-primary-200);
    }

    .dark .nav-button.prev {
        background: var(--color-background-default);
        border-color: var(--color-primary-600);
    }

    .nav-button.prev:hover {
        background: var(--color-primary-50);
        border-color: var(--color-primary-300);
    }

    .dark .nav-button.prev:hover {
        background: var(--color-primary-900);
    }

    .button-spinner {
        display: none;
        width: 1rem;
        height: 1rem;
        border: 2px solid transparent;
        border-radius: 50%;
        border-top-color: currentColor;
        animation: spin 1s linear infinite;
        margin-left: 0.5rem;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .button-container {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e5e7eb;
    }

    .dark .button-container {
        border-top-color: #4b5563;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 dark:bg-gray-900">
    <!-- Progress Steps -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8">
        <div class="flex justify-center">
            <div class="flex items-center space-x-8">
                <div class="flex flex-col items-center">

                    <div id="step-1-indicator"
                        class="w-12 h-12 bg-primary-600 text-white rounded-full flex items-center justify-center font-bold text-lg">
                        1
                    </div>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mt-2">Customer</span>

                </div>
                <div class="w-16 h-0.5 bg-primary-200 dark:bg-primary-700"></div>
                <div class="flex flex-col items-center">
                    <div id="step-2-indicator"
                        class="w-12 h-12 bg-primary-200 dark:bg-primary-700 text-gray-600 dark:text-gray-400 rounded-full flex items-center justify-center font-bold text-lg">
                        2
                    </div>
                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400 mt-2">Order</span>
                </div>
                <div class="w-16 h-0.5 bg-gray-200 dark:bg-gray-600"></div>
                <div class="flex flex-col items-center">
                    <div id="step-3-indicator"
                        class="w-12 h-12 bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-400 rounded-full flex items-center justify-center font-bold text-lg">
                        3
                    </div>
                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400 mt-2">Items</span>
                </div>
                <div class="w-16 h-0.5 bg-gray-200 dark:bg-gray-600"></div>
                <div class="flex flex-col items-center">
                    <div id="step-4-indicator"
                        class="w-12 h-12 bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-400 rounded-full flex items-center justify-center font-bold text-lg">
                        4
                    </div>
                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400 mt-2">Payment</span>
                </div>
            </div>
        </div>
    </div>

    {% if messages %}
    <div class="mb-8">
        {% for message in messages %}
        <div
            class="{% if message.tags == 'success' %}bg-success-50 dark:bg-green-900/20 border border-success-200 dark:border-green-700 text-success-800 dark:text-green-300{% else %}bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 text-red-800 dark:text-red-300{% endif %} rounded-xl p-4 shadow-sm">
            <div class="flex items-center">
                <i
                    class="fas {% if message.tags == 'success' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %} mr-3 text-lg"></i>
                <span class="font-medium">{{ message }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="post" id="laundryForm" class="space-y-8">
        {% csrf_token %}
        <input type="hidden" id="current_step" name="current_step" value="1">

        <!-- Customer Information -->
        <div class="div-content">
            <!-- Content will be dynamically updated via JavaScript -->
        </div>

        <!-- Navigation Buttons -->
        <div class="button-container">
            <button type="button" id="prevButton" class="nav-button prev" disabled>
                <i class="fas fa-arrow-left mr-2"></i> Previous
            </button>
            <button type="button" id="nextButton" class="nav-button next">
                Next <i class="fas fa-arrow-right ml-2"></i>
                <span class="button-spinner"></span>
            </button>
        </div>

        <!-- Action Buttons (Final Step) -->
        <div id="finalActions" class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 hidden">
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <a href="{% url 'admin:LaundryApp_order_changelist' %}"
                    class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:text-gray-200 transition-colors duration-200 flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Orders List
                </a>
                <div class="flex space-x-4">
                    <button type="reset"
                        class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200">
                        <i class="fas fa-redo mr-2"></i>Reset Form
                    </button>
                    <button type="submit" class="submit-button">
                        <i class="fas fa-paper-plane mr-2"></i>Create Order
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    // Define step templates
    const customerinfo = `
    <div class="form-section">
        <div class="form-section-header">
            <div class="form-section-title">
                <div class="form-section-icon">
                    <i class="fas fa-user text-primary-600 dark:text-primary-400"></i>
                </div>
                Customer Information
            </div>
            <span class="badge badge-primary">Step 1 of 4</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3 required-field">Customer Name</label>
                {{ customer_form.name }}
                {% if customer_form.name.errors %}
                <div class="text-red-600 text-sm mt-2 flex items-center">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    {{ customer_form.name.errors }}
                </div>
                {% endif %}
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3 required-field">Phone Number</label>
                {{ customer_form.phone }}
                <p class="text-gray-500 dark:text-gray-400 text-xs mt-2 flex items-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    System will automatically detect existing customers
                </p>
                {% if customer_form.phone.errors %}
                <div class="text-red-600 text-sm mt-2 flex items-center">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    {{ customer_form.phone.errors }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Customer Detection Status -->
        <div id="customerDetectionStatus" class="mt-4 hidden">
            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg p-4">
                <div class="flex items-center">
                    <i class="fas fa-search text-blue-600 dark:text-blue-400 mr-2"></i>
                    <span id="customerDetectionText" class="text-sm text-blue-800 dark:text-blue-200">
                        Checking if customer exists...
                    </span>
                </div>
            </div>
        </div>

    </div>`;

    const orderDetails = `
    <div class="form-section">
        <div class="form-section-header">
            <div class="form-section-title">
                <div class="form-section-icon">
                    <i class="fas fa-clipboard-list text-primary-600 dark:text-primary-400"></i>
                </div>
                Order Details
            </div>
            <span class="badge badge-primary">Step 2 of 4</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for field in order_form %}
            {% if field.name != 'address' and field.name != 'addressdetails' %}
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3 {% if field.field.required %}required-field{% endif %}">
                    {{ field.label }}
                </label>
                {{ field }}
                {% if field.errors %}
                <div class="text-red-600 text-sm mt-2 flex items-center">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    {{ field.errors }}
                </div>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <div class="grid grid-cols-1 gap-6 mt-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Address</label>
                {{ order_form.address }}
                {% if order_form.address.errors %}
                <div class="text-red-600 text-sm mt-2 flex items-center">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    {{ order_form.address.errors }}
                </div>
                {% endif %}
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Address Details</label>
                {{ order_form.addressdetails }}
                <p class="text-gray-500 dark:text-gray-400 text-xs mt-2 flex items-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    Additional address information (optional)
                </p>
                {% if order_form.addressdetails.errors %}
                <div class="text-red-600 text-sm mt-2 flex items-center">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    {{ order_form.addressdetails.errors }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>`;

    const laundryItems = `
    <div class="form-section">
        <div class="form-section-header">
            <div class="form-section-title">
                <div class="form-section-icon">
                    <i class="fas fa-tshirt text-primary-600 dark:text-primary-400"></i>
                </div>
                Laundry Items
            </div>
            <span class="badge badge-primary">Step 3 of 4</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for field in order_item_form %}
            {% if field.name != 'itemname' and field.name != 'additional_info' %}
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3 {% if field.field.required %}required-field{% endif %}">
                    {{ field.label }}
                </label>
                {{ field }}
                {% if field.errors %}
                <div class="text-red-600 text-sm mt-2 flex items-center">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    {{ field.errors }}
                </div>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <div class="grid grid-cols-1 gap-6 mt-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3 required-field">Item Names</label>
                {{ order_item_form.itemname }}
                <p class="text-gray-500 dark:text-gray-400 text-xs mt-2 flex items-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    Separate multiple items with commas
                </p>
                {% if order_item_form.itemname.errors %}
                <div class="text-red-600 text-sm mt-2 flex items-center">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    {{ order_item_form.itemname.errors }}
                </div>
                {% endif %}
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Additional Information</label>
                {{ order_item_form.additional_info }}
                <p class="text-gray-500 dark:text-gray-400 text-xs mt-2 flex items-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    Special instructions or notes (optional)
                </p>
                {% if order_item_form.additional_info.errors %}
                <div class="text-red-600 text-sm mt-2 flex items-center">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    {{ order_item_form.additional_info.errors }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Total Price Display -->
        <div class="total-display mt-8">
            <div class="flex justify-between items-center">
                <div>
                    <span class="text-lg font-semibold text-gray-800 dark:text-gray-200">Estimated Total:</span>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Based on quantity and unit price</p>
                </div>
                <span id="totalPrice" class="text-3xl font-bold text-primary-600 dark:text-primary-400 animate-pulse">KSh 0.00</span>
            </div>
        </div>
    </div>`;

    const paymentInfo = `
    <div class="form-section">
        <div class="form-section-header">
            <div class="form-section-title">
                <div class="form-section-icon">
                    <i class="fas fa-credit-card text-primary-600 dark:text-primary-400"></i>
                </div>
                Payment Information <span class="text-sm text-gray-500">(Optional)</span>
            </div>
            <span class="badge badge-primary">Step 4 of 4</span>
        </div>

        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-blue-600 dark:text-blue-400 mr-2"></i>
                <span class="text-sm text-blue-800 dark:text-blue-200">
                    Payment is optional. You can create the order now and collect payment later, or process payment immediately.
                </span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                    Payment Method
                </label>
                <select id="id_payment_method" name="payment_method" class="form-select">
                    <option value="">Select payment method (optional)</option>
                    <option value="cash">Cash</option>
                    <option value="mpesa">M-Pesa</option>
                    <option value="card">Credit/Debit Card</option>
                    <option value="bank_transfer">Bank Transfer</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div id="mpesaFields" style="display: none;">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                    Phone Number for M-Pesa
                </label>
                <input type="text" id="id_phone_number" name="phone_number" class="form-input"
                       placeholder="e.g., +254712345678 or 0712345678">
                <p class="text-gray-500 dark:text-gray-400 text-xs mt-2 flex items-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    Phone number linked to M-Pesa
                </p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                    Transaction ID
                </label>
                <input type="text" id="id_transaction_id" name="transaction_id" class="form-input"
                       placeholder="Transaction ID (if applicable)">
                <p class="text-gray-500 dark:text-gray-400 text-xs mt-2 flex items-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    For online payments or receipts
                </p>
            </div>

            <div id="mpesaReceiptField" style="display: none;">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                    M-Pesa Receipt Number
                </label>
                <input type="text" id="id_mpesa_receipt_number" name="mpesa_receipt_number" class="form-input"
                       placeholder="e.g., QF123456789">
                <p class="text-gray-500 dark:text-gray-400 text-xs mt-2 flex items-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    Receipt number from M-Pesa message
                </p>
            </div>
        </div>

        <div class="mt-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="text-sm font-medium text-gray-900 dark:text-white">Skip Payment</h4>
                    <p class="text-xs text-gray-600 dark:text-gray-400">Create order without payment - can be collected later</p>
                </div>
                <button type="button" id="skipPaymentBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 text-sm">
                    Skip Payment
                </button>
            </div>
        </div>
    </div>`;

    // Initialize variables
    const divContent = document.querySelector('.div-content');
    const currentStepInput = document.getElementById('current_step');
    const nextButton = document.getElementById('nextButton');
    const prevButton = document.getElementById('prevButton');
    const finalActions = document.getElementById('finalActions');
    let currentStep = 1;
    const totalSteps = 4;
    let orderId = null;
    let customerCheckTimeout = null;
    let customerExists = false;

    // Set initial content
    divContent.innerHTML = customerinfo;
    updateStepIndicators();

    // Add event listeners
    nextButton.addEventListener('click', handleNextStep);
    prevButton.addEventListener('click', handlePrevStep);

    // Function to handle next step
    function handleNextStep() {
        // Validate current step
        if (!validateStep(currentStep)) {
            return;
        }

        // Show loading spinner
        const spinner = nextButton.querySelector('.button-spinner');
        spinner.style.display = 'inline-block';
        nextButton.disabled = true;

        // Submit step data
        submitStepData()
            .then(handleStepResponse)
            .catch(handleStepError)
            .finally(() => {
                spinner.style.display = 'none';
                nextButton.disabled = false;
            });
    }

    // Function to handle step response
    function handleStepResponse(response) {
        if (response.success) {
            // Handle customer information for step 1
            if (currentStep === 1) {
                if (response.existing_customer !== undefined && response.existing_customer) {
                    // Set flag that customer exists
                    customerExists = true;

                    // Auto-fill the name field with existing customer's name
                    const nameField = document.getElementById('{{ customer_form.name.id_for_label }}');
                    if (nameField && response.customer_name) {
                        nameField.value = response.customer_name;
                    }

                    // Show a notification that existing customer was found
                    showCustomerExistsMessage(response.customer_name || response.message);

                    // Proceed to next step after a brief delay
                    setTimeout(() => {
                        moveToNextStep(response);
                    }, 1500);
                    return; // Exit early to prevent immediate step progression
                } else if (response.customer_id) {
                    // New customer was created successfully
                    customerExists = false;
                    showNewCustomerCreatedMessage();
                }
            }

            // For all other cases, proceed normally
            moveToNextStep(response);
        } else {
            // Show validation errors
            if (response.errors) {
                displayFormErrors(response.errors);
            } else {
                alert(response.message || 'An error has occured try again!');
            }
        }
    }

    // Function to move to the next step
    function moveToNextStep(response) {
        // If we just created an order, store the order ID
        if (response.order_id) {
            orderId = response.order_id;
        }

        // Move to next step
        currentStep++;
        currentStepInput.value = currentStep;

        // Update UI
        updateStepContent();
        updateStepIndicators();
        updateNavigationButtons();

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Function to show customer exists message
    function showCustomerExistsMessage(customerName) {
        // Create a notification message
        const messageDiv = document.createElement('div');
        messageDiv.className = 'fixed top-4 right-4 bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded z-50 animate-fade-in';
        messageDiv.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-user-check mr-2"></i>
                <span>Using existing customer: <strong>${customerName}</strong>. Redirecting to next step...</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-blue-700 hover:text-blue-900">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        document.body.appendChild(messageDiv);

        // Auto remove after 4 seconds
        setTimeout(() => {
            if (messageDiv.parentElement) {
                messageDiv.remove();
            }
        }, 4000);
    }

    // Function to show new customer created message
    function showNewCustomerCreatedMessage() {
        // Create a notification message
        const messageDiv = document.createElement('div');
        messageDiv.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50 animate-fade-in';
        messageDiv.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-user-plus mr-2"></i>
                <span>New customer created successfully. Proceeding to next step...</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-green-700 hover:text-green-900">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        document.body.appendChild(messageDiv);

        // Auto remove after 3 seconds
        setTimeout(() => {
            if (messageDiv.parentElement) {
                messageDiv.remove();
            }
        }, 3000);
    }

    // Function to handle step error
    function handleStepError(error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    }

    // Function to handle previous step
    function handlePrevStep() {
        currentStep--;
        currentStepInput.value = currentStep;

        // Update UI
        updateStepContent();
        updateStepIndicators();
        updateNavigationButtons();

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Function to update step content
    function updateStepContent() {
        switch (currentStep) {
            case 1:
                divContent.innerHTML = customerinfo;
                // Add event listeners for customer detection
                setTimeout(() => {
                    initializeCustomerDetection();
                }, 100);
                break;
            case 2:
                divContent.innerHTML = orderDetails;
                break;
            case 3:
                divContent.innerHTML = laundryItems;
                // Reattach event listeners for calculation
                setTimeout(() => {
                    if (document.getElementById('{{ order_item_form.quantity.id_for_label }}') &&
                        document.getElementById('{{ order_item_form.unit_price.id_for_label }}')) {
                        document.getElementById('{{ order_item_form.quantity.id_for_label }}').addEventListener('input', calculateTotal);
                        document.getElementById('{{ order_item_form.unit_price.id_for_label }}').addEventListener('input', calculateTotal);
                        calculateTotal();
                    }
                }, 100);
                break;
            case 4:
                divContent.innerHTML = paymentInfo;
                // Initialize payment method handler
                setTimeout(initializePaymentStep, 100);
                break;
        }
    }

    // Function to update step indicators
    function updateStepIndicators() {
        // Reset all indicators
        for (let i = 1; i <= totalSteps; i++) {
            const indicator = document.getElementById(`step-${i}-indicator`);
            if (i < currentStep) {
                // Completed steps
                indicator.className = 'w-12 h-12 bg-success-500 text-white rounded-full flex items-center justify-center font-bold text-lg';
                indicator.innerHTML = '<i class="fas fa-check"></i>';
            } else if (i === currentStep) {
                // Current step
                indicator.className = 'w-12 h-12 bg-primary-600 text-white rounded-full flex items-center justify-center font-bold text-lg';
                indicator.textContent = i;
            } else {
                // Upcoming steps
                indicator.className = 'w-12 h-12 bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-400 rounded-full flex items-center justify-center font-bold text-lg';
                indicator.textContent = i;
            }
        }
    }

    // Function to update navigation buttons
    function updateNavigationButtons() {
        // Previous button
        if (currentStep === 1) {
            prevButton.disabled = true;
        } else {
            prevButton.disabled = false;
        }

        // Next button
        if (currentStep === totalSteps) {
            nextButton.classList.add('hidden');
            finalActions.classList.remove('hidden');
        } else {
            nextButton.classList.remove('hidden');
            finalActions.classList.add('hidden');
        }
    }

    // Function to validate current step
    function validateStep(step) {
        let isValid = true;

        switch (step) {
            case 1:
                // Validate customer info
                const nameField = document.getElementById('{{ customer_form.name.id_for_label }}');
                const phoneField = document.getElementById('{{ customer_form.phone.id_for_label }}');

                if (!nameField.value.trim()) {
                    highlightError(nameField);
                    isValid = false;
                }

                if (!phoneField.value.trim()) {
                    highlightError(phoneField);
                    isValid = false;
                }
                break;

            case 2:
                // Validate order details
                const deliveryDateField = document.getElementById('{{ order_form.delivery_date.id_for_label }}');
                if (!deliveryDateField.value) {
                    highlightError(deliveryDateField);
                    isValid = false;
                }
                break;

            case 3:
                // Validate laundry items
                const quantityField = document.getElementById('{{ order_item_form.quantity.id_for_label }}');
                const unitPriceField = document.getElementById('{{ order_item_form.unit_price.id_for_label }}');
                const itemNameField = document.getElementById('{{ order_item_form.itemname.id_for_label }}');

                if (!quantityField.value || parseFloat(quantityField.value) <= 0) {
                    highlightError(quantityField);
                    isValid = false;
                }

                if (!unitPriceField.value || parseFloat(unitPriceField.value) <= 0) {
                    highlightError(unitPriceField);
                    isValid = false;
                }

                if (!itemNameField.value.trim()) {
                    highlightError(itemNameField);
                    isValid = false;
                }
                break;

            case 4:
                // Payment step is now optional - no validation required
                // But if payment method is selected, validate related fields
                const paymentMethod = document.getElementById('id_payment_method');
                if (paymentMethod && paymentMethod.value === 'mpesa') {
                    const phoneField = document.getElementById('id_phone_number');
                    if (!phoneField.value.trim()) {
                        highlightError(phoneField);
                        isValid = false;
                    }
                }
                break;
        }

        return isValid;
    }

    // Function to highlight field with error
    function highlightError(field) {
        field.classList.add('border-red-500');
        setTimeout(() => {
            field.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }

    // Function to submit step data
    function submitStepData() {
        return new Promise((resolve, reject) => {
            // Create a FormData object from the form
            const formData = new FormData(document.getElementById('laundryForm'));

            // Add a flag to indicate this is a step submission
            formData.append('step_submit', 'true');
            formData.append('current_step', currentStep);

            // Send AJAX request
            fetch('', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
                .then(response => {
                    // First check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json();
                    } else {
                        // If not JSON, it's probably HTML (error page)
                        throw new Error('Server returned HTML instead of JSON');
                    }
                })
                .then(data => {
                    resolve(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                    reject(error);
                });
        });
    }

    // Function to display form errors from server response
    function displayFormErrors(errors) {
        // Clear previous errors
        const errorElements = document.querySelectorAll('.field-error');
        errorElements.forEach(el => el.remove());

        // Remove error highlighting
        const errorFields = document.querySelectorAll('.border-red-500');
        errorFields.forEach(field => field.classList.remove('border-red-500'));

        // Add new errors
        for (const [fieldName, errorList] of Object.entries(errors)) {
            const fieldId = `id_${fieldName}`;
            const field = document.getElementById(fieldId);

            if (field) {
                field.classList.add('border-red-500');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'field-error text-red-600 text-sm mt-2 flex items-center';

                // Extract error messages
                const errorMessages = errorList.map(error => error.message).join(', ');
                errorDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> ${errorMessages}`;

                field.parentNode.appendChild(errorDiv);
            }
        }
    }

    // Calculate total price in real-time
    function calculateTotal() {
        const quantityField = document.getElementById('{{ order_item_form.quantity.id_for_label }}');
        const unitPriceField = document.getElementById('{{ order_item_form.unit_price.id_for_label }}');
        const totalElement = document.getElementById('totalPrice');

        if (quantityField && unitPriceField && totalElement) {
            const quantity = parseFloat(quantityField.value) || 0;
            const unitPrice = parseFloat(unitPriceField.value) || 0;
            const total = quantity * unitPrice;

            totalElement.textContent = `KSh ${total.toFixed(2)}`;

            // Remove animation when we have a valid total
            if (total > 0) {
                totalElement.classList.remove('animate-pulse');
                totalElement.classList.add('text-success-600', 'dark:text-green-400');
            } else {
                totalElement.classList.add('animate-pulse');
                totalElement.classList.remove('text-success-600', 'dark:text-green-400');
            }
        }
    }

    // Automatic customer detection
    function initializeCustomerDetection() {
        // Add phone blur listener for automatic customer detection
        const phoneField = document.getElementById('{{ customer_form.phone.id_for_label }}');
        const detectionStatus = document.getElementById('customerDetectionStatus');

        if (phoneField && detectionStatus) {
            phoneField.addEventListener('blur', function () {
                const phone = this.value.trim();
                if (phone.length > 5) {
                    checkCustomerExists(phone);
                }
            });

            // Also check on input with debounce
            let debounceTimer;
            phoneField.addEventListener('input', function () {
                clearTimeout(debounceTimer);
                const phone = this.value.trim();
                if (phone.length > 5) {
                    debounceTimer = setTimeout(() => {
                        checkCustomerExists(phone);
                    }, 800);
                }
            });
        }
    }

    // Function to check if customer exists by phone
    function checkCustomerExists(phone) {
        const detectionStatus = document.getElementById('customerDetectionStatus');
        const detectionText = document.getElementById('customerDetectionText');
        const phoneField = document.getElementById('{{ customer_form.phone.id_for_label }}');
        const nameField = document.getElementById('{{ customer_form.name.id_for_label }}');

        if (detectionStatus && detectionText) {
            detectionStatus.classList.remove('hidden');
            detectionText.textContent = 'Checking if customer exists...';
        }

        const formData = new FormData();
        formData.append('check_customer', 'true');
        formData.append('phone', phone);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch('/api/customer-details/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    if (nameField && (!nameField.value.trim())) {
                        nameField.value = data.name;
                    }
                    if (detectionStatus && detectionText) {
                        detectionText.innerHTML = `<span class="text-green-600">Existing customer found: <strong>${data.name}</strong></span>`;
                        setTimeout(() => {
                            detectionStatus.classList.add('hidden');
                        }, 3000);
                    }
                    showCustomerExistsMessage(data.name);
                } else {
                    if (detectionStatus && detectionText) {
                        detectionText.innerHTML = '<span class="text-yellow-600">New customer - please complete the information</span>';
                        setTimeout(() => {
                            detectionStatus.classList.add('hidden');
                        }, 3000);
                    }
                }
            })
            .catch(error => {
                console.error('Error checking customer:', error);
                if (detectionStatus) {
                    detectionStatus.classList.add('hidden');
                }
            });
    }

    // Initialize payment method handler
    function initializePaymentStep() {
        const paymentMethodSelect = document.getElementById('id_payment_method');
        if (paymentMethodSelect) {
            paymentMethodSelect.addEventListener('change', function () {
                handlePaymentMethodChange(this.value);
            });

            // Also add event listener for skip payment button
            const skipPaymentBtn = document.getElementById('skipPaymentBtn');
            if (skipPaymentBtn) {
                skipPaymentBtn.addEventListener('click', handleSkipPayment);
            }
        }
    }

    function handlePaymentMethodChange(paymentMethod) {
        const mpesaFields = document.getElementById('mpesaFields');
        const mpesaReceiptField = document.getElementById('mpesaReceiptField');

        if (paymentMethod === 'mpesa') {
            mpesaFields.style.display = 'block';
            mpesaReceiptField.style.display = 'block';
        } else {
            mpesaFields.style.display = 'none';
            mpesaReceiptField.style.display = 'none';
            // Clear M-Pesa fields when not selected
            document.getElementById('id_phone_number').value = '';
            document.getElementById('id_mpesa_receipt_number').value = '';
        }
    }

    function handleSkipPayment() {
        // Clear all payment fields
        document.getElementById('id_payment_method').value = '';
        document.getElementById('id_transaction_id').value = '';
        document.getElementById('id_phone_number').value = '';
        document.getElementById('id_mpesa_receipt_number').value = '';

        // Hide M-Pesa fields
        document.getElementById('mpesaFields').style.display = 'none';
        document.getElementById('mpesaReceiptField').style.display = 'none';

        // Show success message
        showSkipPaymentMessage();
    }

    function showSkipPaymentMessage() {
        // Create a temporary success message
        const messageDiv = document.createElement('div');
        messageDiv.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50 animate-fade-in';
        messageDiv.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span>Payment skipped. Order will be created without payment.</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-green-700 hover:text-green-900">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        document.body.appendChild(messageDiv);

        // Auto remove after 3 seconds
        setTimeout(() => {
            if (messageDiv.parentElement) {
                messageDiv.remove();
            }
        }, 3000);
    }

    // Add focus styles to form elements
    document.addEventListener('input', function (e) {
        if (e.target.classList.contains('form-input') ||
            e.target.classList.contains('form-select') ||
            e.target.classList.contains('form-textarea')) {
            e.target.parentElement.classList.add('ring-2', 'ring-primary-100', 'rounded-lg');
        }
    });

    document.addEventListener('blur', function (e) {
        if (e.target.classList.contains('form-input') ||
            e.target.classList.contains('form-select') ||
            e.target.classList.contains('form-textarea')) {
            e.target.parentElement.classList.remove('ring-2', 'ring-primary-100', 'rounded-lg');
        }
    }, true);

    // Add CSS animation for notifications
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fade-in 0.5s ease-out;
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}