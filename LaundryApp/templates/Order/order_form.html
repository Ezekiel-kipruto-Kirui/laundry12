{% extends "base.html" %}
{% load static %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Create Laundry Order</title>
    <link href="{% static 'css/dist/styles.css' %}" rel="stylesheet">
</head>

<body class="bg-gray-50 min-h-screen p-6">
<div
    class="max-w-4xl mx-auto bg-white/90 backdrop-blur-xl rounded-2xl shadow-lg p-4 sm:p-6 lg:p-8 border border-gray-100 mt-4 sm:mt-6 lg:mt-10">
    <!-- Progress Steps - Improved for mobile -->
    <div class="flex justify-center mb-6 sm:mb-8">
        <div class="flex items-center space-x-2 sm:space-x-4 max-w-full overflow-x-auto px-2 py-2">
            <!-- Step 1 -->
            <div class="flex items-center flex-shrink-0">
                <div id="step1-indicator"
                    class="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-semibold text-xs sm:text-sm">
                    1</div>
                <span class="ml-1 sm:ml-2 text-xs sm:text-sm font-medium text-blue-600 hidden xs:inline">Customer</span>
            </div>
            <div class="w-6 sm:w-8 h-1 bg-gray-300 flex-shrink-0"></div>

            <!-- Step 2 -->
            <div class="flex items-center flex-shrink-0">
                <div id="step2-indicator"
                    class="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold text-xs sm:text-sm">
                    2</div>
                <span class="ml-1 sm:ml-2 text-xs sm:text-sm font-medium text-gray-500 hidden xs:inline">Order
                    Details</span>
            </div>
            <div class="w-6 sm:w-8 h-1 bg-gray-300 flex-shrink-0"></div>

            <!-- Step 3 -->
            <div class="flex items-center flex-shrink-0">
                <div id="step3-indicator"
                    class="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold text-xs sm:text-sm">
                    3</div>
                <span class="ml-1 sm:ml-2 text-xs sm:text-sm font-medium text-gray-500 hidden xs:inline">Items</span>
            </div>
            <div class="w-6 sm:w-8 h-1 bg-gray-300 flex-shrink-0"></div>

            <!-- Step 4 -->
            <div class="flex items-center flex-shrink-0">
                <div id="step4-indicator"
                    class="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold text-xs sm:text-sm">
                    4</div>
                <span class="ml-1 sm:ml-2 text-xs sm:text-sm font-medium text-gray-500 hidden xs:inline">Payment</span>
            </div>
        </div>
    </div>

    <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-800 mb-4 sm:mb-6 text-center">Customer Information
    </h1>

    <!-- Step 1: Customer -->
    <div id="step-customer" class="">
        <form id="customerForm" class="space-y-4 sm:space-y-5 p-2 sm:p-4">
            {% csrf_token %}
            <div>
                <label class="block text-sm font-medium text-gray-700">Customer Name</label>
                <input id="name" name="name" type="text"
                    class="mt-1 sm:mt-2 w-full rounded-lg border border-gray-300 bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200 p-2 sm:p-3 transition duration-150 text-sm sm:text-base" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                <input id="phone" name="phone" type="text" required
                    class="mt-1 sm:mt-2 w-full rounded-lg border border-gray-300 bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200 p-2 sm:p-3 transition duration-150 text-sm sm:text-base" />
            </div>
            <div class="flex justify-end mt-4 sm:mt-6">
                <button id="customerNext" type="submit"
                    class="w-full sm:w-auto px-4 sm:px-6 py-2.5 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 hover:shadow transition duration-200 text-sm sm:text-base">
                    Next →
                </button>
            </div>
        </form>
    </div>

    <!-- Step 2: Order Details -->
    <div id="step-order-details" class="hidden">
        <h2 class="text-lg font-semibold text-gray-700 mb-3">Order Details</h2>

        <form id="orderDetailsForm" class="space-y-4 sm:space-y-6 p-2 sm:p-4">
            {% csrf_token %}
            <input type="hidden" id="customer_id" name="customer_id" />

            <div class="grid grid-cols-1 gap-4 sm:gap-6">
                {% if not active_shop_name %}
                <div class="activeshop">
                    <label class="block text-sm font-medium text-gray-700">Shop</label>
                    <select id="shop" name="shop" required
                        class="mt-1 sm:mt-2 w-full rounded-lg border border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 p-2 sm:p-3 text-sm sm:text-base">
                        <option value="">-- Select Shop --</option>
                        <option value="Shop A">Shop A</option>
                        <option value="Shop B">Shop B</option>
                    </select>
                </div>
                {% else %}
                <input type="hidden" id="shop" name="shop" value="{{ active_shop_name }}">
                {% endif %}

                <div>
                    <label class="block text-sm font-medium text-gray-700">Delivery/Picked Date</label>
                    <input id="delivery_date" name="delivery_date" type="date" required
                        class="mt-1 sm:mt-2 w-full rounded-lg border border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 p-2 sm:p-3 text-sm sm:text-base" />
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Delivery/Pick Address</label>
                <textarea id="addressdetails" name="addressdetails" rows="2"
                    class="mt-1 sm:mt-2 w-full rounded-lg border border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 p-2 sm:p-3 text-sm sm:text-base"></textarea>
            </div>

            <div class="flex flex-col sm:flex-row justify-between gap-3 mt-4 sm:mt-6">
                <button type="button" id="backToCustomer"
                    class="order-2 sm:order-1 px-4 sm:px-6 py-2.5 rounded-lg bg-gray-300 text-gray-700 font-medium hover:bg-gray-400 transition duration-200 text-sm sm:text-base">
                    ← Back
                </button>
                <button type="submit" id="orderDetailsNext"
                    class="order-1 sm:order-2 px-4 sm:px-6 py-2.5 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 hover:shadow transition duration-200 text-sm sm:text-base">
                    Next →
                </button>
            </div>
        </form>
    </div>

    <!-- Step 3: Items -->
    <div id="step-items" class="hidden">
        <h2 class="text-lg font-semibold text-gray-700 mb-3">Order Items</h2>

        <div class="space-y-4 sm:space-y-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-2">
                <h3 class="text-md font-semibold text-gray-700">Add Items to Order</h3>
                <button id="addItemBtn" type="button"
                    class="w-full sm:w-auto text-sm bg-green-600 hover:bg-green-700 text-white px-3 py-2 sm:py-1.5 rounded-md shadow-sm transition duration-150">
                    + Add Item
                </button>
            </div>
            <div id="itemsContainer" class="space-y-3 sm:space-y-4 p-2 sm:p-4"></div>

            <div class="flex flex-col sm:flex-row justify-between gap-3 mt-4 sm:mt-6">
                <button type="button" id="backToOrderDetails"
                    class="order-2 sm:order-1 px-4 sm:px-6 py-2.5 rounded-lg bg-gray-300 text-gray-700 font-medium hover:bg-gray-400 transition duration-200 text-sm sm:text-base">
                    ← Back
                </button>
                <button type="button" id="itemsNext"
                    class="order-1 sm:order-2 px-4 sm:px-6 py-2.5 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 hover:shadow transition duration-200 text-sm sm:text-base">
                    Next →
                </button>
            </div>
        </div>
    </div>

    <!-- Step 4: Payment -->
    <div id="step-payment" class="hidden">
        <h2 class="text-lg font-semibold text-gray-700 mb-3">Payment Information</h2>

        <form id="paymentForm" class="space-y-4 sm:space-y-6 p-2 sm:p-4">
            {% csrf_token %}

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Payment Type</label>
                    <select id="payment_type" name="payment_type" required
                        class="mt-1 sm:mt-2 w-full rounded-lg border border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 p-2 sm:p-3 text-sm sm:text-base">
                        <option value="">-- Select Payment Type --</option>
                        <option value="cash">Cash</option>
                        <option value="mpesa">M-Pesa</option>
                        <option value="card">Credit/Debit Card</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="other">Other</option>
                        <option value="None">None</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Amount Paid</label>
                    <input id="amount_paid" name="amount_paid" type="number" step="0.01" min="0" value="0"
                        class="mt-1 sm:mt-2 w-full rounded-lg border border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 p-2 sm:p-3 text-sm sm:text-base" />
                </div>
            </div>

            <!-- Totals -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mt-4 sm:mt-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Total Price</label>
                    <input id="total_price" name="total_price" readonly
                        class="mt-1 sm:mt-2 w-full rounded-lg border border-gray-200 bg-gray-100 p-2 sm:p-3 text-gray-700 font-semibold text-sm sm:text-base" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Balance</label>
                    <input id="balance" name="balance" readonly
                        class="mt-1 sm:mt-2 w-full rounded-lg border border-gray-200 bg-gray-100 p-2 sm:p-3 text-gray-700 font-semibold text-sm sm:text-base" />
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-between gap-3 mt-4 sm:mt-6">
                <button type="button" id="backToItems"
                    class="order-2 sm:order-1 px-4 sm:px-6 py-2.5 rounded-lg bg-gray-300 text-gray-700 font-medium hover:bg-gray-400 transition duration-200 text-sm sm:text-base">
                    ← Back
                </button>
                <button type="submit" id="submitOrderBtn"
                    class="order-1 sm:order-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 sm:px-6 py-2.5 rounded-lg font-medium shadow transition duration-200 text-sm sm:text-base">
                    Create Order
                </button>
            </div>
        </form>
    </div>

    <!-- Modal: existing customer found -->
    <div id="customerModal"
        class="fixed inset-0 hidden bg-black/40 backdrop-blur-sm items-center justify-center transition-all duration-200 p-4">
        <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 w-full max-w-md mx-auto">
            <div>
                <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3">Customer Found</h3>
                <p class="text-sm text-gray-600 mb-4">A customer with this phone already exists. Select to use existing
                    or create new.</p>

                <div id="foundCustomerInfo" class="space-y-1 text-sm text-gray-800 border rounded-lg p-3 bg-gray-50">
                </div>
            </div>

            <div class="p-4 grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
                <button id="useExistingBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition text-sm sm:text-base">
                    Use This Customer
                </button>
                <button id="createNewBtn"
                    class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-md transition text-sm sm:text-base">
                    Create New
                </button>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div id="toast"
        class="fixed bottom-4 left-4 right-4 sm:bottom-6 sm:right-6 sm:left-auto hidden bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg text-sm max-w-xs sm:max-w-sm mx-auto sm:mx-0">
    </div>
</div>

<style>
    /* Custom breakpoint for extra small screens */
    @media (min-width: 475px) {
        .xs\:inline {
            display: inline !important;
        }
    }
</style>

    <script>
        // CSRF helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // UI helpers
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        function updateProgressSteps(currentStep) {
            const steps = [1, 2, 3, 4];
            steps.forEach(step => {
                const indicator = document.getElementById(`step${step}-indicator`);
                const isCompleted = step < currentStep;
                const isCurrent = step === currentStep;

                if (isCompleted) {
                    indicator.className = 'w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-semibold';
                    indicator.textContent = '✓';
                } else if (isCurrent) {
                    indicator.className = 'w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-semibold';
                    indicator.textContent = step;
                } else {
                    indicator.className = 'w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold';
                    indicator.textContent = step;
                }
            });
        }

        function showStep(stepNumber) {
            document.getElementById('step-customer').classList.add('hidden');
            document.getElementById('step-order-details').classList.add('hidden');
            document.getElementById('step-items').classList.add('hidden');
            document.getElementById('step-payment').classList.add('hidden');

            switch (stepNumber) {
                case 1:
                    document.getElementById('step-customer').classList.remove('hidden');
                    break;
                case 2:
                    document.getElementById('step-order-details').classList.remove('hidden');
                    break;
                case 3:
                    document.getElementById('step-items').classList.remove('hidden');
                    break;
                case 4:
                    document.getElementById('step-payment').classList.remove('hidden');
                    break;
            }
            updateProgressSteps(stepNumber);
        }

        // Elements
        const customerForm = document.getElementById('customerForm');
        const orderDetailsForm = document.getElementById('orderDetailsForm');
        const paymentForm = document.getElementById('paymentForm');
        const customerModal = document.getElementById('customerModal');
        const foundCustomerInfo = document.getElementById('foundCustomerInfo');
        const useExistingBtn = document.getElementById('useExistingBtn');
        const createNewBtn = document.getElementById('createNewBtn');
        const customerIdInput = document.getElementById('customer_id');

        let lastFoundCustomer = null;

        // Step navigation
        document.getElementById('backToCustomer').addEventListener('click', () => showStep(1));
        document.getElementById('backToOrderDetails').addEventListener('click', () => showStep(2));
        document.getElementById('backToItems').addEventListener('click', () => showStep(3));

        // Customer form submission
        customerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const rawphone = document.getElementById('phone').value.trim();
            const name = document.getElementById('name').value.trim();
            

            let phone = rawphone;
            if (!rawphone) {
                showToast('Phone is required');
                return;
            }

            if (rawphone.startsWith('+254')) {
                phone = rawphone;
            } else if (rawphone.startsWith('0')) {
                phone = '+254' + rawphone.substring(1);
            } else if (rawphone.startsWith('7')) {
                phone = '+254' + rawphone;
            } else {
                phone = rawphone;
            }

            try {
                const resp = await fetch('/Laundry/api/customer/check-or-create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ phone, name})
                });

                const data = await resp.json();

                if (!resp.ok) {
                    showToast(Object.values(data).flat().join(' ') || 'Error checking customer');
                    return;
                }

                if (data.exists === true) {
                    lastFoundCustomer = data.customer;
                    foundCustomerInfo.innerHTML = `
                        <div><strong>${data.customer.name}</strong></div>
                        <div>${data.customer.phone}</div>
                       
                    `;
                    customerModal.classList.remove('hidden');
                    customerModal.classList.add('flex');
                } else {
                    lastFoundCustomer = data.customer;
                    customerIdInput.value = data.customer.id;
                    showToast('New customer created');
                    showStep(2);
                }
            } catch (err) {
                console.error(err);
                showToast('Network error');
            }
        });

        useExistingBtn.addEventListener('click', () => {
            if (!lastFoundCustomer) return;
            customerIdInput.value = lastFoundCustomer.id;
            customerModal.classList.add('hidden');
            customerModal.classList.remove('flex');
            showStep(2);
            showToast('Using existing customer');
        });

        createNewBtn.addEventListener('click', () => {
            customerModal.classList.add('hidden');
            customerModal.classList.remove('flex');
            showToast('To create a new customer, change the phone number.');
        });

        // Order details form submission
        orderDetailsForm.addEventListener('submit', (e) => {
            e.preventDefault();

            // Get shop value based on user type
            let shop;
            '{% if not active_shop_name %}'
            shop = document.getElementById('shop').value;
            '{% else %}'
            shop = "{{ active_shop_name }}";
            '{% endif %}'

            const delivery_date = document.getElementById('delivery_date').value;

            if (!shop || !delivery_date) {
                showToast('Please fill all required fields');
                return;
            }

            showStep(3);
        });

        // Items step navigation
        document.getElementById('itemsNext').addEventListener('click', () => {
            const itemRows = itemsContainer.querySelectorAll('.item-row');
            if (itemRows.length === 0) {
                showToast('Please add at least one item');
                return;
            }

            // Validate items
            let valid = true;
            itemRows.forEach(row => {
                const selectedServices = Array.from(row.querySelectorAll('.service-checkbox:checked'));
                if (selectedServices.length === 0) {
                    valid = false;
                    showToast('Select at least one service type for each item');
                }
            });

            if (valid) {
                showStep(4);
            }
        });

        // --- Order items dynamic logic ---
        const addItemBtn = document.getElementById('addItemBtn');
        const itemsContainer = document.getElementById('itemsContainer');
        const totalPriceInput = document.getElementById('total_price');
        const balanceInput = document.getElementById('balance');
        const amountPaidInput = document.getElementById('amount_paid');

        function computeTotals() {
            let total = 0;
            const itemRows = itemsContainer.querySelectorAll('.item-row');
            itemRows.forEach(row => {
                const qty = parseFloat(row.querySelector('.item-quantity').value) || 0;
                let unit = parseFloat(row.querySelector('.item-unit_price').value) || 0;
                const lineTotal = unit;
                row.querySelector('.item-line-total').textContent = lineTotal.toFixed(2);
                total += lineTotal;
            });
            totalPriceInput.value = total.toFixed(2);
            const paid = parseFloat(amountPaidInput.value) || 0;
            const balance = Math.max(0, total - paid);
            balanceInput.value = balance.toFixed(2);
        }

        function createItemRow() {
            const serviceOptions = [
                { value: 'Washing', label: 'Washing' },
                { value: 'Folding', label: 'Folding' },
                { value: 'Ironing', label: 'Ironing' },
                { value: 'Dry cleaning', label: 'Dry cleaning' }
            ];

            const itemTypeOptions = ['Clothing', 'Bedding', 'Household items', 'Footwares'];
            const itemConditionOptions = ['New', 'Old', 'Torn'];

            const wrapper = document.createElement('div');
            wrapper.className = 'item-row border rounded p-3 bg-gray-50';

            wrapper.innerHTML = `
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm mb-2">Service Type</label>
                        <div class="service-dropdown relative">
                            <button type="button" class="service-dropdown-btn w-full text-left p-2 border rounded bg-white flex justify-between items-center">
                                <span class="service-selected-text">Select services...</span>
                                <span>▼</span>
                            </button>
                            <div class="service-checkbox-container absolute z-10 w-full mt-1 bg-white border rounded shadow-lg hidden max-h-48 overflow-y-auto">
                                ${serviceOptions.map(service => `
                                    <label class="flex items-center p-2 hover:bg-gray-100 cursor-pointer">
                                        <input type="checkbox" value="${service.value}" class="service-checkbox mr-2">
                                        <span>${service.label}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm">Item Category</label>
                        <select class="mt-1 block w-full p-2 border rounded item-itemtype">
                            <option value="">--Select--</option>
                            ${itemTypeOptions.map(it => `<option value="${it}">${it}</option>`).join('')}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm">Condition</label>
                        <select class="mt-1 block w-full p-2 border rounded item-itemcondition">
                            <option value="">--Select--</option>
                            ${itemConditionOptions.map(ic => `<option value="${ic}">${ic}</option>`).join('')}
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3 mt-3">
                    <div>
                        <label class="block text-sm">Item name(s) (comma-separated)</label>
                        <input class="mt-1 block w-full p-2 border rounded item-itemname" />
                    </div>
                    <div>
                        <label class="block text-sm">Quantity</label>
                        <input type="number" min="1" value="1" class="mt-1 block w-full p-2 border rounded item-quantity" />
                    </div>
                    <div>
                        <label class="block text-sm">Unit price</label>
                        <input type="number" step="0.01" min="0" value="0" class="mt-1 block w-full p-2 border rounded item-unit_price" />
                    </div>
                </div>

                <div class="flex items-center justify-between mt-3">
                    <div class="text-sm">Line total: <span class="item-line-total">0.00</span></div>
                    <div class="flex gap-2">
                        <button type="button" class="removeItemBtn bg-red-500 text-white px-2 py-1 rounded text-sm">Remove</button>
                    </div>
                </div>
            `;

            // Service dropdown functionality
            const dropdownBtn = wrapper.querySelector('.service-dropdown-btn');
            const checkboxContainer = wrapper.querySelector('.service-checkbox-container');
            const selectedText = wrapper.querySelector('.service-selected-text');
            const checkboxes = wrapper.querySelectorAll('.service-checkbox');

            dropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                checkboxContainer.classList.toggle('hidden');
            });

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const selected = Array.from(checkboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                    if (selected.length === 0) {
                        selectedText.textContent = 'Select services...';
                    } else {
                        selectedText.textContent = selected.join(', ');
                    }
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
                checkboxContainer.classList.add('hidden');
            });

            checkboxContainer.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // Quantity and price listeners
            wrapper.querySelectorAll('.item-quantity, .item-unit_price').forEach(el => {
                el.addEventListener('input', computeTotals);
            });

            wrapper.querySelector('.removeItemBtn').addEventListener('click', () => {
                wrapper.remove();
                computeTotals();
            });

            itemsContainer.appendChild(wrapper);
            computeTotals();
        }

        addItemBtn.addEventListener('click', () => createItemRow());
        createItemRow(); // start with one item
        amountPaidInput.addEventListener('input', computeTotals);

        // Final order submission
        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const customerId = customerIdInput.value;
            if (!customerId) {
                showToast('No customer selected');
                return;
            }

            // Get shop value based on user type
            let shop;
            '{% if not active_shop_name %}'
            shop = document.getElementById('shop').value;
            '{% else %}'
            shop = "{{ active_shop_name }}";
            '{% endif %}'

            const payment_type = document.getElementById('payment_type').value;
            const delivery_date = document.getElementById('delivery_date').value;
            const addressdetails = document.getElementById('addressdetails').value;
            const amount_paid = parseFloat(document.getElementById('amount_paid').value) || 0;
            const total_price = parseFloat(document.getElementById('total_price').value) || 0;

            if (!shop || !payment_type || !delivery_date) {
                showToast('Fill required order fields');
                return;
            }

            // Collect items
            const items = [];
            const itemRows = itemsContainer.querySelectorAll('.item-row');
            for (const row of itemRows) {
                const selectedServices = Array.from(row.querySelectorAll('.service-checkbox:checked')).map(cb => cb.value);
                const itemtype = row.querySelector('.item-itemtype').value;
                const itemname = row.querySelector('.item-itemname').value;
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 1;
                const itemcondition = row.querySelector('.item-itemcondition').value;
                let unit_price = parseFloat(row.querySelector('.item-unit_price').value) || 0;
                const total_item_price = (unit_price).toFixed(2);

                if (!selectedServices.length) {
                    showToast('Select at least one service type for each item');
                    return;
                }
                if (!itemtype) {
                    showToast('Select item category for each item');
                    return;
                }
                if (!itemcondition) {
                    showToast('Select item condition for each item');
                    return;
                }
                if (!itemname) {
                    showToast('Provide item name(s)');
                    return;
                }

                items.push({
                    servicetype: selectedServices,
                    itemtype,
                    itemname,
                    quantity,
                    itemcondition,
                    additional_info: null,
                    unit_price,
                    total_item_price
                });
            }

            const payload = {
                customer: customerId,
                payment_type,
                shop,
                delivery_date,
                addressdetails,
                amount_paid,
                total_price,
                items
            };

            console.log('Submitting payload:', payload); // Debug log

            try {
                const resp = await fetch('/Laundry/api/orders/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(payload)
                });

                const data = await resp.json();
                console.log('Response:', data); // Debug log

                if (resp.ok) {
                    showToast('Order created successfully');
                    setTimeout(() => {
                        window.location.href = "{% url 'laundry:customordertable' %}"; // Redirect to orders list
                    }, 1000);
                } else {
                    console.error('Error response:', data);
                    let errMsg = 'Order creation failed';
                    if (typeof data === 'object') {
                        if (data.errors) {
                            errMsg = Object.entries(data.errors).map(([k, v]) => `${k}: ${v}`).join(' | ');
                        } else if (data.non_field_errors) {
                            errMsg = data.non_field_errors.join(' | ');
                        } else if (data.detail) {
                            errMsg = data.detail;
                        } else {
                            errMsg = JSON.stringify(data);
                        }
                    } else if (data && data.message) {
                        errMsg = data.message;
                    }
                    showToast(errMsg);
                }
            } catch (err) {
                console.error('Network error:', err);
                showToast('Network error when creating order: ' + err.message);
            }
        });

        // Initialize first step
        showStep(1);
    </script>
</body>

</html>
{% endblock %}