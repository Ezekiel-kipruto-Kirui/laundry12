{% extends '../home.html' %}

{% block content %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laundry Orders Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .compact-table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
        }

        .compact-table th {
            background-color: #f8fafc;
            padding: 12px 8px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            color: #64748b;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .compact-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
            font-size: 0.8rem;
            white-space: nowrap;
            text-align: center;
        }

        .item-pill {
            display: inline-block;
            background-color: #f1f5f9;
            border-radius: 4px;
            padding: 4px 8px;
            margin: 2px 0;
            font-size: 0.7rem;
            color: #475569;
            white-space: nowrap;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 8px 0;
            z-index: 20;
            min-width: 160px;
        }

        .dropdown:hover .dropdown-menu {
            display: block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e91e63, #d81b60);
            box-shadow: 0 4px 6px -1px rgba(233, 30, 99, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(233, 30, 99, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(14, 165, 233, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .stat-card {
            background: linear-gradient(to bottom, #ffffff, #fafafa);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(229, 231, 235, 0.8);
            transition: all 0.3s ease;
            border-left: 4px solid;
        }

        .stat-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
            transform: translateY(-2px);
        }

        .filter-pill {
            transition: all 0.2s;
        }

        .filter-pill:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .action-btn {
            padding: 6px;
            border-radius: 6px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            transform: translateY(-1px);
        }

        .view-btn:hover {
            background-color: #dbeafe;
            color: #1d4ed8;
        }

        .edit-btn:hover {
            background-color: #dcfce7;
            color: #16a34a;
        }

        .delete-btn:hover {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .status-updating {
            opacity: 0.6;
            pointer-events: none;
        }

        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .bulk-actions-container {
            display: none;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }

        .bulk-actions-container.show {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 20px 24px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 0 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            background-color: white;
            transition: all 0.2s;
        }

        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .items-container {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
        }

        .item-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            align-items: end;
        }

        .item-row:last-child {
            border-bottom: none;
        }

        .remove-item {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background 0.2s;
        }

        .remove-item:hover {
            background: #dc2626;
        }

        .add-item {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .add-item:hover {
            background: #059669;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-50 font-inter">
    <div class="max-w-full mx-auto p-4 lg:p-6">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
            <div>
                <div class="flex items-center gap-3 mb-3">
                    <a href="{% url 'laundry:Laundrydashboard' %}"
                        class="inline-flex items-center px-4 py-2 bg-white rounded-lg shadow-sm border border-gray-200 text-gray-700 hover:text-blue-600 hover:shadow-md transition-all duration-200">
                        <i class="fas fa-home mr-2"></i>
                        <span class="text-sm font-medium">Dashboard Home</span>
                    </a>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">Orders Management</h1>
                <p class="text-gray-600 mt-1">Manage and track all laundry orders</p>
            </div>
            <div class="flex flex-wrap gap-3">
                <!-- Export Button -->
                <div class="dropdown relative">
                    <button
                        class="btn-secondary inline-flex items-center gap-2 px-4 py-2.5 text-white rounded-lg font-medium">
                        <i class="fas fa-download"></i>
                        <span>Export</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div class="dropdown-menu mt-1 right-0">
                        <a class="flex items-center gap-2 px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors duration-150 export-btn"
                            href="#" data-format="csv">
                            <i class="fas fa-file-csv text-green-600"></i> CSV Format
                        </a>
                        <a class="flex items-center gap-2 px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors duration-150 export-btn"
                            href="#" data-format="xlsx">
                            <i class="fas fa-file-excel text-green-600"></i> Excel Format
                        </a>
                    </div>
                </div>

                <a href="{% url 'laundry:createorder' %}"
                    class="btn-primary inline-flex items-center gap-2 px-4 py-2.5 text-white rounded-lg font-medium">
                    <i class="fas fa-plus-circle"></i>
                    <span>New Order</span>
                </a>
            </div>
        </div>

        <!-- Bulk Actions Container -->
        <div id="bulkActionsContainer" class="bulk-actions-container">
            <span id="selectedCount" class="text-sm font-medium text-gray-700">0 orders selected</span>
            <button id="bulkCompleteBtn"
                class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600 transition-colors">
                <i class="fas fa-check-circle mr-2"></i>Mark Selected as Completed
            </button>
            <button id="bulkDeliverBtn"
                class="px-4 py-2 bg-purple-500 text-white rounded-lg text-sm font-medium hover:bg-purple-600 transition-colors">
                <i class="fas fa-truck mr-2"></i>Mark Selected as Delivered
            </button>
            <button id="clearSelectionBtn"
                class="px-4 py-2 bg-gray-500 text-white rounded-lg text-sm font-medium hover:bg-gray-600 transition-colors">
                <i class="fas fa-times mr-2"></i>Clear Selection
            </button>
        </div>

        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6" id="statsContainer">
            <div class="stat-card p-5 border-l-blue-500">
                <div class="flex flex-col items-center text-center w-full">
                    <div class="p-3 bg-blue-100 rounded-xl mb-3">
                        <i class="fas fa-clipboard-check text-blue-600 text-xl"></i>
                    </div>
                    <p class="text-sm text-gray-500 font-medium">Active Orders</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-1" id="totalOrders">0</h3>
                    <p class="text-xs text-gray-500 mt-2">Excluding delivered orders</p>
                </div>
            </div>

            <div class="stat-card p-5 border-l-amber-500">
                <div class="flex flex-col items-center text-center w-full">
                    <div class="p-3 bg-amber-100 rounded-xl mb-3">
                        <i class="fas fa-clock text-amber-600 text-xl"></i>
                    </div>
                    <p class="text-sm text-gray-500 font-medium">Pending Orders</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-1" id="pendingOrders">0</h3>
                    <p class="text-xs text-gray-500 mt-2">Require attention</p>
                </div>
            </div>

            <div class="stat-card p-5 border-l-green-500">
                <div class="flex flex-col items-center text-center w-full">
                    <div class="p-3 bg-green-100 rounded-xl mb-3">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                    <p class="text-sm text-gray-500 font-medium">Completed</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-1" id="completedOrders">0</h3>
                    <p class="text-xs text-gray-500 mt-2">Ready for delivery</p>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 mb-6">
            <form id="filterForm"
                class="flex flex-col md:flex-row justify-between w-full items-start md:items-center gap-4">
                <div class="flex flex-wrap gap-3">
                    <!-- All Orders Filter -->
                    <button type="button" data-payment=""
                        class="filter-pill px-4 py-2 bg-blue-100 text-blue-700 shadow-sm rounded-lg text-sm font-medium flex items-center active-filter">
                        Active Orders
                    </button>

                    <!-- Payment Status Filters -->
                    <div class="flex flex-wrap items-center gap-2">
                        <span class="text-sm text-gray-500 font-medium">Payment:</span>
                        {% for payment_value, payment_label in payment_status_choices %}
                        <button type="button" data-payment="{{ payment_value }}"
                            class="filter-pill px-3 py-1.5 bg-gray-100 text-gray-700 rounded-full text-sm font-medium payment-filter">
                            {{ payment_label }}
                        </button>
                        {% endfor %}
                    </div>

                    <!-- Action Filters -->
                    <div class="flex flex-wrap items-center gap-2">
                        <span class="text-sm text-gray-500 font-medium">Actions:</span>
                        <button type="button" data-action="mark-completed"
                            class="filter-pill px-3 py-1.5 bg-green-100 text-green-700 rounded-full text-sm font-medium action-filter">
                            <i class="fas fa-check-circle mr-1"></i> Mark Completed
                        </button>
                        <button type="button" data-action="mark-delivered"
                            class="filter-pill px-3 py-1.5 bg-purple-100 text-purple-700 rounded-full text-sm font-medium action-filter">
                            <i class="fas fa-truck mr-1"></i> Mark Delivered
                        </button>
                    </div>
                </div>
                <div class="relative w-full md:w-auto">
                    <input type="text" name="search" id="searchInput" placeholder="Search orders..."
                        class="pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg w-full md:w-64 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-all duration-200">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </form>
        </div>

        <!-- Orders Table -->
        <div class="bg-white rounded-xl overflow-hidden shadow-lg">
            <div class="overflow-x-auto">
                <table class="compact-table w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="checkbox-cell">
                                <input type="checkbox" id="selectAllCheckbox"
                                    class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            </th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 text-xs">Order Code</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 text-xs">Customer</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 text-xs">Address</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 text-xs">Service</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 text-xs">Item Type</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 text-xs">Items</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 text-xs">Condition</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 text-xs">Amount Paid</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 text-xs">Balance</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 text-xs">Total Billed</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 text-xs">Order Status</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 text-xs">Payment Status</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 text-xs">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <!-- Orders will be loaded here via AJAX -->
                    </tbody>
                </table>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="loading-spinner">
                <div class="inline-flex items-center">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-500 mr-3"></i>
                    <span class="text-gray-600">Loading orders...</span>
                </div>
            </div>

            <!-- Pagination -->
            <div id="paginationContainer" class="px-6 py-4 border-t border-gray-200">
                <!-- Pagination will be loaded here via AJAX -->
            </div>
        </div>
    </div>

    <!-- Update Order Modal -->
    <div id="updateOrderModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-900">Update Order</h2>
                <button type="button" id="closeModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="updateOrderForm">
                <div class="modal-body">
                    <input type="hidden" id="updateOrderId" name="order_id">
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

                    <!-- Customer Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="form-group">
                            <label class="form-label" for="updateCustomerName">Customer Name</label>
                            <input type="text" id="updateCustomerName" name="name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="updateCustomerPhone">Phone Number</label>
                            <input type="text" id="updateCustomerPhone" name="phone" class="form-input" required>
                        </div>
                    </div>

                    <!-- Order Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="form-group">
                            <label class="form-label" for="updateOrderStatus">Order Status</label>
                            <select id="updateOrderStatus" name="order_status" class="form-select">
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="Completed">Completed</option>
                                <option value="Delivered_picked">Delivered</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="updatePaymentStatus">Payment Status</label>
                            <select id="updatePaymentStatus" name="payment_status" class="form-select">
                                <option value="pending">Pending</option>
                                <option value="partial">Partial</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Payment Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="form-group">
                            <label class="form-label" for="updateAmountPaid">Amount Paid</label>
                            <input type="number" id="updateAmountPaid" name="amount_paid" class="form-input" step="0.01"
                                min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="updateTotalPrice">Total Price</label>
                            <input type="number" id="updateTotalPrice" name="total_price" class="form-input" step="0.01"
                                min="0" readonly>
                        </div>
                    </div>

                    <!-- Order Items -->
                    <div class="form-group">
                        <label class="form-label">Order Items</label>
                        <div id="updateItemsContainer" class="items-container">
                            <!-- Items will be dynamically added here -->
                        </div>
                        <button type="button" id="addItemBtn" class="add-item mt-3">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="cancelUpdate"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Update Order
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        class OrderManager {
            constructor() {
                this.currentPage = 1;
                this.currentFilters = {
                    payment_status: '',
                    search: ''
                };
                this.selectedOrders = new Set();
                this.init();
            }

            init() {
                this.bindEvents();
                this.loadOrders();
                this.startAutoRefresh();
            }

            bindEvents() {
                // Search input with debounce
                let searchTimeout;
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        this.currentFilters.search = e.target.value;
                        this.currentPage = 1;
                        this.loadOrders();
                    }, 500);
                });

                // Payment filters
                document.querySelectorAll('.payment-filter').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const paymentStatus = e.target.getAttribute('data-payment');
                        this.currentFilters.payment_status = paymentStatus;
                        this.currentPage = 1;
                        this.updateActiveFilters();
                        this.loadOrders();
                    });
                });

                // Action filters
                document.querySelectorAll('.action-filter').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const action = e.target.getAttribute('data-action');
                        this.handleBulkAction(action);
                    });
                });

                // Active orders filter
                document.querySelector('[data-payment=""]').addEventListener('click', () => {
                    this.currentFilters.payment_status = '';
                    this.currentPage = 1;
                    this.updateActiveFilters();
                    this.loadOrders();
                });

                // Export buttons
                document.querySelectorAll('.export-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const format = e.target.getAttribute('data-format');
                        this.exportOrders(format);
                    });
                });

                // Bulk action buttons
                document.getElementById('bulkCompleteBtn').addEventListener('click', () => {
                    this.bulkUpdateStatus('Completed');
                });

                document.getElementById('bulkDeliverBtn').addEventListener('click', () => {
                    this.bulkUpdateStatus('Delivered_picked');
                });

                document.getElementById('clearSelectionBtn').addEventListener('click', () => {
                    this.clearSelection();
                });

                // Select all checkbox
                document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
                    this.toggleSelectAll(e.target.checked);
                });

                // Modal events
                document.getElementById('closeModal').addEventListener('click', () => {
                    this.closeModal();
                });

                document.getElementById('cancelUpdate').addEventListener('click', () => {
                    this.closeModal();
                });

                document.getElementById('updateOrderForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitUpdateForm();
                });

                document.getElementById('addItemBtn').addEventListener('click', () => {
                    this.addItemRow();
                });

                // Close modal when clicking outside
                document.getElementById('updateOrderModal').addEventListener('click', (e) => {
                    if (e.target.id === 'updateOrderModal') {
                        this.closeModal();
                    }
                });

                // Delegate events for dynamically loaded content
                document.addEventListener('click', (e) => {
                    // Individual order checkboxes
                    if (e.target.matches('.order-checkbox')) {
                        this.handleOrderSelection(e.target);
                    }

                    // Edit order buttons
                    if (e.target.closest('.edit-order-btn')) {
                        const button = e.target.closest('.edit-order-btn');
                        const orderId = button.getAttribute('data-order-id');
                        this.openEditModal(orderId);
                    }

                    // Update status buttons
                    if (e.target.closest('.update-status-btn')) {
                        const button = e.target.closest('.update-status-btn');
                        const orderRow = button.closest('tr[data-order-id]');
                        const orderId = orderRow.getAttribute('data-order-id');
                        const status = button.getAttribute('data-status');
                        this.updateSingleOrderStatus(orderId, status);
                    }

                    // Remove item buttons
                    if (e.target.closest('.remove-item')) {
                        const button = e.target.closest('.remove-item');
                        button.closest('.item-row').remove();
                    }

                    // Pagination buttons
                    if (e.target.closest('.pagination-btn')) {
                        const button = e.target.closest('.pagination-btn');
                        this.currentPage = parseInt(button.getAttribute('data-page'));
                        this.loadOrders();
                    }

                    // Dropdown menus
                    if (e.target.closest('.dropdown > button')) {
                        const button = e.target.closest('.dropdown > button');
                        const dropdown = button.parentElement;
                        const menu = dropdown.querySelector('.dropdown-menu');

                        // Close all other dropdowns
                        document.querySelectorAll('.dropdown-menu').forEach(otherMenu => {
                            if (otherMenu !== menu) {
                                otherMenu.style.display = 'none';
                            }
                        });

                        // Toggle current dropdown
                        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                    } else {
                        // Close dropdowns when clicking outside
                        document.querySelectorAll('.dropdown-menu').forEach(menu => {
                            menu.style.display = 'none';
                        });
                    }
                });
            }
            async openEditModal(orderId) {
                try {
                    this.showLoading();

                    // Use the correct URL pattern - fix this line
                    const response = await fetch(`/Laundry/get-order-details/${orderId}`, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    if (!response.ok) throw new Error('Failed to fetch order details');

                    const data = await response.json();

                    if (data.success) {
                        this.populateEditForm(data.order);
                        this.showModal();
                    } else {
                        throw new Error(data.message || 'Failed to load order details');
                    }
                } catch (error) {
                    console.error('Error loading order details:', error);
                    this.showMessage('Failed to load order details', 'error');
                } finally {
                    this.hideLoading();
                }
            }
        
            
            async submitUpdateForm() {
                try {
                    const formData = new FormData(document.getElementById('updateOrderForm'));

                    // Add CSRF token
                    const csrfToken = this.getCSRFToken();
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    console.log('DEBUG: Submitting update form...');

                    const response = await fetch('/Laundry/update-order/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken
                        }
                    });

                    console.log('DEBUG: Response status:', response.status);
                    console.log('DEBUG: Response headers:', response.headers);

                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        // If not JSON, get the text to see what's returned
                        const text = await response.text();
                        console.error('DEBUG: Non-JSON response:', text.substring(0, 500));
                        throw new Error(`Server returned HTML instead of JSON. Status: ${response.status}. This usually means the URL is wrong or there's a server error.`);
                    }

                    const data = await response.json();
                    console.log('DEBUG: Response data:', data);

                    if (!response.ok) {
                        throw new Error(data.message || `HTTP error! status: ${response.status}`);
                    }

                    if (data.success) {
                        this.showMessage(data.message, 'success');
                        this.closeModal();
                        this.loadOrders(); // Refresh the table
                    } else {
                        throw new Error(data.message || 'Failed to update order');
                    }
                } catch (error) {
                    console.error('Error updating order:', error);
                    this.showMessage(error.message || 'Failed to update order', 'error');
                }
            }
            
            // Update the addItemRow method to handle dynamic form fields better
            addItemRow(item = {}, index = null) {
                const itemsContainer = document.getElementById('updateItemsContainer');
                const currentItemCount = itemsContainer.children.length;
                const itemIndex = index !== null ? index : currentItemCount;

                const itemRow = document.createElement('div');
                itemRow.className = 'item-row';
                itemRow.innerHTML = `
        <div>
            <label class="form-label">Item Name</label>
            <input type="text" name="items-${itemIndex}-itemname" 
                   value="${item.itemname || ''}" 
                   class="form-input" 
                   placeholder="Enter item name" 
                   required>
        </div>
        <div>
            <label class="form-label">Service Type</label>
            <input type="text" name="items-${itemIndex}-servicetype" 
                   value="${item.servicetype || ''}" 
                   class="form-input" 
                   placeholder="e.g., Wash & Fold" 
                   required>
        </div>
        <div>
            <label class="form-label">Price</label>
            <input type="number" name="items-${itemIndex}-unit_price" 
                   value="${item.unit_price || ''}" 
                   class="form-input" 
                   step="0.01" 
                   min="0" 
                   placeholder="0.00" 
                   required>
        </div>
        <button type="button" class="remove-item">
            <i class="fas fa-trash"></i>
        </button>
    `;
                itemsContainer.appendChild(itemRow);
            }

         
            // Update the populateEditForm method
            populateEditForm(order) {
                // Set basic order information
                document.getElementById('updateOrderId').value = order.id;
                document.getElementById('updateCustomerName').value = order.customer.name || '';
                document.getElementById('updateCustomerPhone').value = order.customer.phone || '';
                document.getElementById('updateOrderStatus').value = order.order_status || 'pending';
                document.getElementById('updatePaymentStatus').value = order.payment_status || 'pending';
                document.getElementById('updateAmountPaid').value = order.amount_paid || 0;
                document.getElementById('updateTotalPrice').value = order.total_price || 0;

                // Clear existing items
                const itemsContainer = document.getElementById('updateItemsContainer');
                itemsContainer.innerHTML = '';

                // Populate items
                if (order.items && order.items.length > 0) {
                    order.items.forEach((item, index) => {
                        this.addItemRow(item, index);
                    });
                } else {
                    this.addItemRow(); // Add one empty row if no items
                }
            }
            showModal() {
                document.getElementById('updateOrderModal').classList.add('active');
            }

            closeModal() {
                document.getElementById('updateOrderModal').classList.remove('active');
            }
            async deleteOrder(orderId, orderCode) {
                if (!confirm(`Are you sure you want to delete order ${orderCode}? This action cannot be undone.`)) {
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', this.getCSRFToken());

                    const response = await fetch(`/Laundry/order-delete/${orderCode}/`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': this.getCSRFToken()
                        }
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || `HTTP error! status: ${response.status}`);
                    }

                    if (data.success) {
                        this.showMessage(data.message, 'success');
                        this.loadOrders(); // Refresh the table
                    } else {
                        throw new Error(data.message || 'Failed to delete order');
                    }
                } catch (error) {
                    console.error('Error deleting order:', error);
                    this.showMessage(error.message || 'Failed to delete order', 'error');
                }
            }
            handleOrderSelection(checkbox) {
                const orderId = checkbox.getAttribute('data-order-id');

                if (checkbox.checked) {
                    this.selectedOrders.add(orderId);
                } else {
                    this.selectedOrders.delete(orderId);
                }

                this.updateBulkActionsUI();
            }

            toggleSelectAll(selectAll) {
                const checkboxes = document.querySelectorAll('.order-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectAll;
                    const orderId = checkbox.getAttribute('data-order-id');

                    if (selectAll) {
                        this.selectedOrders.add(orderId);
                    } else {
                        this.selectedOrders.delete(orderId);
                    }
                });

                this.updateBulkActionsUI();
            }

            clearSelection() {
                this.selectedOrders.clear();
                document.querySelectorAll('.order-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                document.getElementById('selectAllCheckbox').checked = false;
                this.updateBulkActionsUI();
            }

            updateBulkActionsUI() {
                const selectedCount = this.selectedOrders.size;
                const bulkContainer = document.getElementById('bulkActionsContainer');
                const selectedCountElement = document.getElementById('selectedCount');

                selectedCountElement.textContent = `${selectedCount} order${selectedCount !== 1 ? 's' : ''} selected`;

                if (selectedCount > 0) {
                    bulkContainer.classList.add('show');
                } else {
                    bulkContainer.classList.remove('show');
                }

                // Update select all checkbox state
                const totalCheckboxes = document.querySelectorAll('.order-checkbox').length;
                document.getElementById('selectAllCheckbox').checked = selectedCount > 0 && selectedCount === totalCheckboxes;
                document.getElementById('selectAllCheckbox').indeterminate = selectedCount > 0 && selectedCount < totalCheckboxes;
            }

            updateActiveFilters() {
                // Update payment filter active state
                document.querySelectorAll('.payment-filter, [data-payment=""]').forEach(btn => {
                    btn.classList.remove('bg-blue-100', 'text-blue-700', 'shadow-sm');
                    btn.classList.add('bg-gray-100', 'text-gray-700');
                });

                const activeBtn = document.querySelector(`[data-payment="${this.currentFilters.payment_status}"]`);
                if (activeBtn) {
                    activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
                    activeBtn.classList.add('bg-blue-100', 'text-blue-700', 'shadow-sm');
                }
            }

            async loadOrders() {
                this.showLoading();

                const params = new URLSearchParams({
                    ...this.currentFilters,
                    page: this.currentPage
                });

                try {
                    const response = await fetch(`?${params}`, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    if (!response.ok) throw new Error('Network response was not ok');

                    const data = await response.json();

                    if (data.success) {
                        this.renderOrders(data.orders);
                        this.renderStats(data.stats);
                        this.renderPagination(data.pagination);
                    } else {
                        throw new Error(data.message || 'Failed to load orders');
                    }
                } catch (error) {
                    console.error('Error loading orders:', error);
                    this.showError('Failed to load orders. Please try again.');
                } finally {
                    this.hideLoading();
                }
            }

            renderOrders(orders) {
                const tbody = document.getElementById('ordersTableBody');

                if (!orders || orders.length === 0) {
                    tbody.innerHTML = `
                   <tr>
    <td colspan="14" class="px-6 py-12 text-left">
        <div class="inline-flex items-center justify-start rounded-full bg-gray-100 p-4 mb-3">
            <i class="fas fa-inbox text-2xl text-gray-400"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-1 text-left">No orders found</h3>
        <p class="text-gray-500 max-w-md text-left">
            ${this.currentFilters.search || this.currentFilters.payment_status ?
                            'No orders match your current filters. Try adjusting your search criteria.' :
                            'There are no active orders in the system. When you have orders, they\'ll appear here.'}
        </p>
        <div class="text-left mt-4">
            <a href="{% url 'laundry:createorder' %}"
                class="btn-primary inline-flex items-center gap-2 px-4 py-2 text-white rounded-lg font-medium">
                <i class="fas fa-plus text-sm"></i>
                <span>Create New Order</span>
            </a>
        </div>
    </td>
</tr>
                `;
                    return;
                }

                tbody.innerHTML = orders.map(order => this.renderOrderRow(order)).join('');
                this.updateBulkActionsUI(); // Update UI after rendering
            }

            renderOrderRow(order) {
                const firstItem = order.items[0] || {};
                const hasMultipleItems = order.items.length > 1;
                const isSelected = this.selectedOrders.has(order.id.toString());
                return `
    <tr class="hover:bg-gray-50 transition-colors duration-150 border-b border-gray-100" data-order-id="${order.id}">
        <td class="checkbox-cell text-left">
            <input type="checkbox" class="order-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                   data-order-id="${order.id}" ${isSelected ? 'checked' : ''}>
        </td>
        <td class="py-3 px-4 text-left">
            <div class="font-medium text-gray-900 text-xs">${order.uniquecode}</div>
        </td>
        <td class="py-3 px-4 text-left">
            <div class="text-xs text-gray-800">${order.customer.name}</div>
        </td>
        <td class="py-3 px-4 text-left">
            <div class="text-xs text-gray-800">${order.customer.address || 'N/A'}</div>
        </td>
        <td class="py-3 px-4 text-left">
            <div class="relative group inline-block">
                <span class="text-xs text-gray-800">${firstItem.servicetype || 'N/A'}</span>
                ${hasMultipleItems ? `
                    <span class="text-xs text-gray-500 ml-1">+${order.items.length - 1}</span>
                    <div class="absolute left-0 top-full mt-1 hidden group-hover:block z-50 w-48 rounded-md bg-gray-900 px-3 py-2 text-xs text-white shadow-lg transition-opacity duration-200">
                        <div class="font-medium mb-1">All Services:</div>
                        <ul class="space-y-1">
                            ${order.items.map(item => `<li class="text-left truncate">${item.servicetype || 'N/A'}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
        </td>
        <td class="py-3 px-4 text-left">
            <div class="relative group inline-block">
                <span class="text-xs text-gray-800">${firstItem.itemtype || 'N/A'}</span>
                ${hasMultipleItems ? `
                    <span class="text-xs text-gray-500 ml-1">+${order.items.length - 1}</span>
                    <div class="absolute left-0 top-full mt-1 hidden group-hover:block z-50 w-48 rounded-md bg-gray-900 px-3 py-2 text-xs text-white shadow-lg transition-opacity duration-200">
                        <div class="font-medium mb-1">All Item Types:</div>
                        <ul class="space-y-1">
                            ${order.items.map(item => `<li class="text-left truncate">${item.itemtype || 'N/A'}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
        </td>
        <td class="py-3 px-4 text-left">
            <div class="relative group inline-block">
                <span class="text-xs text-gray-800">${firstItem.itemname || 'N/A'}</span>
                ${hasMultipleItems ? `
                    <span class="text-xs text-gray-500 ml-1">+${order.items.length - 1}</span>
                    <div class="absolute left-0 top-full mt-1 hidden group-hover:block z-50 w-48 rounded-md bg-gray-900 px-3 py-2 text-xs text-white shadow-lg transition-opacity duration-200">
                        <div class="font-medium mb-1">All Items:</div>
                        <ul class="space-y-1">
                            ${order.items.map(item => `<li class="text-left truncate">${item.itemname || 'N/A'}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
        </td>
        <td class="py-3 px-4 text-left">
            <span class="text-xs ${this.getConditionColor(firstItem.itemcondition)}">
                ${firstItem.itemcondition || 'N/A'}
            </span>
            ${hasMultipleItems ? `
                <div class="relative group inline-block ml-1">
                    <span class="text-xs text-gray-500">+${order.items.length - 1}</span>
                    <div class="absolute left-0 top-full mt-1 hidden group-hover:block z-50 w-48 rounded-md bg-gray-900 px-3 py-2 text-xs text-white shadow-lg transition-opacity duration-200">
                        <div class="font-medium mb-1">All Conditions:</div>
                        <ul class="space-y-1">
                            ${order.items.map(item => `<li class="text-left truncate ${this.getConditionColor(item.itemcondition)}">${item.itemcondition || 'N/A'}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            ` : ''}
        </td>
        <td class="py-3 px-4 text-left">
            <div class="font-semibold text-blue-900 text-xs">KSh ${order.amount_paid.toLocaleString()}</div>
        </td>
        <td class="py-3 px-4 text-left">
            <div class="font-semibold text-blue-900 text-xs">KSh ${order.balance.toLocaleString()}</div>
        </td>
        <td class="py-3 px-4 text-left">
            <div class="font-semibold text-blue-900 text-xs">KSh ${order.total_price.toLocaleString()}</div>
        </td>
        <td class="py-3 px-4 text-left">
            ${this.renderOrderStatus(order.order_status)}
        </td>
        <td class="py-3 px-4 text-left">
            ${this.renderPaymentStatus(order.payment_status)}
        </td>
        <td class="py-3 px-4 text-left">
            <div class="flex items-center justify-start space-x-2">
                <button type="button" class="edit-order-btn action-btn edit-btn text-amber-600 hover:bg-amber-100 p-2 rounded-lg transition-colors duration-200"
                    data-order-id="${order.id}" title="Edit Order">
                    <i class="fas fa-edit text-sm"></i>
                </button>
                <div class="dropdown relative">
                    <button class="action-btn text-gray-600 hover:bg-gray-100 p-2 rounded-lg transition-colors duration-200"
                        title="More Actions">
                        <i class="fas fa-ellipsis-v text-sm"></i>
                    </button>
                    <div class="dropdown-menu absolute right-0 mt-1 w-48 bg-white rounded-md shadow-lg py-1 z-50 border border-gray-200">
                        ${order.order_status !== 'Completed' ? `
                            <button type="button" class="w-full text-left px-4 py-2 text-sm text-green-700 hover:bg-green-50 flex items-center update-status-btn"
                                data-status="Completed">
                                <i class="fas fa-check-circle mr-2"></i> Mark Completed
                            </button>
                        ` : ''}
                        ${order.order_status !== 'Delivered_picked' ? `
                            <button type="button" class="w-full text-left px-4 py-2 text-sm text-purple-700 hover:bg-purple-50 flex items-center update-status-btn"
                                data-status="Delivered_picked">
                                <i class="fas fa-truck mr-2"></i> Mark Delivered
                            </button>
                        ` : ''}
                        <div class="border-t border-gray-100 my-1"></div>
                        <a href="/Laundry/order-delete/${order.uniquecode}/"
                            class="block px-4 py-2 text-sm text-red-700 hover:bg-red-50 flex items-center"
                            onclick="return confirm('Are you sure you want to delete this order?')">
                            <i class="fas fa-trash mr-2"></i> Delete Order
                        </a>
                    </div>
                </div>
            </div>
        </td>
    </tr>
`;}        

async bulkUpdateStatus(status) {
                if (this.selectedOrders.size === 0) {
                    this.showMessage('Please select at least one order', 'warning');
                    return;
                }

                const statusText = status.replace('_', ' ');
                if (!confirm(`Are you sure you want to mark ${this.selectedOrders.size} order${this.selectedOrders.size !== 1 ? 's' : ''} as ${statusText}?`)) {
                    return;
                }

                try {
                    const promises = Array.from(this.selectedOrders).map(orderId =>
                        this.updateOrderStatus(orderId, status)
                    );

                    const results = await Promise.allSettled(promises);

                    let successCount = 0;
                    let errorCount = 0;

                    results.forEach((result, index) => {
                        if (result.status === 'fulfilled' && result.value.success) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    });

                    if (successCount > 0) {
                        this.showMessage(`Successfully updated ${successCount} order${successCount !== 1 ? 's' : ''}`, 'success');
                    }
                    if (errorCount > 0) {
                        this.showMessage(`Failed to update ${errorCount} order${errorCount !== 1 ? 's' : ''}`, 'error');
                    }

                    // Refresh the table and clear selection
                    this.clearSelection();
                    this.loadOrders();

                } catch (error) {
                    console.error('Error in bulk update:', error);
                    this.showMessage('Failed to update orders', 'error');
                }
            }

            getConditionColor(condition) {
                const colors = {
                    'new': 'text-green-600',
                    'Old': 'text-yellow-600',
                    'Torn': 'text-red-600'
                };
                return colors[condition] || 'text-gray-800';
            }

            renderOrderStatus(status) {
                const statusConfig = {
                    'Completed': { color: 'green', icon: 'check-circle', label: 'Completed' },
                    'pending': { color: 'yellow', icon: 'clock', label: 'Pending' },
                    'processing': { color: 'blue', icon: 'cog', label: 'Processing' },
                    'Delivered_picked': { color: 'purple', icon: 'truck', label: 'Delivered' }
                };

                const config = statusConfig[status] || { color: 'gray', icon: 'question-circle', label: status };

                return `
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium text-${config.color}-800 bg-${config.color}-100">
                    <i class="fas fa-${config.icon} mr-1"></i> ${config.label}
                </span>
            `;
            }

            renderPaymentStatus(status) {
                const statusConfig = {
                    'completed': { color: 'green', icon: 'check', label: 'Paid' },
                    'partial': { color: 'yellow', icon: 'exclamation-triangle', label: 'Partial' },
                    'pending': { color: 'red', icon: 'clock', label: 'Pending' }
                };

                const config = statusConfig[status] || { color: 'gray', icon: 'question-circle', label: status };

                return `
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium text-${config.color}-800 bg-${config.color}-100">
                    <i class="fas fa-${config.icon} mr-1"></i> ${config.label}
                </span>
            `;
            }

            renderStats(stats) {
                if (stats) {
                    document.getElementById('totalOrders').textContent = stats.total_orders || 0;
                    document.getElementById('pendingOrders').textContent = stats.pending_orders || 0;
                    document.getElementById('completedOrders').textContent = stats.completed_orders || 0;
                }
            }

            renderPagination(pagination) {
                const container = document.getElementById('paginationContainer');

                if (!pagination || !pagination.has_other_pages) {
                    container.innerHTML = '';
                    return;
                }

                let paginationHTML = `
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="text-sm text-gray-700">
                        Showing ${pagination.start_index} to ${pagination.end_index} of ${pagination.count} entries
                    </div>
                    <div class="flex space-x-2">
            `;

                if (pagination.has_previous) {
                    paginationHTML += `
                    <button type="button" class="pagination-btn px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors duration-200"
                        data-page="${pagination.number - 1}">
                        Previous
                    </button>
                `;
                }

                // Show limited page numbers
                const startPage = Math.max(1, pagination.number - 2);
                const endPage = Math.min(pagination.num_pages, pagination.number + 2);

                for (let i = startPage; i <= endPage; i++) {
                    if (i === pagination.number) {
                        paginationHTML += `
                        <span class="px-3 py-2 border border-blue-500 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium">
                            ${i}
                        </span>
                    `;
                    } else {
                        paginationHTML += `
                        <button type="button" class="pagination-btn px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors duration-200"
                            data-page="${i}">
                            ${i}
                        </button>
                    `;
                    }
                }

                if (pagination.has_next) {
                    paginationHTML += `
                    <button type="button" class="pagination-btn px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors duration-200"
                        data-page="${pagination.number + 1}">
                        Next
                    </button>
                `;
                }

                paginationHTML += `
                    </div>
                </div>
            `;

                container.innerHTML = paginationHTML;
            }

            async updateSingleOrderStatus(orderId, status) {
                if (!confirm(`Are you sure you want to mark this order as ${status.replace('_', ' ')}?`)) {
                    return;
                }

                try {
                    const response = await this.updateOrderStatus(orderId, status);
                    if (response.success) {
                        this.showMessage(response.message, 'success');
                        this.loadOrders(); // Refresh the table
                    } else {
                        throw new Error(response.message);
                    }
                } catch (error) {
                    console.error('Error updating order status:', error);
                    this.showMessage('Failed to update order status', 'error');
                }
            }

            async handleBulkAction(action) {
                // For bulk actions using the filter buttons
                this.showMessage('Please select orders using checkboxes for bulk actions', 'info');
            }

            async updateOrderStatus(orderId, status) {
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', this.getCSRFToken());

                const response = await fetch(`/Laundry/update-order-status/${orderId}/${status}/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to update order status');
                }

                return await response.json();
            }

            exportOrders(format) {
                const params = new URLSearchParams({
                    ...this.currentFilters,
                    export: format
                });

                window.location.href = `?${params}`;
            }

            showLoading() {
                document.getElementById('loadingSpinner').style.display = 'block';
                document.getElementById('ordersTableBody').innerHTML = '';
            }

            hideLoading() {
                document.getElementById('loadingSpinner').style.display = 'none';
            }

            showError(message) {
                this.showMessage(message, 'error');
            }

            showMessage(message, type) {
                // Create toast notification
                const toast = document.createElement('div');
                toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-500' :
                    type === 'error' ? 'bg-red-500' :
                        type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
                    } text-white`;
                toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 5000);
            }

            getCSRFToken() {
                return document.querySelector('[name=csrfmiddlewaretoken]').value;
            }

            startAutoRefresh() {
                // Refresh every 30 seconds
                setInterval(() => {
                    this.loadOrders();
                }, 30000);
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            window.orderManager = new OrderManager();
        });
    </script>
</body>

</html>
{% endblock %}