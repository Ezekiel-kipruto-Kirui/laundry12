{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* Modern Dashboard Styles */
    .dashboard-container {
        --primary: #1E3A8A;
        /* Navy blue */
        --secondary: #F59E0B;
        /* Orange-yellow */
        --accent: #FBBF24;
        /* Lighter orange */
        --light-bg: #F8FAFC;
        --dark-bg: #0F172A;
        --card-light: #FFFFFF;
        --card-dark: #1E293B;
        --text-light: #1E293B;
        --text-dark: #F1F5F9;
        --border-light: #E2E8F0;
        --border-dark: #334155;
        --success: #10B981;
        --warning: #F59E0B;
        --danger: #EF4444;
        --info: #3B82F6;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: var(--light-bg);
        transition: all 0.3s ease;
    }

    body.dark {
        background: var(--dark-bg);
    }

    .dashboard-container {
        padding: 1.5rem;
        max-width: 100%;
        overflow-x: hidden;
    }

    /* Header Styles */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .dashboard-title {
        font-size: 1.875rem;
        font-weight: 700;
        color: var(--text-light);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .dark .dashboard-title {
        color: var(--text-dark);
    }

    /* Month Selector */
    .month-selector {
        background: var(--card-light);
        border: 1px solid var(--border-light);
        border-radius: 12px;
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .dark .month-selector {
        background: var(--card-dark);
        border-color: var(--border-dark);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
    }

    .month-selector label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-light);
    }

    .dark .month-selector label {
        color: var(--text-dark);
    }

    .month-selector input {
        background: transparent;
        border: none;
        font-weight: 500;
        color: var(--text-light);
        padding: 0.25rem 0;
    }

    .dark .month-selector input {
        color: var(--text-dark);
    }

    /* Card Styles */
    .stat-card {
        background: var(--card-light);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .dark .stat-card {
        background: var(--card-dark);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .dark .stat-card:hover {
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        border-radius: 8px 8px 0 0;
    }

    .icon-wrapper {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        background: rgba(30, 58, 138, 0.1);
        color: var(--primary);
    }

    .shop-a-theme .icon-wrapper {
        background: rgba(30, 58, 138, 0.1);
        color: var(--primary);
    }

    .shop-b-theme .icon-wrapper {
        background: rgba(245, 158, 11, 0.1);
        color: var(--secondary);
    }

    .stat-card h3 {
        font-size: 0.875rem;
        font-weight: 500;
        color: #64748B;
        margin-bottom: 0.5rem;
    }

    .dark .stat-card h3 {
        color: #94A3B8;
    }

    .stat-card .value {
        font-size: 1.875rem;
        font-weight: 700;
        color: var(--text-light);
        margin-bottom: 0.25rem;
    }

    .dark .stat-card .value {
        color: var(--text-dark);
    }

    .stat-card .subtext {
        font-size: 0.75rem;
        color: #94A3B8;
    }

    /* Chart Containers */
    .chart-container {
        background: var(--card-light);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        transition: all 0.3s ease;
    }

    .dark .chart-container {
        background: var(--card-dark);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
    }

    .chart-container:hover {
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .dark .chart-container:hover {
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .chart-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-light);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .dark .chart-title {
        color: var(--text-dark);
    }

    .chart-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        background: rgba(30, 58, 138, 0.1);
        color: var(--primary);
    }

    /* Customer Cards */
    .customer-card {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 12px;
        background: var(--card-light);
        margin-bottom: 0.75rem;
        transition: all 0.3s ease;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
    }

    .dark .customer-card {
        background: var(--card-dark);
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.2);
    }

    .customer-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .dark .customer-card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
    }

    .customer-avatar {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        margin-right: 1rem;
    }

    .customer-info {
        flex: 1;
    }

    .customer-name {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-light);
        margin-bottom: 0.25rem;
    }

    .dark .customer-name {
        color: var(--text-dark);
    }

    .customer-stats {
        font-size: 0.75rem;
        color: #64748B;
    }

    .customer-amount {
        font-size: 0.875rem;
        font-weight: 700;
        color: var(--primary);
    }

    /* Section Headers */
    .section-header {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-light);
        margin: 2rem 0 1.5rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .dark .section-header {
        color: var(--text-dark);
    }

    /* Grid Layout */
    .grid {
        display: grid;
        gap: 1.5rem;
    }

    .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
    }

    .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .grid-cols-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    .grid-cols-4 {
        grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    @media (max-width: 1024px) {
        .grid-cols-4 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .grid-cols-3 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    @media (max-width: 768px) {

        .grid-cols-2,
        .grid-cols-3,
        .grid-cols-4 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .month-selector {
            width: 100%;
        }
    }

    /* Empty States */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 2rem;
        height: 100%;
    }

    .empty-state i {
        font-size: 2.5rem;
        color: #CBD5E1;
        margin-bottom: 1rem;
    }

    .dark .empty-state i {
        color: #475569;
    }

    .empty-state h3 {
        font-size: 1rem;
        font-weight: 500;
        color: #64748B;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        font-size: 0.875rem;
        color: #94A3B8;
    }

    /* Animation */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .stat-card,
    .chart-container {
        animation: fadeIn 0.5s ease-out;
    }

    /* Custom scrollbar for customer list */
    .custom-scroll {
        scrollbar-width: thin;
        scrollbar-color: rgba(30, 58, 138, 0.3) transparent;
    }

    .custom-scroll::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scroll::-webkit-scrollbar-track {
        background: transparent;
        border-radius: 3px;
    }

    .custom-scroll::-webkit-scrollbar-thumb {
        background-color: rgba(30, 58, 138, 0.3);
        border-radius: 3px;
    }

    .dark .custom-scroll::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main" class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <i class="fas fa-chart-network" style="color: var(--secondary);"></i>
            Business Analytics Dashboard
        </h1>

        <!-- Month Selector Section -->
        <div class="month-selector">
            <form method="get" class="flex items-center gap-3">
                <!-- Year Input -->
                <label for="year">Year:</label>
                <div class="relative">
                    <input type="number" id="year" name="year" value="{{ current_year }}" min="2000" max="2100"
                        onchange="this.form.submit()">
                    <i
                        class="fas fa-chevron-down absolute right-2 top-1/2 transform -translate-y-1/2 text-xs text-gray-400 pointer-events-none"></i>
                </div>

                <!-- Month Selector -->
                <label for="month">Month:</label>
                <div class="relative">
                    <input type="month" id="month" name="month"
                        value="{% if selected_month %}{{ current_year }}-{{ selected_month }}{% endif %}"
                        onchange="this.form.submit()">
                    <i
                        class="fas fa-calendar-alt absolute right-2 top-1/2 transform -translate-y-1/2 text-xs text-gray-400 pointer-events-none"></i>
                </div>
            </form>
        </div>
    </div>

    <!-- Shop A Stats -->
    <h2 class="section-header">
        <i class="fas fa-store" style="color: var(--primary);"></i>
        Shop A Performance
    </h2>
    <div class="grid grid-cols-4 mb-8 shop-a-theme">
        <!-- Revenue Card -->
        <div class="stat-card">
            <div class="icon-wrapper">
                <i class="fas fa-wallet text-xl"></i>
            </div>
            <h3>Revenue</h3>
            <div class="value">ksh{{ shop_a_revenue|floatformat:2|default:"0.00" }}</div>
            <div class="subtext">{{ current_year }} YTD</div>
        </div>

        <!-- Orders Card -->
        <div class="stat-card">
            <div class="icon-wrapper">
                <i class="fas fa-shopping-bag text-xl"></i>
            </div>
            <h3>Total Orders</h3>
            <div class="value">{{ shop_a_total_orders }}</div>
            <div class="subtext">{{ current_year }} YTD</div>
        </div>

        <!-- Pending Card -->
        <div class="stat-card">
            <div class="icon-wrapper">
                <i class="fas fa-clock text-xl"></i>
            </div>
            <h3>Pending</h3>
            <div class="value">{{ shop_a_pending_orders }}</div>
            <div class="subtext">Awaiting fulfillment</div>
        </div>

        <!-- Completed Card -->
        <div class="stat-card">
            <div class="icon-wrapper">
                <i class="fas fa-check-circle text-xl"></i>
            </div>
            <h3>Completed</h3>
            <div class="value">{{ shop_a_completed_orders }}</div>
            <div class="subtext">Successfully delivered</div>
        </div>
    </div>

    <!-- Shop B Stats -->
    <h2 class="section-header">
        <i class="fas fa-store" style="color: var(--secondary);"></i>
        Shop B Performance
    </h2>
    <div class="grid grid-cols-4 mb-8 shop-b-theme">
        <!-- Revenue Card -->
        <div class="stat-card">
            <div class="icon-wrapper">
                <i class="fas fa-wallet text-xl"></i>
            </div>
            <h3>Revenue</h3>
            <div class="value">ksh{{ shop_b_revenue|floatformat:2|default:"0.00" }}</div>
            <div class="subtext">{{ current_year }} YTD</div>
        </div>

        <!-- Orders Card -->
        <div class="stat-card">
            <div class="icon-wrapper">
                <i class="fas fa-shopping-bag text-xl"></i>
            </div>
            <h3>Total Orders</h3>
            <div class="value">{{ shop_b_total_orders }}</div>
            <div class="subtext">{{ current_year }} YTD</div>
        </div>

        <!-- Pending Card -->
        <div class="stat-card">
            <div class="icon-wrapper">
                <i class="fas fa-clock text-xl"></i>
            </div>
            <h3>Pending</h3>
            <div class="value">{{ shop_b_pending_orders }}</div>
            <div class="subtext">Awaiting fulfillment</div>
        </div>

        <!-- Completed Card -->
        <div class="stat-card">
            <div class="icon-wrapper">
                <i class="fas fa-check-circle text-xl"></i>
            </div>
            <h3>Completed</h3>
            <div class="value">{{ shop_b_completed_orders }}</div>
            <div class="subtext">Successfully delivered</div>
        </div>
    </div>

    <!-- Main Charts Section -->
    <div class="grid grid-cols-2 gap-6 mb-6">
        <!-- Revenue Distribution -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">
                    <i class="fas fa-chart-pie" style="color: var(--secondary);"></i>
                    Revenue Distribution
                </h2>
                <span class="chart-badge">{{total_revenue_percentage}}%</span>
            </div>
            <div style="height: 320px;">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Revenue Trend -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">
                    <i class="fas fa-chart-line" style="color: var(--primary);"></i>
                    Revenue Trend
                </h2>
                <span class="chart-badge">{{ current_year }}</span>
            </div>
            <div style="height: 320px;">
                {% if not selected_month %}
                <canvas id="trendChart"></canvas>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-calendar-week"></i>
                    <h3>Switch to yearly view</h3>
                    <p>Monthly trends are available in the annual overview</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Insights Section -->
    <div class="grid grid-cols-3 gap-6 mb-6">
        <!-- Top Services -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">
                    <i class="fas fa-spa" style="color: var(--success);"></i>
                    Top Services
                </h2>
                <span class="chart-badge">{{ current_year }}</span>
            </div>
            <div style="height: 288px;">
                {% if services_labels and services_labels|length > 0 %}
                <canvas id="servicesChart"></canvas>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-concierge-bell"></i>
                    <p>No service data available</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Popular Products -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">
                    <i class="fas fa-box-open" style="color: var(--warning);"></i>
                    Common Items
                </h2>
                <span class="chart-badge">{{ current_year }}</span>
            </div>
            <div style="height: 288px;">
                {% if item_labels and item_labels|length > 0 %}
                <canvas id="productsChart"></canvas>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-box"></i>
                    <p>No product data available</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- VIP Customers -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">
                    <i class="fas fa-crown" style="color: var(--secondary);"></i>
                    Top Customers
                </h2>
                <span class="chart-badge">Top Spenders</span>
            </div>
            <div class="custom-scroll" style="height: 288px; overflow-y: auto;">
                {% for customer in common_customers %}
                <div class="customer-card">
                    <div class="customer-avatar">
                        {{ forloop.counter }}
                    </div>
                    <div class="customer-info">
                        <div class="customer-name">{{ customer.customer__name }}</div>
                        <div class="customer-stats">{{ customer.order_count }} orders</div>
                    </div>
                    <div class="customer-amount">
                        ksh{{ customer.total_spent|floatformat:2 }}
                    </div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <i class="fas fa-user-slash"></i>
                    <p>No customer data available</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    // Color palette using navy blue and orange-yellow
    const COLOR_PALETTE = {
        primary: '#1E3A8A', // Navy blue
        secondary: '#F59E0B', // Orange-yellow
        accent: '#FBBF24', // Lighter orange
        success: '#10B981',
        warning: '#F59E0B',
        danger: '#EF4444',
        info: '#3B82F6',
        light: '#F8FAFC',
        dark: '#0F172A'
    };

    // Shop-specific color schemes
    const SHOP_COLORS = {
        'Shop A': {
            primary: COLOR_PALETTE.primary,
            secondary: COLOR_PALETTE.secondary
        },
        'Shop B': {
            primary: COLOR_PALETTE.secondary,
            secondary: COLOR_PALETTE.accent
        }
    };

    function getChartOptions() {
        const isDark = document.documentElement.classList.contains('dark');
        const textColor = isDark ? '#F1F5F9' : '#1E293B';
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
        const tooltipBg = isDark ? '#1E293B' : '#FFFFFF';
        const tooltipBorder = isDark ? '#334155' : '#E2E8F0';
        const tooltipText = isDark ? '#F1F5F9' : '#1E293B';

        return {
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false // Hide legend for all charts
                },
                tooltip: {
                    backgroundColor: tooltipBg,
                    borderColor: tooltipBorder,
                    borderWidth: 1,
                    borderRadius: 12,
                    padding: 12,
                    titleColor: tooltipText,
                    bodyColor: tooltipText,
                    bodyFont: {
                        size: 14,
                        weight: '600'
                    },
                    titleFont: {
                        size: 12,
                        weight: '500'
                    },
                    boxShadow: '0 8px 24px rgba(0, 0, 0, 0.15)',
                    callbacks: {
                        title: function (context) {
                            return context[0].label || '';
                        },
                        label: function (context) {
                            // Simplified tooltip - just show the value without "ksh" prefix
                            if (context.parsed.y !== undefined) {
                                return context.parsed.y.toLocaleString('en-US');
                            } else if (context.parsed !== undefined) {
                                return context.parsed.toLocaleString('en-US');
                            }
                            return '';
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: false, // Hide x-axis completely
                    grid: {
                        display: false
                    },
                    ticks: {
                        display: false // Hide x-axis labels
                    },
                    border: {
                        display: false
                    }
                },
                y: {
                    display: false, // Hide y-axis completely
                    grid: {
                        display: false
                    },
                    ticks: {
                        display: false // Hide y-axis labels
                    },
                    border: {
                        display: false
                    }
                }
            }
        };
    }

    document.addEventListener("DOMContentLoaded", function () {
        const options = getChartOptions();

        // Enhanced Revenue Distribution Chart with navy blue and orange-yellow
        const revenueCtx = document.getElementById('revenueChart')?.getContext('2d');
        if (revenueCtx) {
            let revenueLabels = [];
            let revenueValues = [];
            try {
                revenueLabels = JSON.parse('{{ pie_chart_labels|safe }}');
                revenueValues = JSON.parse('{{ pie_chart_values|safe }}');
            } catch (e) {
                console.error('Error parsing revenue chart data:', e);
                revenueLabels = [];
                revenueValues = [];
            }

            // Using navy blue and orange-yellow for the doughnut chart
            const pieColors = [
                COLOR_PALETTE.primary, // Navy blue
                COLOR_PALETTE.secondary, // Orange-yellow
                COLOR_PALETTE.accent, // Lighter orange
                COLOR_PALETTE.info,
                COLOR_PALETTE.success,
                COLOR_PALETTE.warning
            ];

            new Chart(revenueCtx, {
                type: 'doughnut',
                data: {
                    labels: revenueLabels,
                    datasets: [{
                        data: revenueValues,
                        backgroundColor: pieColors,
                        borderWidth: 0,
                        cutout: '70%', // Larger cutout for cleaner look
                        spacing: 2,
                        hoverOffset: 10,
                        borderRadius: 6
                    }]
                },
                options: {
                    ...options,
                    plugins: {
                        ...options.plugins,
                        // No legend for doughnut chart
                    }
                }
            });
        }

        // Enhanced Trend Chart
        const trendCtx = document.getElementById('trendChart')?.getContext('2d');
        if (trendCtx) {
            let lineData = [];
            try {
                lineData = JSON.parse('{{ line_chart_data|safe }}');
            } catch (e) {
                console.error('Error parsing line chart data:', e);
                lineData = [];
            }

            // Line colors using our color palette
            const lineColors = [
                COLOR_PALETTE.primary,
                COLOR_PALETTE.secondary,
                COLOR_PALETTE.success,
                COLOR_PALETTE.info,
                COLOR_PALETTE.warning
            ];

            const datasets = lineData.map((series, index) => ({
                label: series.label,
                data: series.data,
                borderColor: lineColors[index % lineColors.length],
                backgroundColor: `${lineColors[index % lineColors.length]}10`, // Lighter fill
                borderWidth: 3,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointBackgroundColor: lineColors[index % lineColors.length],
                fill: true,
                cubicInterpolationMode: 'monotone'
            }));

            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: lineData[0]?.months || [],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        ...options.plugins,
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                boxWidth: 10,
                                boxHeight: 10
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true, // Show x-axis for trend chart
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: options.scales.x.ticks.color,
                                maxRotation: 0,
                                padding: 10
                            }
                        },
                        y: {
                            display: false, // Hide y-axis for trend chart
                            grid: {
                                display: false
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        // Enhanced Bar Charts for Services and Products
        const createBarChart = (id, labels, data, color) => {
            const ctx = document.getElementById(id)?.getContext('2d');
            if (!ctx) return;

            const barColors = labels.map((_, index) => {
                const colors = [
                    COLOR_PALETTE.primary,
                    COLOR_PALETTE.secondary,
                    COLOR_PALETTE.accent,
                    COLOR_PALETTE.info,
                    COLOR_PALETTE.success
                ];
                return colors[index % colors.length];
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: barColors,
                        borderRadius: 8,
                        borderWidth: 0,
                        barThickness: 16,
                        categoryPercentage: 0.8,
                        barPercentage: 0.9
                    }]
                },
                options: {
                    ...options,
                    indexAxis: 'y',
                    plugins: {
                        ...options.plugins,
                        tooltip: {
                            ...options.plugins.tooltip,
                            callbacks: {
                                title: function (context) {
                                    // Show just the label (service/item name)
                                    return context[0].label || '';
                                },
                                label: function (context) {
                                    // Show just the count without "orders" text
                                    return `${context.parsed.x}`;
                                }
                            }
                        }
                    }
                }
            });
        };

        // Top Services Chart
        let servicesLabels = [];
        let servicesData = [];
        try {
            servicesLabels = JSON.parse('{{ services_labels|safe }}');
            servicesData = JSON.parse('{{ services_counts|safe }}');
        } catch (e) {
            console.error('Error parsing services chart data:', e);
            servicesLabels = [];
            servicesData = [];
        }
        if (servicesLabels?.length) {
            createBarChart('servicesChart', servicesLabels, servicesData);
        }

        // Products Chart
        let productsLabels = [];
        let productsData = [];
        try {
            productsLabels = JSON.parse('{{ item_labels|safe }}');
            productsData = JSON.parse('{{ item_counts|safe }}');
        } catch (e) {
            console.error('Error parsing products chart data:', e);
            productsLabels = [];
            productsData = [];
        }
        if (productsLabels?.length) {
            createBarChart('productsChart', productsLabels, productsData);
        }

        // Add smooth animations and transitions
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach(card => {
            card.addEventListener('mouseenter', () => {
                card.style.transform = 'translateY(-4px)';
            });
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'translateY(0)';
            });
        });
    });

    // Handle dark/light mode transitions
    const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
            if (mutation.attributeName === 'class') {
                // Reinitialize charts when theme changes
                if (typeof Chart !== 'undefined') {
                    Chart.getChart('revenueChart')?.update();
                    Chart.getChart('trendChart')?.update();
                    Chart.getChart('servicesChart')?.update();
                    Chart.getChart('productsChart')?.update();
                }
            }
        });
    });

    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class']
    });
</script>
{% endblock %}

