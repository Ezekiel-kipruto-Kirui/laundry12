{% extends "../home.html" %}
{% load static %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div id="content-main" class="min-h-screen p-6 bg-gray-50">
    <!-- Dashboard Header -->
    <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
            <i class="fas fa-chart-line text-pink-500"></i>
            Business Dashboard
        </h1>
    </div>

    <!-- Date Range Filter Section -->
    <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm mb-6">
        <form method="get" id="filterForm" class="flex items-center gap-4 flex-wrap">
            <!-- Year Input -->
            <div class="flex items-center gap-2">
                <label for="year" class="text-sm font-medium text-gray-700 whitespace-nowrap">Year:</label>
                <input type="number" id="year" name="year" value="{{ selected_year }}" min="2020" max="2100"
                    class="bg-white border border-gray-300 rounded-md px-3 py-2 text-gray-700 w-24 focus:outline-none focus:ring-2 focus:ring-pink-500">
            </div>

            <!-- Month Selector -->
            <div class="flex items-center gap-2">
                <label for="month" class="text-sm font-medium text-gray-700 whitespace-nowrap">Month:</label>
                <input type="month" id="month" name="month"
                    value="{% if selected_month %}{{ selected_year }}-{{ selected_month|stringformat:'02d' }}{% endif %}"
                    class="bg-white border border-gray-300 rounded-md px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-pink-500">
            </div>

            <!-- Date Range -->
            <div class="flex items-center gap-2">
                <label for="from_date" class="text-sm font-medium text-gray-700 whitespace-nowrap">From:</label>
                <input type="date" id="from_date" name="from_date" value="{% if from_date %}{{ from_date }}{% endif %}"
                    class="bg-white border border-gray-300 rounded-md px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-pink-500">
            </div>
            <div class="flex items-center gap-2">
                <label for="to_date" class="text-sm font-medium text-gray-700 whitespace-nowrap">To:</label>
                <input type="date" id="to_date" name="to_date" value="{% if to_date %}{{ to_date }}{% endif %}"
                    class="bg-white border border-gray-300 rounded-md px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-pink-500">
            </div>

            <div class="flex gap-2 ml-auto">
                <button type="submit"
                    class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-md font-medium transition-all duration-300 flex items-center gap-2">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
                <button type="button" id="resetFilters"
                    class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-md font-medium transition-all duration-300 flex items-center gap-2">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>
        </form>
    </div>

    <!-- Overall Stats -->
    <h2 class="text-xl font-semibold text-gray-800 mb-4 pl-3 border-l-4 border-pink-500 flex items-center gap-2">
        <i class="fas fa-store text-pink-500"></i> General
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">

        <!-- Total Revenue -->
        <div
            class="bg-white rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-l-4 border-green-500">
            <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center">
                    <i class="fas fa-wallet text-green-500 text-lg"></i>
                </div>
            </div>
            <div>
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Total Revenue</h3>
                <div class="text-2xl font-bold text-gray-800 mt-1">Ksh {{total_revenue|floatformat:2|default:"0.00" }}
                </div>
                <div class="text-xs text-gray-500 mt-1">Total earnings</div>
            </div>
        </div>

        <!-- Total Orders -->
        <div
            class="bg-white rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-l-4 border-pink-500">
            <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 rounded-lg bg-pink-50 flex items-center justify-center">
                    <i class="fas fa-shopping-bag text-pink-500 text-lg"></i>
                </div>
            </div>
            <div>
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Orders</h3>
                <div>
                   
                    <div class="text-2xl font-bold text-gray-800 mt-1">{{ total_orders }}</div>
                    <span class="text-yellow-500">{{ pending_orders }} pending</span> •
                    <span class="text-blue-500">{{ completed_orders }} Completed</span>
                    
                    
                </div>
                <div class="text-2xl font-bold text-gray-800 mt-1"></div>
                <div class="text-xs text-gray-500 mt-1">All time orders</div>
            </div>
        </div>

        <!-- Pending Orders -->
        <div
            class="bg-white rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-l-4 border-yellow-500">
            <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 rounded-lg bg-yellow-50 flex items-center justify-center">
                    <i class="fas fa-clock text-yellow-500 text-lg"></i>
                </div>
            </div>
            <div>
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Pending payment Balance</h3>
                <div class="text-2xl font-bold text-gray-800 mt-1">{{ total_balance_amount }}</div>
                
                <div class="text-xs text-gray-500 mt-1">Awaiting processing</div>
            </div>
        </div>

        <!-- Completed Orders -->
        
    </div>

    <!-- Shop A Stats -->
    <div class="mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4 pl-3 border-l-4 border-pink-500 flex items-center gap-2">
            <i class="fas fa-store text-pink-500"></i> Shop A
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Shop A Revenue -->
            <div
                class="bg-white rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-l-4 border-green-500">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center">
                        <i class="fas fa-wallet text-green-500 text-lg"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Total Revenue</h3>
                    <div class="text-2xl font-bold text-gray-800 mt-1">Ksh {{shop_a_revenue|floatformat:2|default:"0.00" }}</div>
                    <div class="text-xs text-gray-500 mt-1">Shop A earnings</div>
                </div>
            </div>

            <!-- Shop A Orders -->
            <div
                class="bg-white rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-l-4 border-pink-500">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-lg bg-pink-50 flex items-center justify-center">
                        <i class="fas fa-shopping-bag text-pink-500 text-lg"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Order Statistics</h3>
                    <div class="text-2xl font-bold text-gray-800 mt-1">{{ shop_a_total_orders }}</div>
                    <div class="text-xs text-gray-500 mt-1 flex gap-2">
                        <span class="text-yellow-500">{{ shop_a_pending_orders }} pending</span> •
                        <span class="text-blue-500">{{ shop_a_completed_orders }} completed</span>
                    </div>
                </div>
            </div>

            <!-- Shop A Partial Payment -->
            <div
                class="bg-white rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-l-4 border-indigo-900">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-lg bg-indigo-50 flex items-center justify-center">
                        <i class="fas fa-money-bill-wave text-indigo-900 text-lg"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Payments</h3>
                    <div class="text-2xl font-bold text-gray-800 mt-1">{{ shop_a_total_balance }}</div>
                    <span class="text-yellow-500">{{ shop_a_pending_payments }} pending</span> •
                    <span class="text-blue-500">{{ shop_a_partial_payments }} Partial</span>
                    <span class="text-blue-500">{{ shop_a_complete_payments }} completed</span>
                    <div class="text-xs text-gray-500 mt-1">Advanced payments</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shop B Stats -->
    <div class="mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4 pl-3 border-l-4 border-yellow-500 flex items-center gap-2">
            <i class="fas fa-store text-yellow-500"></i> Shop B Performance
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Shop B Revenue -->
            <div
                class="bg-white rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-l-4 border-green-500">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center">
                        <i class="fas fa-wallet text-green-500 text-lg"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Total Revenue</h3>
                    <div class="text-2xl font-bold text-gray-800 mt-1">Ksh
                        {{shop_b_revenue|floatformat:2|default:"0.00"}}</div>
                    <div class="text-xs text-gray-500 mt-1">Shop B earnings</div>
                </div>
            </div>

            <!-- Shop B Orders -->
            <div
                class="bg-white rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-l-4 border-pink-500">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-lg bg-pink-50 flex items-center justify-center">
                        <i class="fas fa-shopping-bag text-pink-500 text-lg"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Order Statistics</h3>
                    <div class="text-2xl font-bold text-gray-800 mt-1">{{ shop_b_total_orders }}</div>
                    <div class="text-xs text-gray-500 mt-1 flex gap-2">
                        <span class="text-yellow-500">{{ shop_b_pending_orders }} pending</span> •
                        <span class="text-blue-500">{{ shop_b_completed_orders }} completed</span>
                    </div>
                </div>
            </div>

            <!-- Shop B Partial Payment -->
            <div
                class="bg-white rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-l-4 border-indigo-900">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-lg bg-indigo-50 flex items-center justify-center">
                        <i class="fas fa-money-bill-wave text-indigo-900 text-lg"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Payments</h3>
                    <div class="text-2xl font-bold text-gray-800 mt-1">{{ shop_b_total_balanc }}</div>
                    
                    <span class="text-yellow-500"> {{ shop_b_pending_payments }} pending</span> •
                    <span class="text-blue-500">{{ shop_b_partial_payments }} Partial</span>•
                    <span class="text-blue-500">{{ shop_b_complete_payments }} completed</span>
                   
                    <div class="text-xs text-gray-500 mt-1">Advanced payments</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Revenue Distribution -->
        <div class="bg-white rounded-xl p-6 shadow-sm">
            <div class="flex justify-between items-center mb-6">
                <h4 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-chart-pie text-yellow-500"></i>
                    Revenue Distribution
                </h4>
                <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">Total</span>
            </div>
            <div class="h-64">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Revenue Trend -->
        <div class="bg-white rounded-xl p-6 shadow-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-chart-line text-pink-500"></i>
                    Revenue Trend
                </h2>
                <span class="bg-pink-100 text-pink-800 px-3 py-1 rounded-full text-sm font-medium">{{ selected_year }}</span>
            </div>
            <div class="h-64">
                {% if not selected_month %}
                <canvas id="trendChart"></canvas>
                {% else %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-calendar-week text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Switch to yearly view</h3>
                    <p class="text-gray-500">Monthly trends are available in the annual overview</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Insights Section -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Top Services -->
        <div class="bg-white rounded-xl p-6 shadow-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-spa text-green-500"></i>
                    Top Services
                </h2>
                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">{{ selected_year }}</span>
            </div>
            <div class="h-72">
                {% if services_labels and services_labels|length > 0 %}
                <canvas id="servicesChart"></canvas>
                {% else %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-concierge-bell text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">No service data available</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Popular Products -->
        <div class="bg-white rounded-xl p-6 shadow-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-box-open text-yellow-500"></i>
                    Common Items
                </h2>
                <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">{{ selected_year }}</span>
            </div>
            <div class="h-72">
                {% if item_labels and item_labels|length > 0 %}
                <canvas id="productsChart"></canvas>
                {% else %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-box text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">No product data available</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- VIP Customers -->
        <div class="bg-white rounded-xl p-6 shadow-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-crown text-yellow-500"></i>
                    Top Customers
                </h2>
                <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">{{ selected_year }}</span>
            </div>
            <div class="h-72 overflow-y-auto">
                {% for customer in common_customers %}
                <div
                    class="flex items-center p-3 bg-gray-50 rounded-lg mb-2 transition-all duration-300 hover:bg-gray-100">
                    <div
                        class="w-9 h-9 rounded-lg bg-gradient-to-br from-pink-500 to-yellow-500 flex items-center justify-center text-white font-semibold mr-3">
                        {{ forloop.counter }}
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">{{ customer.customer__name }}</div>
                        <div class="text-sm text-gray-500">{{ customer.order_count }} orders</div>
                    </div>
                    <div class="font-bold text-pink-500">
                        ksh{{ customer.total_spent|floatformat:2 }}
                    </div>
                </div>
                {% empty %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-user-slash text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">No customer data available</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    // Date Range Filter Functionality
    document.addEventListener('DOMContentLoaded', function () {
        const filterForm = document.getElementById('filterForm');
        const resetButton = document.getElementById('resetFilters');

        // Set today's date as max for date inputs
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('from_date').max = today;
        document.getElementById('to_date').max = today;

        // Reset filters functionality
        resetButton.addEventListener('click', function () {
            // Clear all filter inputs
            document.getElementById('year').value = new Date().getFullYear();
            document.getElementById('month').value = '';
            document.getElementById('from_date').value = '';
            document.getElementById('to_date').value = '';

            // Submit the form to reset filters
            filterForm.submit();
        });

        // Validate date range
        const fromDateInput = document.getElementById('from_date');
        const toDateInput = document.getElementById('to_date');

        fromDateInput.addEventListener('change', function () {
            if (this.value && toDateInput.value && this.value > toDateInput.value) {
                toDateInput.value = this.value;
            }
        });

        toDateInput.addEventListener('change', function () {
            if (this.value && fromDateInput.value && this.value < fromDateInput.value) {
                fromDateInput.value = this.value;
            }
        });

        // Auto-submit when year or month changes (optional)
        document.getElementById('year').addEventListener('change', function () {
            if (!fromDateInput.value && !toDateInput.value) {
                filterForm.submit();
            }
        });

        document.getElementById('month').addEventListener('change', function () {
            if (!fromDateInput.value && !toDateInput.value) {
                filterForm.submit();
            }
        });
    });

    // Chart initialization code
    function initializeCharts() {
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded');
            setTimeout(initializeCharts, 100);
            return;
        }

        const COLOR_PALETTE = {
            navyBlue: '#1E3A8A',
            orangeYellow: '#F59E0B',
            lightOrange: '#FBBF24',
            pink: '#EC407A',
            lightPink: '#F48FB1',
            success: '#10B981',
            warning: '#F59E0B',
            danger: '#EF4444',
            info: '#3B82F6'
        };

        function getChartOptions() {
            const textColor = '#1E293B';
            const tooltipBg = '#FFFFFF';
            const tooltipBorder = '#E2E8F0';
            const tooltipText = '#1E293B';

            return {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: {
                        labels: {
                            color: textColor,
                            font: {
                                size: 11,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: tooltipBg,
                        borderColor: tooltipBorder,
                        borderWidth: 1,
                        borderRadius: 12,
                        padding: 12,
                        titleColor: tooltipText,
                        bodyColor: tooltipText,
                        bodyFont: {
                            size: 14,
                            weight: '600'
                        },
                        titleFont: {
                            size: 12,
                            weight: '500'
                        },
                        callbacks: {
                            title: function (context) {
                                return context[0].label || '';
                            },
                            label: function (context) {
                                if (context.parsed.y !== undefined) {
                                    return context.parsed.y.toLocaleString('en-US');
                                } else if (context.parsed !== undefined) {
                                    return context.parsed.toLocaleString('en-US');
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: false,
                        grid: { display: false },
                        ticks: { color: textColor, font: { size: 11 } },
                        border: { display: false }
                    },
                    y: {
                        display: false,
                        grid: { display: false },
                        ticks: { color: textColor, font: { size: 11 } },
                        border: { display: false }
                    }
                }
            };
        }

        function safeJsonParse(jsonString, fallback = []) {
            try {
                if (!jsonString || jsonString === 'None' || jsonString === 'null' ||
                    jsonString === '""' || jsonString === "''") {
                    return fallback;
                }

                let parsedString = jsonString;
                if (typeof jsonString === 'string') {
                    parsedString = jsonString.replace(/None/g, 'null');
                    parsedString = parsedString.replace(/'/g, '"');
                }

                const parsed = JSON.parse(parsedString);
                return Array.isArray(parsed) ? parsed : fallback;
            } catch (error) {
                console.error('Error parsing JSON:', jsonString, error);
                return fallback;
            }
        }

        function sortDataDescending(labels, data) {
            const combined = labels.map((label, index) => ({
                label,
                value: data[index] || 0
            }));

            combined.sort((a, b) => b.value - a.value);

            const sortedLabels = combined.map(item => item.label);
            const sortedData = combined.map(item => item.value);

            return { sortedLabels, sortedData };
        }

        // Revenue Chart
        const revenueCanvas = document.getElementById('revenueChart');
        if (revenueCanvas) {
            const revenueLabels = safeJsonParse('{{ pie_chart_labels|safe }}');
            const revenueValues = safeJsonParse('{{ pie_chart_values|safe }}');

            if (revenueLabels.length > 0 && revenueValues.length > 0 &&
                revenueLabels.length === revenueValues.length) {

                const revenueCtx = revenueCanvas.getContext('2d');

                new Chart(revenueCtx, {
                    type: 'doughnut',
                    data: {
                        labels: revenueLabels,
                        datasets: [{
                            data: revenueValues,
                            backgroundColor: [
                                COLOR_PALETTE.navyBlue,
                                COLOR_PALETTE.orangeYellow,
                                COLOR_PALETTE.lightOrange,
                                COLOR_PALETTE.pink,
                                COLOR_PALETTE.lightPink,
                                COLOR_PALETTE.success,
                                COLOR_PALETTE.info
                            ],
                            borderWidth: 0,
                            cutout: '70%',
                            spacing: 0,
                            hoverOffset: 4,
                            borderRadius: 0
                        }]
                    },
                    options: {
                        ...getChartOptions(),
                        plugins: {
                            ...getChartOptions().plugins,
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 10,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    boxWidth: 8,
                                    boxHeight: 8,
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn('No valid data for revenue chart');
                revenueCanvas.style.display = 'none';
                const message = document.createElement('div');
                message.className = 'flex flex-col items-center justify-center h-full text-center';
                message.innerHTML = '<i class="fas fa-chart-pie text-4xl text-gray-400 mb-4"></i><p class="text-gray-500">No revenue data available</p>';
                revenueCanvas.parentNode.appendChild(message);
            }
        }

        // Trend Chart
        const trendCanvas = document.getElementById('trendChart');
        if (trendCanvas) {
            const lineData = safeJsonParse('{{ line_chart_data|safe }}');

            if (lineData && lineData.length > 0 && lineData[0] && lineData[0].months) {
                const trendCtx = trendCanvas.getContext('2d');
                const lineColors = [
                    COLOR_PALETTE.pink,
                    COLOR_PALETTE.orangeYellow,
                    COLOR_PALETTE.navyBlue,
                    COLOR_PALETTE.success,
                    COLOR_PALETTE.info
                ];

                const datasets = lineData.map((series, index) => ({
                    label: series.label || `Series ${index + 1}`,
                    data: series.data || [],
                    borderColor: lineColors[index % lineColors.length],
                    backgroundColor: `${lineColors[index % lineColors.length]}20`,
                    borderWidth: 1,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    pointBackgroundColor: lineColors[index % lineColors.length],
                    fill: true,
                    cubicInterpolationMode: 'monotone'
                }));

                new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: lineData[0].months,
                        datasets: datasets
                    },
                    options: {
                        ...getChartOptions(),
                        scales: {
                            x: {
                                display: true,
                                grid: { display: false },
                                ticks: {
                                    color: getChartOptions().scales.x.ticks.color,
                                    maxRotation: 0,
                                    padding: 10
                                }
                            },
                            y: {
                                display: false,
                                grid: { display: false }
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                });
            } else {
                console.warn('No valid data for trend chart');
                trendCanvas.style.display = 'none';
                const message = document.createElement('div');
                message.className = 'flex flex-col items-center justify-center h-full text-center';
                message.innerHTML = '<i class="fas fa-chart-line text-4xl text-gray-400 mb-4"></i><p class="text-gray-500">No trend data available</p>';
                trendCanvas.parentNode.appendChild(message);
            }
        }

        // Bar Charts
        const createBarChart = (id, labels, data, title) => {
            const canvas = document.getElementById(id);
            if (!canvas) return;

            if (labels.length > 0 && data.length > 0 && labels.length === data.length) {
                const { sortedLabels, sortedData } = sortDataDescending(labels, data);

                const ctx = canvas.getContext('2d');
                const barColors = [
                    COLOR_PALETTE.navyBlue,
                    COLOR_PALETTE.orangeYellow,
                    COLOR_PALETTE.pink,
                    COLOR_PALETTE.lightPink,
                    COLOR_PALETTE.success,
                    COLOR_PALETTE.info,
                    COLOR_PALETTE.warning
                ];

                const customTooltip = {
                    callbacks: {
                        title: function (context) {
                            return context[0].label || '';
                        },
                        label: function (context) {
                            if (id === 'servicesChart') {
                                return `${context.parsed.x.toLocaleString('en-US')} orders`;
                            }
                            return context.parsed.x.toLocaleString('en-US');
                        }
                    }
                };

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedLabels,
                        datasets: [{
                            data: sortedData,
                            backgroundColor: sortedLabels.map((_, index) => barColors[index % barColors.length]),
                            borderRadius: 8,
                            borderWidth: 0,
                            barThickness: 10,
                            categoryPercentage: 0.8,
                            barPercentage: 0.9
                        }]
                    },
                    options: {
                        ...getChartOptions(),
                        indexAxis: 'y',
                        plugins: {
                            ...getChartOptions().plugins,
                            legend: {
                                display: false
                            },
                            tooltip: id === 'productsChart' ? { enabled: false } : {
                                ...getChartOptions().plugins.tooltip,
                                callbacks: customTooltip.callbacks
                            }
                        },
                        scales: {
                            y: {
                                display: true,
                                grid: { display: false },
                                ticks: {
                                    color: getChartOptions().scales.x.ticks.color,
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    },
                                    padding: 8
                                }
                            },
                            x: {
                                display: true,
                                grid: { display: false },
                                ticks: {
                                    color: getChartOptions().scales.x.ticks.color,
                                    font: { size: 10 }
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn(`No valid data for ${title} chart`);
                canvas.style.display = 'none';
                const message = document.createElement('div');
                message.className = 'flex flex-col items-center justify-center h-full text-center';
                message.innerHTML = `<i class="fas ${id === 'servicesChart' ? 'fa-concierge-bell' : 'fa-box'} text-4xl text-gray-400 mb-4"></i><p class="text-gray-500">No ${title.toLowerCase()} data available</p>`;
                canvas.parentNode.appendChild(message);
            }
        };

        // Initialize bar charts
        createBarChart('servicesChart',
            safeJsonParse('{{ services_labels|safe }}'),
            safeJsonParse('{{ services_counts|safe }}'),
            'Services');

        createBarChart('productsChart',
            safeJsonParse('{{ item_labels|safe }}'),
            safeJsonParse('{{ item_counts|safe }}'),
            'Products');
    }

    // Initialize charts when DOM is loaded
    document.addEventListener("DOMContentLoaded", function () {
        if (typeof Chart !== 'undefined') {
            initializeCharts();
        } else {
            const checkChart = setInterval(function () {
                if (typeof Chart !== 'undefined') {
                    clearInterval(checkChart);
                    initializeCharts();
                }
            }, 100);
        }
    });
</script>
{% endblock %}