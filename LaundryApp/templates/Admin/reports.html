{% extends "../home.html" %}
{% load static %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --primary: #4f46e5;
        --primary-light: #e0e7ff;
        --secondary: #ec4899;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #3b82f6;
        --light-bg: #f8fafc;
        --card-bg: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border: #e2e8f0;
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    body {
        background-color: var(--light-bg);
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
    }

    .dashboard-card {
        background-color: var(--card-bg);
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        transition: all 0.3s ease;
    }

    .dashboard-card:hover {
        box-shadow: var(--shadow-hover);
        transform: translateY(-2px);
    }

    .chart-container {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
    }

    .filter-section {
        background-color: var(--card-bg);
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
    }

    .section-title {
        color: var(--text-primary);
        border-left: 4px solid var(--primary);
        padding-left: 12px;
        margin-bottom: 20px;
        font-weight: 600;
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .stat-value {
        color: var(--text-primary);
        font-weight: 700;
        font-size: 24px;
        margin: 8px 0 4px;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-description {
        color: var(--text-secondary);
        font-size: 12px;
    }

    .btn-primary {
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 16px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background-color: #4338ca;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background-color: white;
        color: var(--text-primary);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px 16px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        background-color: #f1f5f9;
    }

    input,
    select {
        background-color: white;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px 12px;
        color: var(--text-primary);
        transition: all 0.3s ease;
    }

    input:focus,
    select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .customer-item {
        background-color: #f8fafc;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 8px;
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }

    .customer-item:hover {
        background-color: #f1f5f9;
        border-color: var(--border);
    }

    .customer-rank {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
    }

    .scroll-container {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 transparent;
    }

    .scroll-container::-webkit-scrollbar {
        width: 6px;
    }

    .scroll-container::-webkit-scrollbar-track {
        background: transparent;
    }

    .scroll-container::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 3px;
    }

    /* Ensure charts have white backgrounds */
    canvas {
        background-color: white !important;
        border-radius: 8px;
        padding: 10px;
    }

    /* Status badges */
    .status-badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-pending {
        background-color: #fef3c7;
        color: #92400e;
    }

    .status-completed {
        background-color: #d1fae5;
        color: #065f46;
    }

    .status-partial {
        background-color: #dbeafe;
        color: #1e40af;
    }

    .status-overdue {
        background-color: #fee2e2;
        color: #991b1b;
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main" class="min-h-screen p-6">
    <!-- Dashboard Header -->
    <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
            <i class="fas fa-chart-line" style="color: var(--primary);"></i>
            Business Dashboard
        </h1>
    </div>

    <!-- Date Range Filter Section -->
    <div class="filter-section p-4 mb-6">
        <form method="get" id="filterForm" class="flex items-center gap-4 flex-wrap">
            <!-- Year Input -->
            <div class="flex items-center gap-2">
                <label for="year" class="text-sm font-medium text-gray-700 whitespace-nowrap">Year:</label>
                <input type="number" id="year" name="year" value="{{ selected_year }}" min="2020" max="2100"
                    class="w-24">
            </div>

            <!-- Month Selector -->
            <div class="flex items-center gap-2">
                <label for="month" class="text-sm font-medium text-gray-700 whitespace-nowrap">Month:</label>
                <input type="month" id="month" name="month"
                    value="{% if selected_month %}{{ selected_year }}-{{ selected_month|stringformat:'02d' }}{% endif %}">
            </div>
            <!-- Date Range -->
            <div class="flex items-center gap-2">
                <label for="from_date" class="text-sm font-medium text-gray-700 whitespace-nowrap">From:</label>
                <input type="date" id="from_date" name="from_date" value="{% if from_date %}{{ from_date }}{% endif %}">
            </div>
            <div class="flex items-center gap-2">
                <label for="to_date" class="text-sm font-medium text-gray-700 whitespace-nowrap">To:</label>
                <input type="date" id="to_date" name="to_date" value="{% if to_date %}{{ to_date }}{% endif %}">
            </div>

            <div class="flex gap-2 ml-auto">
                <button type="submit" class="btn-primary flex items-center gap-2">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
                <button type="button" id="resetFilters" class="btn-secondary flex items-center gap-2">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>
        </form>
    </div>

    <!-- Overall Stats -->
    <h2 class="section-title text-xl flex items-center gap-2">
        <i class="fas fa-store" style="color: var(--primary);"></i> General
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- Total Revenue -->
        <div class="dashboard-card p-4 border-t-4" style="border-top-color: var(--success);">
            <div class="flex items-center justify-between mb-4">
                <div class="stat-icon" style="background-color: var(--primary-light); color: var(--success);">
                    <i class="fas fa-wallet"></i>
                </div>
            </div>
            <div>
                <div class="stat-label">Total Revenue</div>
                <div class="stat-value">Ksh {{total_revenue|floatformat:2|default:"0.00" }}</div>
                <div class="stat-description">Total earnings</div>
            </div>
        </div>

        <!-- Total Orders -->
        <div class="dashboard-card p-4 border-t-4" style="border-top-color: var(--primary);">
            <div class="flex items-center justify-between mb-4">
                <div class="stat-icon" style="background-color: var(--primary-light); color: var(--primary);">
                    <i class="fas fa-shopping-bag"></i>
                </div>
            </div>
            <div>
                <div class="stat-label">Total Orders</div>
                <div class="stat-value">{{ total_orders }}</div>
                <div class="stat-description">All time orders</div>
            </div>
        </div>

        <!-- Pending Orders -->
        <div class="dashboard-card p-4 border-t-4" style="border-top-color: var(--warning);">
            <div class="flex items-center justify-between mb-4">
                <div class="stat-icon" style="background-color: #fef3c7; color: var(--warning);">
                    <i class="fas fa-clock"></i>
                </div>
            </div>
            <div>
                <div class="stat-label">Pending Orders</div>
                <div class="stat-value">{{ pending_orders }}</div>
                <div class="stat-description">Awaiting processing</div>
            </div>
        </div>

        <!-- Completed Orders -->
        <div class="dashboard-card p-4 border-t-4" style="border-top-color: var(--info);">
            <div class="flex items-center justify-between mb-4">
                <div class="stat-icon" style="background-color: #dbeafe; color: var(--info);">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
            <div>
                <div class="stat-label">Completed Orders</div>
                <div class="stat-value">{{ completed_orders }}</div>
                <div class="stat-description">Successfully delivered</div>
            </div>
        </div>
    </div>

    <!-- Shop A Stats -->
    <div class="mb-8">
        <h2 class="section-title text-xl flex items-center gap-2">
            <i class="fas fa-store" style="color: var(--primary);"></i> Shop A
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Shop A Revenue -->
            <div class="dashboard-card p-4 border-t-4" style="border-top-color: var(--success);">
                <div class="flex items-center justify-between mb-4">
                    <div class="stat-icon" style="background-color: var(--primary-light); color: var(--success);">
                        <i class="fas fa-wallet"></i>
                    </div>
                </div>
                <div>
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value">Ksh {{ shop_a_revenue|floatformat:2|default:"0.00" }}</div>
                    <div class="stat-description">Shop A earnings</div>
                </div>
            </div>

            <!-- Shop A Orders -->
            <div class="dashboard-card p-4 border-t-4" style="border-top-color: var(--primary);">
                <div class="flex items-center justify-between mb-4">
                    <div class="stat-icon" style="background-color: var(--primary-light); color: var(--primary);">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                </div>
                <div>
                    <div class="stat-label">Order Statistics</div>
                    <div class="stat-value">{{ shop_a_total_orders }}</div>
                    <div class="flex gap-2 mt-1">
                        <span class="status-badge status-pending">{{ shop_a_pending_orders }} pending</span>
                        <span class="status-badge status-completed">{{ shop_a_completed_orders }} completed</span>
                    </div>
                </div>
            </div>

            <!-- Shop A Payments -->
            <div class="dashboard-card p-4 border-t-4" style="border-top-color: #3730a3;">
                <div class="flex items-center justify-between mb-4">
                    <div class="stat-icon" style="background-color: #e0e7ff; color: #3730a3;">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                </div>
                <div>
                    <div class="stat-label">Payments</div>
                    <div class="flex flex-wrap gap-1 mt-2">
                        <span class="status-badge status-pending">{{ shop_a_pending_payments }} pending</span>
                        <span class="status-badge status-partial">{{ shop_a_partial_payments }} partial</span>
                        <span class="status-badge status-completed">{{ shop_a_complete_payments }} completed</span>
                        {% if shop_a_overdue_orders_list %}
                        <span class="status-badge status-overdue">{{ shop_a_overdue_orders_list|length }} overdue</span>
                        {% endif %}
                    </div>
                    <div class="stat-description mt-2">
                        Ksh {{ shop_a_stats.total_collected_amount|default:0 }} collected •
                        Ksh {{ shop_a_stats.total_pending_amount|default:0 }} pending
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shop B Stats -->
    <div class="mb-8">
        <h2 class="section-title text-xl flex items-center gap-2">
            <i class="fas fa-store" style="color: var(--warning);"></i> Shop B Performance
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Shop B Revenue -->
            <div class="dashboard-card p-4 border-t-4" style="border-top-color: var(--success);">
                <div class="flex items-center justify-between mb-4">
                    <div class="stat-icon" style="background-color: var(--primary-light); color: var(--success);">
                        <i class="fas fa-wallet"></i>
                    </div>
                </div>
                <div>
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value">Ksh {{shop_b_revenue|floatformat:2|default:"0.00" }}</div>
                    <div class="stat-description">Shop B earnings</div>
                </div>
            </div>

            <!-- Shop B Orders -->
            <div class="dashboard-card p-4 border-t-4" style="border-top-color: var(--primary);">
                <div class="flex items-center justify-between mb-4">
                    <div class="stat-icon" style="background-color: var(--primary-light); color: var(--primary);">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                </div>
                <div>
                    <div class="stat-label">Order Statistics</div>
                    <div class="stat-value">{{ shop_b_total_orders }}</div>
                    <div class="flex gap-2 mt-1">
                        <span class="status-badge status-pending">{{ shop_b_pending_orders }} pending</span>
                        <span class="status-badge status-completed">{{ shop_b_completed_orders }} completed</span>
                    </div>
                </div>
            </div>

            <!-- Shop B Payments -->
            <div class="dashboard-card p-4 border-t-4" style="border-top-color: #3730a3;">
                <div class="flex items-center justify-between mb-4">
                    <div class="stat-icon" style="background-color: #e0e7ff; color: #3730a3;">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                </div>
                <div>
                    <div class="stat-label">Payments</div>
                    <div class="flex flex-wrap gap-1 mt-2">
                        <span class="status-badge status-pending">{{ shop_b_pending_payments }} pending</span>
                        <span class="status-badge status-partial">{{ shop_b_partial_payments }} partial</span>
                        <span class="status-badge status-completed">{{ shop_b_complete_payments }} completed</span>
                        {% if shop_b_overdue_orders_list %}
                        <span class="status-badge status-overdue">{{ shop_b_overdue_orders_list|length }} overdue</span>
                        {% endif %}
                    </div>
                    <div class="stat-description mt-2">
                        Ksh {{ shop_b_stats.total_collected_amount|default:0 }} collected •
                        Ksh {{ shop_b_stats.total_pending_amount|default:0 }} pending
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Revenue Distribution -->
        <div class="chart-container">
            <div class="flex justify-between items-center mb-6">
                <h4 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-chart-pie" style="color: var(--warning);"></i>
                    Revenue Distribution
                </h4>
                <span class="status-badge" style="background-color: #fef3c7; color: #92400e;">Total</span>
            </div>
            <div class="h-64">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Revenue Trend -->
        <div class="chart-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-chart-line" style="color: var(--primary);"></i>
                    Revenue Trend
                </h2>
                <span class="status-badge" style="background-color: #e0e7ff; color: var(--primary);">{{ selected_year
                    }}</span>
            </div>
            <div class="h-64">
                {% if not selected_month %}
                <canvas id="trendChart"></canvas>
                {% else %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-calendar-week text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Switch to yearly view</h3>
                    <p class="text-gray-500">Monthly trends are available in the annual overview</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Insights Section -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Top Services -->
        <div class="chart-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-spa" style="color: var(--success);"></i>
                    Top Services
                </h2>
                <span class="status-badge" style="background-color: #d1fae5; color: #065f46;">{{ selected_year }}</span>
            </div>
            <div class="h-72">
                {% if services_labels and services_labels|length > 0 %}
                <canvas id="servicesChart"></canvas>
                {% else %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-concierge-bell text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">No service data available</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Popular Products -->
        <div class="chart-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-box-open" style="color: var(--warning);"></i>
                    Common Items
                </h2>
                <span class="status-badge" style="background-color: #fef3c7; color: #92400e;">{{ selected_year }}</span>
            </div>
            <div class="h-72">
                {% if item_labels and item_labels|length > 0 %}
                <canvas id="productsChart"></canvas>
                {% else %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-box text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">No product data available</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- VIP Customers -->
        <div class="chart-container">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-crown" style="color: var(--warning);"></i>
                    Top Customers
                </h2>
                <span class="status-badge" style="background-color: #fef3c7; color: #92400e;">{{ selected_year }}</span>
            </div>
            <div class="h-72 scroll-container overflow-y-auto">
                {% for customer in common_customers %}
                <div class="customer-item flex items-center">
                    <div class="customer-rank mr-3">
                        {{ forloop.counter }}
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">{{ customer.customer__name }}</div>
                        <div class="text-sm text-gray-500">{{ customer.order_count }} orders</div>
                    </div>
                    <div class="font-bold" style="color: var(--primary);">
                        ksh{{ customer.total_spent|floatformat:2 }}
                    </div>
                </div>
                {% empty %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-user-slash text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">No customer data available</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    // Date Range Filter Functionality
    document.addEventListener('DOMContentLoaded', function () {
        const filterForm = document.getElementById('filterForm');
        const resetButton = document.getElementById('resetFilters');

        // Set today's date as max for date inputs
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('from_date').max = today;
        document.getElementById('to_date').max = today;

        // Reset filters functionality
        resetButton.addEventListener('click', function () {
            // Clear all filter inputs
            document.getElementById('year').value = new Date().getFullYear();
            document.getElementById('month').value = '';
            document.getElementById('from_date').value = '';
            document.getElementById('to_date').value = '';

            // Submit the form to reset filters
            filterForm.submit();
        });

        // Validate date range
        const fromDateInput = document.getElementById('from_date');
        const toDateInput = document.getElementById('to_date');

        fromDateInput.addEventListener('change', function () {
            if (this.value && toDateInput.value && this.value > toDateInput.value) {
                toDateInput.value = this.value;
            }
        });

        toDateInput.addEventListener('change', function () {
            if (this.value && fromDateInput.value && this.value < fromDateInput.value) {
                fromDateInput.value = this.value;
            }
        });

        // Auto-submit when year or month changes (optional)
        document.getElementById('year').addEventListener('change', function () {
            if (!fromDateInput.value && !toDateInput.value) {
                filterForm.submit();
            }
        });

        document.getElementById('month').addEventListener('change', function () {
            if (!fromDateInput.value && !toDateInput.value) {
                filterForm.submit();
            }
        });
    });

    // Chart initialization code
    function initializeCharts() {
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded');
            setTimeout(initializeCharts, 100);
            return;
        }

        const COLOR_PALETTE = {
            primary: '#4f46e5',
            secondary: '#ec4899',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            info: '#3b82f6',
            lightPrimary: '#818cf8',
            lightSecondary: '#f472b6'
        };

        function getChartOptions() {
            const textColor = '#1e293b';
            const tooltipBg = '#ffffff';
            const tooltipBorder = '#e2e8f0';
            const tooltipText = '#1e293b';

            return {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: {
                        labels: {
                            color: textColor,
                            font: {
                                size: 11,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: tooltipBg,
                        borderColor: tooltipBorder,
                        borderWidth: 1,
                        borderRadius: 12,
                        padding: 12,
                        titleColor: tooltipText,
                        bodyColor: tooltipText,
                        bodyFont: {
                            size: 14,
                            weight: '600'
                        },
                        titleFont: {
                            size: 12,
                            weight: '500'
                        },
                        callbacks: {
                            title: function (context) {
                                return context[0].label || '';
                            },
                            label: function (context) {
                                if (context.parsed.y !== undefined) {
                                    return context.parsed.y.toLocaleString('en-US');
                                } else if (context.parsed !== undefined) {
                                    return context.parsed.toLocaleString('en-US');
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: false,
                        grid: { display: false },
                        ticks: { color: textColor, font: { size: 11 } },
                        border: { display: false }
                    },
                    y: {
                        display: false,
                        grid: { display: false },
                        ticks: { color: textColor, font: { size: 11 } },
                        border: { display: false }
                    }
                }
            };
        }

        function safeJsonParse(jsonString, fallback = []) {
            try {
                if (!jsonString || jsonString === 'None' || jsonString === 'null' ||
                    jsonString === '""' || jsonString === "''") {
                    return fallback;
                }

                let parsedString = jsonString;
                if (typeof jsonString === 'string') {
                    parsedString = jsonString.replace(/None/g, 'null');
                    parsedString = parsedString.replace(/'/g, '"');
                }

                const parsed = JSON.parse(parsedString);
                return Array.isArray(parsed) ? parsed : fallback;
            } catch (error) {
                console.error('Error parsing JSON:', jsonString, error);
                return fallback;
            }
        }

        function sortDataDescending(labels, data) {
            const combined = labels.map((label, index) => ({
                label,
                value: data[index] || 0
            }));

            combined.sort((a, b) => b.value - a.value);

            const sortedLabels = combined.map(item => item.label);
            const sortedData = combined.map(item => item.value);

            return { sortedLabels, sortedData };
        }

        // Revenue Chart
        const revenueCanvas = document.getElementById('revenueChart');
        if (revenueCanvas) {
            const revenueLabels = safeJsonParse('{{ pie_chart_labels|safe }}');
            const revenueValues = safeJsonParse('{{ pie_chart_values|safe }}');

            if (revenueLabels.length > 0 && revenueValues.length > 0 &&
                revenueLabels.length === revenueValues.length) {

                const revenueCtx = revenueCanvas.getContext('2d');

                new Chart(revenueCtx, {
                    type: 'doughnut',
                    data: {
                        labels: revenueLabels,
                        datasets: [{
                            data: revenueValues,
                            backgroundColor: [
                                COLOR_PALETTE.primary,
                                COLOR_PALETTE.warning,
                                COLOR_PALETTE.lightPrimary,
                                COLOR_PALETTE.secondary,
                                COLOR_PALETTE.lightSecondary,
                                COLOR_PALETTE.success,
                                COLOR_PALETTE.info
                            ],
                            borderWidth: 0,
                            cutout: '70%',
                            spacing: 0,
                            hoverOffset: 4,
                            borderRadius: 0
                        }]
                    },
                    options: {
                        ...getChartOptions(),
                        plugins: {
                            ...getChartOptions().plugins,
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 10,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    boxWidth: 8,
                                    boxHeight: 8,
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn('No valid data for revenue chart');
                revenueCanvas.style.display = 'none';
                const message = document.createElement('div');
                message.className = 'flex flex-col items-center justify-center h-full text-center';
                message.innerHTML = '<i class="fas fa-chart-pie text-4xl text-gray-400 mb-4"></i><p class="text-gray-500">No revenue data available</p>';
                revenueCanvas.parentNode.appendChild(message);
            }
        }

        // Trend Chart
        const trendCanvas = document.getElementById('trendChart');
        if (trendCanvas) {
            const lineData = safeJsonParse('{{ line_chart_data|safe }}');

            if (lineData && lineData.length > 0 && lineData[0] && lineData[0].months) {
                const trendCtx = trendCanvas.getContext('2d');
                const lineColors = [
                    COLOR_PALETTE.primary,
                    COLOR_PALETTE.warning,
                    COLOR_PALETTE.secondary,
                    COLOR_PALETTE.success,
                    COLOR_PALETTE.info
                ];

                const datasets = lineData.map((series, index) => ({
                    label: series.label || `Series ${index + 1}`,
                    data: series.data || [],
                    borderColor: lineColors[index % lineColors.length],
                    backgroundColor: `${lineColors[index % lineColors.length]}20`,
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    pointBackgroundColor: lineColors[index % lineColors.length],
                    fill: true,
                    cubicInterpolationMode: 'monotone'
                }));

                new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: lineData[0].months,
                        datasets: datasets
                    },
                    options: {
                        ...getChartOptions(),
                        scales: {
                            x: {
                                display: true,
                                grid: { display: false },
                                ticks: {
                                    color: getChartOptions().scales.x.ticks.color,
                                    maxRotation: 0,
                                    padding: 10
                                }
                            },
                            y: {
                                display: false,
                                grid: { display: false }
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                });
            } else {
                console.warn('No valid data for trend chart');
                trendCanvas.style.display = 'none';
                const message = document.createElement('div');
                message.className = 'flex flex-col items-center justify-center h-full text-center';
                message.innerHTML = '<i class="fas fa-chart-line text-4xl text-gray-400 mb-4"></i><p class="text-gray-500">No trend data available</p>';
                trendCanvas.parentNode.appendChild(message);
            }
        }

        // Bar Charts
        const createBarChart = (id, labels, data, title) => {
            const canvas = document.getElementById(id);
            if (!canvas) return;

            if (labels.length > 0 && data.length > 0 && labels.length === data.length) {
                const { sortedLabels, sortedData } = sortDataDescending(labels, data);

                const ctx = canvas.getContext('2d');
                const barColors = [
                    COLOR_PALETTE.primary,
                    COLOR_PALETTE.warning,
                    COLOR_PALETTE.secondary,
                    COLOR_PALETTE.lightSecondary,
                    COLOR_PALETTE.success,
                    COLOR_PALETTE.info,
                    COLOR_PALETTE.lightPrimary
                ];

                const customTooltip = {
                    callbacks: {
                        title: function (context) {
                            return context[0].label || '';
                        },
                        label: function (context) {
                            if (id === 'servicesChart') {
                                return `${context.parsed.x.toLocaleString('en-US')} orders`;
                            }
                            return context.parsed.x.toLocaleString('en-US');
                        }
                    }
                };

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedLabels,
                        datasets: [{
                            data: sortedData,
                            backgroundColor: sortedLabels.map((_, index) => barColors[index % barColors.length]),
                            borderRadius: 8,
                            borderWidth: 0,
                            barThickness: 10,
                            categoryPercentage: 0.8,
                            barPercentage: 0.9
                        }]
                    },
                    options: {
                        ...getChartOptions(),
                        indexAxis: 'y',
                        plugins: {
                            ...getChartOptions().plugins,
                            legend: {
                                display: false
                            },
                            tooltip: id === 'productsChart' ? { enabled: false } : {
                                ...getChartOptions().plugins.tooltip,
                                callbacks: customTooltip.callbacks
                            }
                        },
                        scales: {
                            y: {
                                display: true,
                                grid: { display: false },
                                ticks: {
                                    color: getChartOptions().scales.x.ticks.color,
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    },
                                    padding: 8
                                }
                            },
                            x: {
                                display: true,
                                grid: { display: false },
                                ticks: {
                                    color: getChartOptions().scales.x.ticks.color,
                                    font: { size: 10 }
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn(`No valid data for ${title} chart`);
                canvas.style.display = 'none';
                const message = document.createElement('div');
                message.className = 'flex flex-col items-center justify-center h-full text-center';
                message.innerHTML = `<i class="fas ${id === 'servicesChart' ? 'fa-concierge-bell' : 'fa-box'} text-4xl text-gray-400 mb-4"></i><p class="text-gray-500">No ${title.toLowerCase()} data available</p>`;
                canvas.parentNode.appendChild(message);
            }
        };

        // Initialize bar charts
        createBarChart('servicesChart',
            safeJsonParse('{{ services_labels|safe }}'),
            safeJsonParse('{{ services_counts|safe }}'),
            'Services');

        createBarChart('productsChart',
            safeJsonParse('{{ item_labels|safe }}'),
            safeJsonParse('{{ item_counts|safe }}'),
            'Products');
    }

    // Initialize charts when DOM is loaded
    document.addEventListener("DOMContentLoaded", function () {
        if (typeof Chart !== 'undefined') {
            initializeCharts();
        } else {
            const checkChart = setInterval(function () {
                if (typeof Chart !== 'undefined') {
                    clearInterval(checkChart);
                    initializeCharts();
                }
            }, 100);
        }
    });
</script>
{% endblock %}