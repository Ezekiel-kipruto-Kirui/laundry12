{% extends "../home.html" %}
{% load static %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div id="content-main" class="min-h-screen p-4 md:p-6 bg-gradient-to-br from-gray-50 to-gray-100">
    <!-- Dashboard Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
        <div class="flex items-center gap-3 mb-4 md:mb-0">
            <div class="w-2 h-8 bg-gradient-to-b from-blue-500 to-purple-600 rounded-full"></div>
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Business Dashboard</h1>
                <p class="text-gray-500 text-sm mt-1">Monitor your business performance</p>
            </div>
        </div>
        <div class="flex items-center gap-3 bg-white rounded-xl px-4 py-3 shadow-sm border border-gray-100">
            <i class="fas fa-calendar-alt text-blue-500"></i>
            <span class="font-semibold text-gray-700">{{ current_year }}</span>
            {% if selected_month %}
            <span class="font-semibold text-gray-500">- Month {{ selected_month }}</span>
            {% endif %}
        </div>
    </div>

    <!-- Date Range Filter Section -->
    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 mb-8">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Filter Data</h2>
        <form method="get" id="filterForm" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
            <!-- Year Input -->
            <div>
                <label for="year" class="block text-sm font-medium text-gray-700 mb-2">Year</label>
                <input type="number" id="year" name="year" value="{{ current_year }}" min="2020" max="2100"
                    class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-2.5 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
            </div>

            <!-- Month Selector -->
            <div>
                <label for="month" class="block text-sm font-medium text-gray-700 mb-2">Month</label>
                <input type="month" id="month" name="month"
                    value="{% if selected_month %}{{ current_year }}-{{ selected_month|stringformat:'02d' }}{% endif %}"
                    class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-2.5 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
            </div>

            <!-- Date Range -->
            <div>
                <label for="from_date" class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                <input type="date" id="from_date" name="from_date" value="{% if from_date %}{{ from_date }}{% endif %}"
                    class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-2.5 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
            </div>

            <div>
                <label for="to_date" class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                <input type="date" id="to_date" name="to_date" value="{% if to_date %}{{ to_date }}{% endif %}"
                    class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-2.5 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
            </div>

            <div class="flex gap-3">
                <button type="submit"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg font-medium transition-all duration-300 flex items-center justify-center gap-2">
                    <i class="fas fa-filter"></i> Apply
                </button>
                <button type="button" id="resetFilters"
                    class="flex-1 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-4 py-2.5 rounded-lg font-medium transition-all duration-300 flex items-center justify-center gap-2">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>
        </form>
    </div>

    <!-- Overall Business Stats -->
    <div class="mb-8">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-1 h-6 bg-gradient-to-b from-blue-500 to-purple-600 rounded-full"></div>
            <h2 class="text-xl font-bold text-gray-900">Business Overview</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-5">
            <!-- Total Business Revenue -->
            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center">
                        <i class="fas fa-wallet text-blue-600"></i>
                    </div>
                    <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full">Total</span>
                </div>
                <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-1">Total Revenue</h3>
                <div class="text-xl font-bold text-gray-900 mb-1">Ksh {{ total_business_revenue|floatformat:2|default:"0.00" }}</div>
                <div class="flex items-center text-xs text-gray-500">
                    <i class="fas fa-trend-up text-green-500 mr-1"></i>
                    <span>Combined earnings</span>
                </div>
            </div>

            <!-- Total Orders -->
           
            <!-- Net Profit -->
            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center">
                        <i class="fas fa-chart-line text-purple-600"></i>
                    </div>
                    <span
                        class="bg-purple-100 text-purple-800 text-xs font-semibold px-2 py-1 rounded-full">Profit</span>
                </div>
                <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-1">Net Profit</h3>
                <div class="text-xl font-bold text-gray-900 mb-1">Ksh {{ total_net_profit|floatformat:2 }}</div>
                <div class="flex items-center text-xs text-gray-500">
                    <i class="fas fa-dollar-sign text-purple-500 mr-1"></i>
                    <span>After expenses</span>
                </div>
            </div>

            <!-- Total Expenses -->
            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-lg bg-red-50 flex items-center justify-center">
                        <i class="fas fa-money-bill-wave text-red-600"></i>
                    </div>
                    <span class="bg-red-100 text-red-800 text-xs font-semibold px-2 py-1 rounded-full">Expenses</span>
                </div>
                <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-1">Total Expenses</h3>
                <div class="text-xl font-bold text-gray-900 mb-1">Ksh {{ total_business_expenses|floatformat:2 }}</div>
                <div class="flex items-center text-xs text-gray-500">
                    <i class="fas fa-chart-line text-red-500 mr-1"></i>
                    <span>Combined expenses</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Business Comparison Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Revenue Comparison Chart -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 lg:col-span-2">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-chart-pie text-purple-500"></i>
                    Revenue Comparison
                </h2>
                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-semibold">{{ current_year }}</span>
            </div>
            <div class="h-64">
                <canvas id="revenueComparisonChart"></canvas>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <div class="text-center p-3 bg-blue-50 rounded-lg border border-blue-100">
                    <div class="text-sm font-semibold text-blue-700">Laundry Business</div>
                    <div class="text-lg font-bold text-blue-900">Ksh {{ laundry_revenue|floatformat:2 }}</div>
                </div>
                <div class="text-center p-3 bg-red-50 rounded-lg border border-red-100">
                    <div class="text-sm font-semibold text-red-700">Hotel Business</div>
                    <div class="text-lg font-bold text-red-900">Ksh {{ hotel_revenue|floatformat:2 }}</div>
                </div>
            </div>
        </div>

        <!-- Hotel Business Stats -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-2 h-6 bg-gradient-to-b from-red-500 to-orange-600 rounded-full"></div>
                    <h2 class="text-lg font-bold text-gray-900">Hotel Business</h2>
                </div>
                <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-semibold">Active</span>
            </div>

            <div class="space-y-4">
                <!-- Hotel Revenue -->
                <div class="bg-gradient-to-br from-red-50 to-orange-50 rounded-lg p-4 border border-red-100">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 rounded-lg bg-red-100 flex items-center justify-center">
                            <i class="fas fa-wallet text-red-600"></i>
                        </div>
                        <span class="text-sm font-semibold text-gray-700">Revenue</span>
                    </div>
                    <div class="text-xl font-bold text-gray-900 mb-1">Ksh {{ hotel_total_revenue|floatformat:2 }}</div>
                    <div class="text-xs text-gray-500">Hotel earnings</div>
                </div>

                <!-- Hotel Orders -->
                <div class="bg-gradient-to-br from-orange-50 to-yellow-50 rounded-lg p-4 border border-orange-100">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 rounded-lg bg-orange-100 flex items-center justify-center">
                            <i class="fas fa-utensils text-orange-600"></i>
                        </div>
                        <span class="text-sm font-semibold text-gray-700">Orders</span>
                    </div>
                    <div class="text-xl font-bold text-gray-900 mb-1">{{ hotel_total_orders }}</div>
                    <div class="flex flex-col gap-1 text-xs">
                        <span class="text-blue-600">{{ hotel_in_progress_orders }} in progress</span>
                        <span class="text-green-600">{{ hotel_served_orders }} served</span>
                    </div>
                </div>

                <!-- Hotel Profit -->
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 border border-green-100">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center">
                            <i class="fas fa-chart-line text-green-600"></i>
                        </div>
                        <span class="text-sm font-semibold text-gray-700">Profit & Expenses</span>
                    </div>
                    <div class="flex flex-col gap-2">
                        <div>
                            <div class="text-lg font-bold text-green-600">Ksh {{ hotel_net_profit|floatformat:2 }}</div>
                            <div class="text-xs text-gray-500">Net Profit</div>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-blue-600">Ksh {{ hotel_total_expenses|floatformat:2 }}
                            </div>
                            <div class="text-xs text-gray-500">Expenses</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Laundry Business Section -->
    <div class="mb-8">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-1 h-6 bg-gradient-to-b from-blue-500 to-cyan-600 rounded-full"></div>
            <h2 class="text-xl font-bold text-gray-900">Laundry Business</h2>
        </div>

        <!-- Laundry Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
            <!-- Laundry Revenue & Payment Methods -->
            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center">
                        <i class="fas fa-wallet text-blue-600"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Revenue</h3>
                        <div class="text-xl font-bold text-gray-900">Ksh {{ laundry_revenue|floatformat:2 }}</div>
                    </div>
                </div>

                <div class="border-t border-gray-100 pt-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-3">Payment Methods</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-money-bill-wave text-green-600 text-sm"></i>
                                <span class="text-sm text-gray-700">Cash</span>
                            </div>
                            <span class="text-sm font-bold text-gray-900">Ksh {{ cash_payments_amount|floatformat:0 }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-mobile-alt text-blue-600 text-sm"></i>
                                <span class="text-sm text-gray-700">M-Pesa</span>
                            </div>
                            <span class="text-sm font-bold text-gray-900">Ksh {{ mpesa_payments_amount|floatformat:0 }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-credit-card text-purple-600 text-sm"></i>
                                <span class="text-sm text-gray-700">Card</span>
                            </div>
                            <span class="text-sm font-bold text-gray-900">Ksh {{ card_payments_amount|floatformat:0 }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-university text-indigo-600 text-sm"></i>
                                <span class="text-sm text-gray-700">Bank</span>
                            </div>
                            <span class="text-sm font-bold text-gray-900">Ksh {{ bank_transfer_payments_amount|floatformat:0 }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-ellipsis-h text-gray-600 text-sm"></i>
                                <span class="text-sm text-gray-700">Other</span>
                            </div>
                            <span class="text-sm font-bold text-gray-900">Ksh {{ other_payments_amount|floatformat:0 }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Status -->
            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-yellow-50 flex items-center justify-center">
                        <i class="fas fa-credit-card text-yellow-600"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Payments & Balance</h3>
                        <div class="text-xl font-bold text-gray-900">{{ total_balance_amount|floatformat:2 }}</div>
                    </div>
                </div>
                <div class="space-y-3 mt-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">{{ pending_payments}}</span>
                            <span class="text-sm text-gray-700">Pending Payment</span>
                            </div>
                            
                            
                            
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">{{ total_pending_amount}}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">{{ partial_payments }}</span>
                            <span class="text-sm text-gray-700">Partial Payment</span>
                            </div>
                            
                            
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">{{ total_partial_amount }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">{{ complete_payments }}</span>
                            <span class="text-sm text-gray-700">Complete Payment</span>
                            </div>
                            
                            
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">{{ total_complete_amount }}</span>
                    </div>
                </div>
            </div>

            <!-- Laundry Expenses -->
            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-red-50 flex items-center justify-center">
                            <i class="fas fa-money-bill-wave text-red-600"></i>
                        </div>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Laundry Expenses</h3>
                            <div class="text-xl font-bold text-gray-900">Ksh {{ total_expenses|floatformat:2 }}</div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center text-sm text-gray-500 mt-4">
                    <i class="fas fa-chart-line text-red-500 mr-1"></i>
                    <span>Operational costs</span>
                </div>
            </div>
        </div>

        <!-- Shop Performance Section -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <!-- Shop A Stats -->
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-6 bg-gradient-to-b from-pink-500 to-purple-600 rounded-full"></div>
                        <h2 class="text-lg font-bold text-gray-900">Shop A Performance</h2>
                    </div>
                    <span class="bg-pink-100 text-pink-800 px-3 py-1 rounded-full text-sm font-semibold">Active</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Shop A Revenue -->
                    <div class="bg-gradient-to-br from-pink-50 to-purple-50 rounded-lg p-4 border border-pink-100">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-8 h-8 rounded-lg bg-pink-100 flex items-center justify-center">
                                <i class="fas fa-wallet text-pink-600"></i>
                            </div>
                            <span class="text-sm font-semibold text-gray-700">Revenue</span>
                        </div>
                        <div class="text-lg font-bold text-gray-900 mb-1">Ksh
                            {{shop_a_revenue|floatformat:2|default:"0.00"}}</div>
                        <div class="text-xs text-gray-500">Shop A earnings</div>
                    </div>

                    <!-- Shop A Orders -->
                    <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg p-4 border border-blue-100">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                                <i class="fas fa-shopping-bag text-blue-600"></i>
                            </div>
                            <span class="text-sm font-semibold text-gray-700">Orders</span>
                        </div>
                        <div class="text-lg font-bold text-gray-900 mb-1">{{ shop_a_total_orders }}</div>
                        <!-- <div class="flex flex-col gap-1 text-xs">
                            <span class="text-yellow-600">{{ shop_a_pending_orders }} pending</span>
                            <span class="text-green-600">{{ shop_a_completed_orders }} completed</span>
                        </div> -->
                    </div>

                    <!-- Shop A Payments -->
                    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-lg p-4 border border-purple-100">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center">
                                <i class="fas fa-credit-card text-purple-600"></i>
                            </div>
                            <span class="text-sm font-semibold text-gray-700">Payments</span>
                        </div>
                        <div class="text-lg font-bold text-gray-900 mb-1">{{ shop_a_total_orders }}</div>
                        <div class="flex flex-col gap-1 text-xs">
                            <div class="flex flex-row justify-between">
                            <span class="text-yellow-600">{{ shop_a_pending_payments }} pending</span>
                            <span class="text-yellow-600">Ksh {{ shop_a_pending_amount }}</span>
                            </div>
                            <div class="flex flex-row justify-between">
                            <span class="text-blue-600">{{ shop_a_partial_payments }} partial</span>
                            <span class="text-blue-600">Ksh {{ shop_a_partial_amount }}</span>
                            </div>
                            <div class="flex flex-row justify-between">
                            <span class="text-green-600">{{ shop_a_complete_payments }} complete</span>
                            <span class="text-green-600">Ksh {{ shop_a_complete_amount }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Shop A Profit -->
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 border border-green-100">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center">
                                <i class="fas fa-chart-line text-green-600"></i>
                            </div>
                            <span class="text-sm font-semibold text-gray-700">Profit & Expenses</span>
                        </div>
                        <div class="flex flex-col gap-2">
                            <div>
                                <div class="text-md font-bold text-green-600">Ksh {{ shop_a_net_profit|floatformat:2 }}
                                </div>
                                <div class="text-xs text-gray-500">Profit</div>
                            </div>
                            <div>
                            
                                <div class="text-md font-bold text-blue-600">Ksh {{ shop_a_total_expenses|floatformat:2 }}</div>
                                <div class="text-xs text-gray-500">Expenses</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shop B Stats -->
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-6 bg-gradient-to-b from-yellow-500 to-orange-600 rounded-full"></div>
                        <h2 class="text-lg font-bold text-gray-900">Shop B Performance</h2>
                    </div>
                    <span
                        class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-semibold">Active</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Shop B Revenue -->
                    <div class="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-lg p-4 border border-yellow-100">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-8 h-8 rounded-lg bg-yellow-100 flex items-center justify-center">
                                <i class="fas fa-wallet text-yellow-600"></i>
                            </div>
                            <span class="text-sm font-semibold text-gray-700">Revenue</span>
                        </div>
                        <div class="text-lg font-bold text-gray-900 mb-1">Ksh
                            {{shop_b_revenue|floatformat:2|default:"0.00"}}</div>
                        <div class="text-xs text-gray-500">Shop B earnings</div>
                    </div>

                    <!-- Shop B Orders -->
                    <div class="bg-gradient-to-br from-orange-50 to-red-50 rounded-lg p-4 border border-orange-100">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-8 h-8 rounded-lg bg-orange-100 flex items-center justify-center">
                                <i class="fas fa-shopping-bag text-orange-600"></i>
                            </div>
                            <span class="text-sm font-semibold text-gray-700">Orders</span>
                        </div>
                        <div class="text-lg font-bold text-gray-900 mb-1">{{ shop_b_total_orders }}</div>
                        <!-- <div class="flex flex-col gap-1 text-xs">
                            <span class="text-yellow-600">{{ shop_b_pending_orders }} pending</span>
                            <span class="text-green-600">{{ shop_b_completed_orders }} completed</span>
                        </div> -->
                    </div>

                    <!-- Shop B Payments -->
                    <div class="bg-gradient-to-br from-red-50 to-pink-50 rounded-lg p-4 border border-red-100">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-8 h-8 rounded-lg bg-red-100 flex items-center justify-center">
                                <i class="fas fa-credit-card text-red-600"></i>
                            </div>
                            <span class="text-sm font-semibold text-gray-700">Payments</span>
                        </div>
                        <div class="text-lg font-bold text-gray-900 mb-1">{{ shop_b_total_orders }}</div>
                        <div class="flex flex-col gap-1 text-xs">
                            <div class="flex flex-row justify-between">
                            <span class="text-yellow-600">{{ shop_b_pending_payments }} pending</span>
                            <span class="text-yellow-600">Ksh{{ shop_b_pending_amount }}</span>
                            </div>
                            <div class="flex flex-row justify-between">
                            <span class="text-blue-600">{{ shop_b_partial_payments }} partial</span>
                            <span class="text-blue-600">Ksh{{ shop_b_partial_amount }} </span>
                            </div>
                            <div class="flex flex-row justify-between">
                            <span class="text-green-600">{{ shop_b_complete_payments }} complete</span>
                            <span class="text-green-600">Ksh{{ shop_b_complete_amount }} </span>
                            </div>
                        </div>
                    </div>

                    <!-- Shop B Profit -->
                    <div class="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-lg p-4 border border-emerald-100">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                                <i class="fas fa-chart-line text-emerald-600"></i>
                            </div>
                            <span class="text-sm font-semibold text-gray-700">Profit & Expenses</span>
                        </div>
                        <div class="flex flex-col gap-2">
                            <div>
                                <div class="text-md font-bold text-green-600">Ksh {{ shop_b_net_profit|floatformat:2 }}
                                </div>
                                <div class="text-xs text-gray-500">Profit</div>
                            </div>
                            <div>
                                <div class="text-md font-bold text-blue-600">Ksh {{ shop_b_total_expenses|floatformat:2 }}</div>
                                <div class="text-xs text-gray-500">Expenses</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Revenue Distribution -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-6">
                <h4 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-chart-pie text-yellow-500"></i>
                    Revenue Distribution
                </h4>
                <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-semibold">Total</span>
            </div>
            <div class="h-64">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Revenue Trend -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-chart-line text-pink-500"></i>
                    Revenue Trend
                </h2>
                <span class="bg-pink-100 text-pink-800 px-3 py-1 rounded-full text-sm font-semibold">{{ current_year }}</span>
            </div>
            <div class="h-64">
                {% if not selected_month %}
                <canvas id="trendChart"></canvas>
                {% else %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-calendar-week text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Switch to yearly view</h3>
                    <p class="text-gray-500">Monthly trends are available in the annual overview</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Analytics Section -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Top Services -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-spa text-green-500"></i>
                    Top Services
                </h2>
                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">{{ current_year }}</span>
            </div>
            <div class="h-72">
                {% if services_labels and services_labels|length > 0 %}
                <canvas id="servicesChart"></canvas>
                {% else %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-concierge-bell text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">No service data available</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Popular Products -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-box-open text-yellow-500"></i>
                    Common Items
                </h2>
                <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-semibold">{{ current_year }}</span>
            </div>
            <div class="h-72">
                {% if item_labels and item_labels|length > 0 %}
                <canvas id="productsChart"></canvas>
                {% else %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-box text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">No product data available</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- VIP Customers -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-crown text-yellow-500"></i>
                    Top Customers
                </h2>
                <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-semibold">{{ current_year }}</span>
            </div>
            <div class="h-72 overflow-y-auto pr-2">
                {% for customer in common_customers %}
                <div class="flex items-center p-4 bg-gray-50 rounded-lg mb-3 border border-gray-100">
                    <div
                        class="w-10 h-10 rounded-lg bg-gradient-to-br from-pink-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm mr-4">
                        {{ forloop.counter }}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold text-gray-900 truncate">{{ customer.customer__name }}</div>
                        <div class="text-xs text-gray-500">{{ customer.order_count }} orders</div>
                    </div>
                    <div class="font-bold text-pink-600 text-lg">
                        ksh{{ customer.total_spent|floatformat:2 }}
                    </div>
                </div>
                {% empty %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-user-slash text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">No customer data available</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    // Date Range Filter Functionality
    document.addEventListener('DOMContentLoaded', function () {
        const filterForm = document.getElementById('filterForm');
        const resetButton = document.getElementById('resetFilters');

        // Set today's date as max for date inputs
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('from_date').max = today;
        document.getElementById('to_date').max = today;

        // Reset filters functionality
        resetButton.addEventListener('click', function () {
            // Clear all filter inputs
            document.getElementById('year').value = new Date().getFullYear();
            document.getElementById('month').value = '';
            document.getElementById('from_date').value = '';
            document.getElementById('to_date').value = '';

            // Submit the form to reset filters
            filterForm.submit();
        });

        // Validate date range
        const fromDateInput = document.getElementById('from_date');
        const toDateInput = document.getElementById('to_date');

        fromDateInput.addEventListener('change', function () {
            if (this.value && toDateInput.value && this.value > toDateInput.value) {
                toDateInput.value = this.value;
            }
        });

        toDateInput.addEventListener('change', function () {
            if (this.value && fromDateInput.value && this.value < fromDateInput.value) {
                fromDateInput.value = this.value;
            }
        });

        // Auto-submit when year or month changes (optional)
        document.getElementById('year').addEventListener('change', function () {
            if (!fromDateInput.value && !toDateInput.value) {
                filterForm.submit();
            }
        });

        document.getElementById('month').addEventListener('change', function () {
            if (!fromDateInput.value && !toDateInput.value) {
                filterForm.submit();
            }
        });
    });

    // Chart initialization code
    function initializeCharts() {
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded');
            setTimeout(initializeCharts, 100);
            return;
        }

        const COLOR_PALETTE = {
            navyBlue: '#1E3A8A',
            orangeYellow: '#F59E0B',
            lightOrange: '#FBBF24',
            pink: '#EC407A',
            lightPink: '#F48FB1',
            success: '#10B981',
            warning: '#F59E0B',
            danger: '#EF4444',
            info: '#3B82F6',
            blue: '#36A2EB',
            red: '#FF6384',
            teal: '#4BC0C0'
        };

        function getChartOptions() {
            const textColor = '#1E293B';
            const tooltipBg = '#FFFFFF';
            const tooltipBorder = '#E2E8F0';
            const tooltipText = '#1E293B';

            return {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: {
                        labels: {
                            color: textColor,
                            font: {
                                size: 11,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: tooltipBg,
                        borderColor: tooltipBorder,
                        borderWidth: 1,
                        borderRadius: 12,
                        padding: 12,
                        titleColor: tooltipText,
                        bodyColor: tooltipText,
                        bodyFont: {
                            size: 14,
                            weight: '600'
                        },
                        titleFont: {
                            size: 12,
                            weight: '500'
                        },
                        callbacks: {
                            title: (context) => {
                                return context[0].label || '';
                            },
                            label: function (context) {
                                if (context.parsed.y !== undefined) {
                                    return 'Ksh ' + context.parsed.y.toLocaleString('en-US');
                                } else if (context.parsed !== undefined) {
                                    return 'Ksh ' + context.parsed.toLocaleString('en-US');
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: false,
                        grid: { display: false },
                        ticks: { color: textColor, font: { size: 11 } },
                        border: { display: false }
                    },
                    y: {
                        display: false,
                        grid: { display: false },
                        ticks: { color: textColor, font: { size: 11 } },
                        border: { display: false }
                    }
                }
            };
        }

        function safeJsonParse(jsonString, fallback = []) {
            try {
                if (!jsonString || jsonString === 'None' || jsonString === 'null' ||
                    jsonString === '""' || jsonString === "''") {
                    return fallback;
                }

                let parsedString = jsonString;
                if (typeof jsonString === 'string') {
                    parsedString = jsonString.replace(/None/g, 'null');
                    parsedString = parsedString.replace(/'/g, '"');
                }

                const parsed = JSON.parse(parsedString);
                return Array.isArray(parsed) ? parsed : fallback;
            } catch (error) {
                console.error('Error parsing JSON:', jsonString, error);
                return fallback;
            }
        }

        function sortDataDescending(labels, data) {
            const combined = labels.map((label, index) => ({
                label,
                value: data[index] || 0
            }));

            combined.sort((a, b) => b.value - a.value);

            const sortedLabels = combined.map(item => item.label);
            const sortedData = combined.map(item => item.value);

            return { sortedLabels, sortedData };
        }

        // Revenue Comparison Chart (Laundry vs Hotel)
        const revenueComparisonCanvas = document.getElementById('revenueComparisonChart');
        if (revenueComparisonCanvas) {
            const revenueLabels = safeJsonParse('{{ revenue_comparison_labels|safe }}');
            const revenueData = safeJsonParse('{{ revenue_comparison_data|safe }}');
            const revenueColors = safeJsonParse('{{ revenue_comparison_colors|safe }}');

            if (revenueLabels.length > 0 && revenueData.length > 0) {
                const revenueCtx = revenueComparisonCanvas.getContext('2d');

                new Chart(revenueCtx, {
                    type: 'doughnut',
                    data: {
                        labels: revenueLabels,
                        datasets: [{
                            data: revenueData,
                            backgroundColor: revenueColors.length > 0 ? revenueColors : [
                                COLOR_PALETTE.blue,
                                COLOR_PALETTE.red
                            ],
                            borderWidth: 0,
                            cutout: '70%',
                            spacing: 0,
                            hoverOffset: 4,
                            borderRadius: 0
                        }]
                    },
                    options: {
                        ...getChartOptions(),
                        plugins: {
                            ...getChartOptions().plugins,
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 10,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    boxWidth: 8,
                                    boxHeight: 8,
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    }
                                }
                            },
                            tooltip: {
                                ...getChartOptions().plugins.tooltip,
                                callbacks: {
                                    label: function (context) {
                                        return 'Ksh ' + context.parsed.toLocaleString('en-US');
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Revenue Chart (Shop Distribution)
        const revenueCanvas = document.getElementById('revenueChart');
        if (revenueCanvas) {
            const revenueLabels = safeJsonParse('{{ pie_chart_labels|safe }}');
            const revenueValues = safeJsonParse('{{ pie_chart_values|safe }}');

            if (revenueLabels.length > 0 && revenueValues.length > 0 &&
                revenueLabels.length === revenueValues.length) {

                const revenueCtx = revenueCanvas.getContext('2d');

                new Chart(revenueCtx, {
                    type: 'doughnut',
                    data: {
                        labels: revenueLabels,
                        datasets: [{
                            data: revenueValues,
                            backgroundColor: [
                                COLOR_PALETTE.navyBlue,
                                COLOR_PALETTE.orangeYellow,
                                COLOR_PALETTE.lightOrange,
                                COLOR_PALETTE.pink,
                                COLOR_PALETTE.lightPink,
                                COLOR_PALETTE.success,
                                COLOR_PALETTE.info
                            ],
                            borderWidth: 0,
                            cutout: '70%',
                            spacing: 0,
                            hoverOffset: 4,
                            borderRadius: 0
                        }]
                    },
                    options: {
                        ...getChartOptions(),
                        plugins: {
                            ...getChartOptions().plugins,
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 10,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    boxWidth: 8,
                                    boxHeight: 8,
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn('No valid data for revenue chart');
                revenueCanvas.style.display = 'none';
                const message = document.createElement('div');
                message.className = 'flex flex-col items-center justify-center h-full text-center';
                message.innerHTML = '<i class="fas fa-chart-pie text-4xl text-gray-400 mb-4"></i><p class="text-gray-500">No revenue data available</p>';
                revenueCanvas.parentNode.appendChild(message);
            }
        }

        // Trend Chart
        const trendCanvas = document.getElementById('trendChart');
        if (trendCanvas) {
            const lineData = safeJsonParse('{{ line_chart_data|safe }}');

            if (lineData && lineData.length > 0 && lineData[0] && lineData[0].months) {
                const trendCtx = trendCanvas.getContext('2d');
                const lineColors = [
                    COLOR_PALETTE.pink,
                    COLOR_PALETTE.orangeYellow,
                    COLOR_PALETTE.navyBlue,
                    COLOR_PALETTE.success,
                    COLOR_PALETTE.info
                ];

                const datasets = lineData.map((series, index) => ({
                    label: series.label || `Series ${index + 1}`,
                    data: series.data || [],
                    borderColor: lineColors[index % lineColors.length],
                    backgroundColor: `${lineColors[index % lineColors.length]}20`,
                    borderWidth: 1,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    pointBackgroundColor: lineColors[index % lineColors.length],
                    fill: true,
                    cubicInterpolationMode: 'monotone'
                }));

                new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: lineData[0].months,
                        datasets: datasets
                    },
                    options: {
                        ...getChartOptions(),
                        scales: {
                            x: {
                                display: true,
                                grid: { display: false },
                                ticks: {
                                    color: getChartOptions().scales.x.ticks.color,
                                    maxRotation: 0,
                                    padding: 10
                                }
                            },
                            y: {
                                display: false,
                                grid: { display: false }
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                });
            } else {
                console.warn('No valid data for trend chart');
                trendCanvas.style.display = 'none';
                const message = document.createElement('div');
                message.className = 'flex flex-col items-center justify-center h-full text-center';
                message.innerHTML = '<i class="fas fa-chart-line text-4xl text-gray-400 mb-4"></i><p class="text-gray-500">No trend data available</p>';
                trendCanvas.parentNode.appendChild(message);
            }
        }

        // Bar Charts
        const createBarChart = (id, labels, data, title) => {
            const canvas = document.getElementById(id);
            if (!canvas) return;

            if (labels.length > 0 && data.length > 0 && labels.length === data.length) {
                const { sortedLabels, sortedData } = sortDataDescending(labels, data);

                const ctx = canvas.getContext('2d');
                const barColors = [
                    COLOR_PALETTE.navyBlue,
                    COLOR_PALETTE.orangeYellow,
                    COLOR_PALETTE.pink,
                    COLOR_PALETTE.lightPink,
                    COLOR_PALETTE.success,
                    COLOR_PALETTE.info,
                    COLOR_PALETTE.warning
                ];

                const customTooltip = {
                    callbacks: {
                        title: function (context) {
                            return context[0].label || '';
                        },
                        label: function (context) {
                            if (id === 'servicesChart') {
                                return `${context.parsed.x.toLocaleString('en-US')} orders`;
                            }
                            return context.parsed.x.toLocaleString('en-US');
                        }
                    }
                };

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedLabels,
                        datasets: [{
                            data: sortedData,
                            backgroundColor: sortedLabels.map((_, index) => barColors[index % barColors.length]),
                            borderRadius: 8,
                            borderWidth: 0,
                            barThickness: 10,
                            categoryPercentage: 0.8,
                            barPercentage: 0.9
                        }]
                    },
                    options: {
                        ...getChartOptions(),
                        indexAxis: 'y',
                        plugins: {
                            ...getChartOptions().plugins,
                            legend: {
                                display: false
                            },
                            tooltip: id === 'productsChart' ? { enabled: false } : {
                                ...getChartOptions().plugins.tooltip,
                                callbacks: customTooltip.callbacks
                            }
                        },
                        scales: {
                            y: {
                                display: true,
                                grid: { display: false },
                                ticks: {
                                    color: getChartOptions().scales.x.ticks.color,
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    },
                                    padding: 8
                                }
                            },
                            x: {
                                display: true,
                                grid: { display: false },
                                ticks: {
                                    color: getChartOptions().scales.x.ticks.color,
                                    font: { size: 10 }
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn(`No valid data for ${title} chart`);
                canvas.style.display = 'none';
                const message = document.createElement('div');
                message.className = 'flex flex-col items-center justify-center h-full text-center';
                message.innerHTML = `<i class="fas ${id === 'servicesChart' ? 'fa-concierge-bell' : 'fa-box'} text-4xl text-gray-400 mb-4"></i><p class="text-gray-500">No ${title.toLowerCase()} data available</p>`;
                canvas.parentNode.appendChild(message);
            }
        };

        // Initialize bar charts
        createBarChart('servicesChart',
            safeJsonParse('{{ services_labels|safe }}'),
            safeJsonParse('{{ services_counts|safe }}'),
            'Services');

        createBarChart('productsChart',
            safeJsonParse('{{ item_labels|safe }}'),
            safeJsonParse('{{ item_counts|safe }}'),
            'Products');
    }

    // Initialize charts when DOM is loaded
    document.addEventListener("DOMContentLoaded", function () {
        if (typeof Chart !== 'undefined') {
            initializeCharts();
        } else {
            const checkChart = setInterval(function () {
                if (typeof Chart !== 'undefined') {
                    clearInterval(checkChart);
                    initializeCharts();
                }
            }, 100);
        }
    });
</script>

{% endblock %}