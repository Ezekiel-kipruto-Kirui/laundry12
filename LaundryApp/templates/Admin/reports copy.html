{% extends "../home.html" %}
{% load static %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div id="content-main" class="min-h-screen  p-6">
    <!-- Dashboard Header -->
    <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white flex items-center gap-3">
            <i class="fas fa-chart-line text-pink-500"></i>
            Business Dashboard
        </h1>
    </div>

    <!-- Date Range Filter Section -->
    <div
        class="bg-primary-dark dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-4 shadow-sm mb-6">
        <form method="get" id="filterForm" class="flex items-center gap-4 flex-wrap">
            <!-- Year Input -->
            <div class="flex items-center gap-2">
                <label for="year"
                    class="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">Year:</label>
                <input type="number" id="year" name="year" value="{{ selected_year }}" min="2020" max="2100"
                    class="bg-transparent border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 text-gray-700 dark:text-gray-300 w-24 focus:outline-none focus:ring-2 focus:ring-pink-500">
            </div>

            <!-- Month Selector -->
            <div class="flex items-center gap-2">
                <label for="month"
                    class="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">Month:</label>
                <input type="month" id="month" name="month"
                    value="{% if selected_month %}{{ selected_year }}-{{ selected_month|stringformat:'02d' }}{% endif %}"
                    class="bg-transparent border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 text-gray-700 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500">
            </div>
            <!-- Date Range -->
            <div class="flex items-center gap-2">
                <label for="from_date"
                    class="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">From:</label>
                <input type="date" id="from_date" name="from_date" value="{% if from_date %}{{ from_date }}{% endif %}"
                    class="bg-transparent border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 text-gray-700 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500">
            </div>
            <div class="flex items-center gap-2">
                <label for="to_date"
                    class="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">To:</label>
                <input type="date" id="to_date" name="to_date" value="{% if to_date %}{{ to_date }}{% endif %}"
                    class="bg-transparent border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 text-gray-700 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500">
            </div>

            <div class="flex gap-2 ml-auto">
                <button type="submit"
                    class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-md font-medium transition-all duration-300 flex items-center gap-2">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
                <button type="button" id="resetFilters"
                    class="bg-transparent border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 px-4 py-2 rounded-md font-medium transition-all duration-300 flex items-center gap-2">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>
        </form>
    </div>

    <!-- Overall Stats -->
    <h2
        class="text-xl font-semibold text-gray-800 dark:text-white mb-4 pl-3 border-l-4 border-pink-500 flex items-center gap-2">
        <i class="fas fa-store text-pink-500"></i> General
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- Total Revenue -->
        <div
            class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-t-4 border-green-500">
            <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 rounded-lg bg-green-50 dark:bg-green-900/20 flex items-center justify-center">
                    <i class="fas fa-wallet text-green-500 text-lg"></i>
                </div>
            </div>
            <div>
                <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Total Revenue
                </h3>
                <div class="text-2xl font-bold text-gray-800 dark:text-white mt-1">Ksh
                    {{total_revenue|floatformat:2|default:"0.00" }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Total earnings</div>
            </div>
        </div>

        <!-- Total Orders -->
        <div
            class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-t-4 border-pink-500">
            <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 rounded-lg bg-pink-50 dark:bg-pink-900/20 flex items-center justify-center">
                    <i class="fas fa-shopping-bag text-pink-500 text-lg"></i>
                </div>
            </div>
            <div>
                <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Total Orders
                </h3>
                <div class="text-2xl font-bold text-gray-800 dark:text-white mt-1">{{ total_orders }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">All time orders</div>
            </div>
        </div>



        <!-- Pending Orders -->
        <div
            class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-t-4 border-yellow-500">
            <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 flex items-center justify-center">
                    <i class="fas fa-clock text-yellow-500 text-lg"></i>
                </div>
            </div>
            <div>
                <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Pending
                    Orders</h3>
                <div class="text-2xl font-bold text-gray-800 dark:text-white mt-1">{{ pending_orders }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Awaiting processing</div>
            </div>
        </div>

        <!-- Completed Orders -->
        <div
            class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-t-4 border-blue-500">
            <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 rounded-lg bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center">
                    <i class="fas fa-check-circle text-blue-500 text-lg"></i>
                </div>
            </div>
            <div>
                <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Completed
                    Orders</h3>
                <div class="text-2xl font-bold text-gray-800 dark:text-white mt-1">{{ completed_orders }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Successfully delivered</div>
            </div>
        </div>
    </div>

    <!-- Shop A Stats -->
    <div class="mb-8">
        <h2
            class="text-xl font-semibold text-gray-800 dark:text-white mb-4 pl-3 border-l-4 border-pink-500 flex items-center gap-2">
            <i class="fas fa-store text-pink-500"></i> Shop A
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Shop A Revenue -->
            <div
                class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-t-4 border-green-500">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-lg bg-green-50 dark:bg-green-900/20 flex items-center justify-center">
                        <i class="fas fa-wallet text-green-500 text-lg"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Total
                        Revenue</h3>
                    <div class="text-2xl font-bold text-gray-800 dark:text-white mt-1">Ksh {{
                        shop_a_revenue|floatformat:2|default:"0.00" }}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Shop A earnings</div>
                </div>
            </div>

            <!-- Shop A Orders -->
            <div
                class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-t-4 border-pink-500">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-lg bg-pink-50 dark:bg-pink-900/20 flex items-center justify-center">
                        <i class="fas fa-shopping-bag text-pink-500 text-lg"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Order
                        Statistics</h3>
                    <div class="text-2xl font-bold text-gray-800 dark:text-white mt-1">{{ shop_a_total_orders }}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 flex gap-2">
                        <span class="text-yellow-500">{{ shop_a_pending_orders }} pending</span> •
                        <span class="text-blue-500">{{ shop_a_completed_orders }} completed</span>
                    </div>
                </div>
            </div>

            <!-- Shop A Partial Payment -->
            <div
                class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-t-4 border-indigo-900">
                <div class="flex items-center justify-between mb-4">
                    <div
                        class="w-10 h-10 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 flex items-center justify-center">
                        <i class="fas fa-money-bill-wave text-indigo-900 text-lg"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Payments
                    </h3>
                    <div class="text-2xl font-bold text-gray-800 dark:text-white mt-1">{{ shop_a_completed_order }}
                    </div>
                    <span class="text-yellow-500">{{ pending_payments }} pending</span> •
                    <span class="text-blue-500">{{ partial_payments }} Partial</span>
                    <span class="text-blue-500">{{ partial_payments }} completed</span>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Advanced payments</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shop B Stats -->
    <div class="mb-8">
        <h2
            class="text-xl font-semibold text-gray-800 dark:text-white mb-4 pl-3 border-l-4 border-yellow-500 flex items-center gap-2">
            <i class="fas fa-store text-yellow-500"></i> Shop B Performance
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Shop B Revenue -->
            <div
                class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-t-4 border-green-500">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-lg bg-green-50 dark:bg-green-900/20 flex items-center justify-center">
                        <i class="fas fa-wallet text-green-500 text-lg"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Total
                        Revenue</h3>
                    <div class="text-2xl font-bold text-gray-800 dark:text-white mt-1">Ksh
                        {{shop_b_revenue|floatformat:2|default:"0.00" }}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Shop B earnings</div>
                </div>
            </div>

            <!-- Shop B Orders -->
            <div
                class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-t-4 border-pink-500">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-lg bg-pink-50 dark:bg-pink-900/20 flex items-center justify-center">
                        <i class="fas fa-shopping-bag text-pink-500 text-lg"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Order
                        Statistics</h3>
                    <div class="text-2xl font-bold text-gray-800 dark:text-white mt-1">{{ shop_b_total_orders }}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 flex gap-2">
                        <span class="text-yellow-500">{{ shop_b_pending_orders }} pending</span> •
                        <span class="text-blue-500">{{ shop_b_completed_orders }} completed</span>
                    </div>
                </div>
            </div>

            <!-- Shop B Partial Payment -->
            <div
                class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md border-t-4 border-indigo-900">
                <div class="flex items-center justify-between mb-4">
                    <div
                        class="w-10 h-10 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 flex items-center justify-center">
                        <i class="fas fa-money-bill-wave text-indigo-900 text-lg"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Payments
                    </h3>
                    <div class="text-2xl font-bold text-gray-800 dark:text-white mt-1">{{ shop_b_completed_orders }}

                    </div>{% for shop, stats in shop_payment_stats.items %}
                    <span class="text-yellow-500"> {{ stats.pending }} (KSh {{ stats.pending_amount }}) pending</span> •
                    <span class="text-blue-500">{{ stats.partial }} (KSh {{ stats.partial_amount }}) Partial</span>•
                    <span class="text-blue-500">{{ stats.complete }} (KSh {{ stats.collected_amount }}) completed</span>
                    {% endfor %}
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Advanced payments</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Revenue Distribution -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <div class="flex justify-between items-center mb-6">
                <h4 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fas fa-chart-pie text-yellow-500"></i>
                    Revenue Distribution
                </h4>
                <span
                    class="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200 px-3 py-1 rounded-full text-sm font-medium">Total</span>
            </div>
            <div class="h-64">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Revenue Trend -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fas fa-chart-line text-pink-500"></i>
                    Revenue Trend
                </h2>
                <span
                    class="bg-pink-100 dark:bg-pink-900/30 text-pink-800 dark:text-pink-200 px-3 py-1 rounded-full text-sm font-medium">{{
                    selected_year }}</span>
            </div>
            <div class="h-64">
                {% if not selected_month %}
                <canvas id="trendChart"></canvas>
                {% else %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-calendar-week text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Switch to yearly view</h3>
                    <p class="text-gray-500 dark:text-gray-400">Monthly trends are available in the annual overview</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Insights Section -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Top Services -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fas fa-spa text-green-500"></i>
                    Top Services
                </h2>
                <span
                    class="bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 px-3 py-1 rounded-full text-sm font-medium">{{
                    selected_year }}</span>
            </div>
            <div class="h-72">
                {% if services_labels and services_labels|length > 0 %}
                <canvas id="servicesChart"></canvas>
                {% else %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-concierge-bell text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500 dark:text-gray-400">No service data available</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Popular Products -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fas fa-box-open text-yellow-500"></i>
                    Common Items
                </h2>
                <span
                    class="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200 px-3 py-1 rounded-full text-sm font-medium">{{
                    selected_year }}</span>
            </div>
            <div class="h-72">
                {% if item_labels and item_labels|length > 0 %}
                <canvas id="productsChart"></canvas>
                {% else %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-box text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500 dark:text-gray-400">No product data available</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- VIP Customers -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fas fa-crown text-yellow-500"></i>
                    Top Customers
                </h2>
                <span
                    class="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200 px-3 py-1 rounded-full text-sm font-medium">{{
                    selected_year }}</span>
            </div>
            <div
                class="h-72 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 scrollbar-track-transparent">
                {% for customer in common_customers %}
                <div
                    class="flex items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg mb-2 transition-all duration-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div
                        class="w-9 h-9 rounded-lg bg-gradient-to-br from-pink-500 to-yellow-500 flex items-center justify-center text-white font-semibold mr-3">
                        {{ forloop.counter }}
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-800 dark:text-white">{{ customer.customer__name }}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">{{ customer.order_count }} orders</div>
                    </div>
                    <div class="font-bold text-pink-500">
                        ksh{{ customer.total_spent|floatformat:2 }}
                    </div>
                </div>
                {% empty %}
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <i class="fas fa-user-slash text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500 dark:text-gray-400">No customer data available</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    // Date Range Filter Functionality
    document.addEventListener('DOMContentLoaded', function () {
        const filterForm = document.getElementById('filterForm');
        const resetButton = document.getElementById('resetFilters');

        // Set today's date as max for date inputs
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('from_date').max = today;
        document.getElementById('to_date').max = today;

        // Reset filters functionality
        resetButton.addEventListener('click', function () {
            // Clear all filter inputs
            document.getElementById('year').value = new Date().getFullYear();
            document.getElementById('month').value = '';
            document.getElementById('from_date').value = '';
            document.getElementById('to_date').value = '';

            // Submit the form to reset filters
            filterForm.submit();
        });

        // Validate date range
        const fromDateInput = document.getElementById('from_date');
        const toDateInput = document.getElementById('to_date');

        fromDateInput.addEventListener('change', function () {
            if (this.value && toDateInput.value && this.value > toDateInput.value) {
                toDateInput.value = this.value;
            }
        });

        toDateInput.addEventListener('change', function () {
            if (this.value && fromDateInput.value && this.value < fromDateInput.value) {
                fromDateInput.value = this.value;
            }
        });

        // Auto-submit when year or month changes (optional)
        document.getElementById('year').addEventListener('change', function () {
            if (!fromDateInput.value && !toDateInput.value) {
                filterForm.submit();
            }
        });

        document.getElementById('month').addEventListener('change', function () {
            if (!fromDateInput.value && !toDateInput.value) {
                filterForm.submit();
            }
        });
    });

    // Chart initialization code
    function initializeCharts() {
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded');
            setTimeout(initializeCharts, 100);
            return;
        }

        const COLOR_PALETTE = {
            navyBlue: '#1E3A8A',
            orangeYellow: '#F59E0B',
            lightOrange: '#FBBF24',
            pink: '#EC407A',
            lightPink: '#F48FB1',
            success: '#10B981',
            warning: '#F59E0B',
            danger: '#EF4444',
            info: '#3B82F6'
        };

        function getChartOptions() {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#F1F5F9' : '#1E293B';
            const tooltipBg = isDark ? '#1E293B' : '#FFFFFF';
            const tooltipBorder = isDark ? '#334155' : '#E2E8F0';
            const tooltipText = isDark ? '#F1F5F9' : '#1E293B';

            return {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: {
                        labels: {
                            color: textColor,
                            font: {
                                size: 11,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: tooltipBg,
                        borderColor: tooltipBorder,
                        borderWidth: 1,
                        borderRadius: 12,
                        padding: 12,
                        titleColor: tooltipText,
                        bodyColor: tooltipText,
                        bodyFont: {
                            size: 14,
                            weight: '600'
                        },
                        titleFont: {
                            size: 12,
                            weight: '500'
                        },
                        callbacks: {
                            title: function (context) {
                                return context[0].label || '';
                            },
                            label: function (context) {
                                if (context.parsed.y !== undefined) {
                                    return context.parsed.y.toLocaleString('en-US');
                                } else if (context.parsed !== undefined) {
                                    return context.parsed.toLocaleString('en-US');
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: false,
                        grid: { display: false },
                        ticks: { color: textColor, font: { size: 11 } },
                        border: { display: false }
                    },
                    y: {
                        display: false,
                        grid: { display: false },
                        ticks: { color: textColor, font: { size: 11 } },
                        border: { display: false }
                    }
                }
            };
        }

        function safeJsonParse(jsonString, fallback = []) {
            try {
                if (!jsonString || jsonString === 'None' || jsonString === 'null' ||
                    jsonString === '""' || jsonString === "''") {
                    return fallback;
                }

                let parsedString = jsonString;
                if (typeof jsonString === 'string') {
                    parsedString = jsonString.replace(/None/g, 'null');
                    parsedString = parsedString.replace(/'/g, '"');
                }

                const parsed = JSON.parse(parsedString);
                return Array.isArray(parsed) ? parsed : fallback;
            } catch (error) {
                console.error('Error parsing JSON:', jsonString, error);
                return fallback;
            }
        }

        function sortDataDescending(labels, data) {
            const combined = labels.map((label, index) => ({
                label,
                value: data[index] || 0
            }));

            combined.sort((a, b) => b.value - a.value);

            const sortedLabels = combined.map(item => item.label);
            const sortedData = combined.map(item => item.value);

            return { sortedLabels, sortedData };
        }

        // Revenue Chart
        const revenueCanvas = document.getElementById('revenueChart');
        if (revenueCanvas) {
            const revenueLabels = safeJsonParse('{{ pie_chart_labels|safe }}');
            const revenueValues = safeJsonParse('{{ pie_chart_values|safe }}');

            if (revenueLabels.length > 0 && revenueValues.length > 0 &&
                revenueLabels.length === revenueValues.length) {

                const revenueCtx = revenueCanvas.getContext('2d');

                new Chart(revenueCtx, {
                    type: 'doughnut',
                    data: {
                        labels: revenueLabels,
                        datasets: [{
                            data: revenueValues,
                            backgroundColor: [
                                COLOR_PALETTE.navyBlue,
                                COLOR_PALETTE.orangeYellow,
                                COLOR_PALETTE.lightOrange,
                                COLOR_PALETTE.pink,
                                COLOR_PALETTE.lightPink,
                                COLOR_PALETTE.success,
                                COLOR_PALETTE.info
                            ],
                            borderWidth: 0,
                            cutout: '70%',
                            spacing: 0,
                            hoverOffset: 4,
                            borderRadius: 0
                        }]
                    },
                    options: {
                        ...getChartOptions(),
                        plugins: {
                            ...getChartOptions().plugins,
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 10,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    boxWidth: 8,
                                    boxHeight: 8,
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn('No valid data for revenue chart');
                revenueCanvas.style.display = 'none';
                const message = document.createElement('div');
                message.className = 'flex flex-col items-center justify-center h-full text-center';
                message.innerHTML = '<i class="fas fa-chart-pie text-4xl text-gray-400 mb-4"></i><p class="text-gray-500 dark:text-gray-400">No revenue data available</p>';
                revenueCanvas.parentNode.appendChild(message);
            }
        }

        // Trend Chart
        const trendCanvas = document.getElementById('trendChart');
        if (trendCanvas) {
            const lineData = safeJsonParse('{{ line_chart_data|safe }}');

            if (lineData && lineData.length > 0 && lineData[0] && lineData[0].months) {
                const trendCtx = trendCanvas.getContext('2d');
                const lineColors = [
                    COLOR_PALETTE.pink,
                    COLOR_PALETTE.orangeYellow,
                    COLOR_PALETTE.navyBlue,
                    COLOR_PALETTE.success,
                    COLOR_PALETTE.info
                ];

                const datasets = lineData.map((series, index) => ({
                    label: series.label || `Series ${index + 1}`,
                    data: series.data || [],
                    borderColor: lineColors[index % lineColors.length],
                    backgroundColor: `${lineColors[index % lineColors.length]}20`,
                    borderWidth: 1,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    pointBackgroundColor: lineColors[index % lineColors.length],
                    fill: true,
                    cubicInterpolationMode: 'monotone'
                }));

                new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: lineData[0].months,
                        datasets: datasets
                    },
                    options: {
                        ...getChartOptions(),
                        scales: {
                            x: {
                                display: true,
                                grid: { display: false },
                                ticks: {
                                    color: getChartOptions().scales.x.ticks.color,
                                    maxRotation: 0,
                                    padding: 10
                                }
                            },
                            y: {
                                display: false,
                                grid: { display: false }
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                });
            } else {
                console.warn('No valid data for trend chart');
                trendCanvas.style.display = 'none';
                const message = document.createElement('div');
                message.className = 'flex flex-col items-center justify-center h-full text-center';
                message.innerHTML = '<i class="fas fa-chart-line text-4xl text-gray-400 mb-4"></i><p class="text-gray-500 dark:text-gray-400">No trend data available</p>';
                trendCanvas.parentNode.appendChild(message);
            }
        }

        // Bar Charts
        const createBarChart = (id, labels, data, title) => {
            const canvas = document.getElementById(id);
            if (!canvas) return;

            if (labels.length > 0 && data.length > 0 && labels.length === data.length) {
                const { sortedLabels, sortedData } = sortDataDescending(labels, data);

                const ctx = canvas.getContext('2d');
                const barColors = [
                    COLOR_PALETTE.navyBlue,
                    COLOR_PALETTE.orangeYellow,
                    COLOR_PALETTE.pink,
                    COLOR_PALETTE.lightPink,
                    COLOR_PALETTE.success,
                    COLOR_PALETTE.info,
                    COLOR_PALETTE.warning
                ];

                const customTooltip = {
                    callbacks: {
                        title: function (context) {
                            return context[0].label || '';
                        },
                        label: function (context) {
                            if (id === 'servicesChart') {
                                return `${context.parsed.x.toLocaleString('en-US')} orders`;
                            }
                            return context.parsed.x.toLocaleString('en-US');
                        }
                    }
                };

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedLabels,
                        datasets: [{
                            data: sortedData,
                            backgroundColor: sortedLabels.map((_, index) => barColors[index % barColors.length]),
                            borderRadius: 8,
                            borderWidth: 0,
                            barThickness: 10,
                            categoryPercentage: 0.8,
                            barPercentage: 0.9
                        }]
                    },
                    options: {
                        ...getChartOptions(),
                        indexAxis: 'y',
                        plugins: {
                            ...getChartOptions().plugins,
                            legend: {
                                display: false
                            },
                            tooltip: id === 'productsChart' ? { enabled: false } : {
                                ...getChartOptions().plugins.tooltip,
                                callbacks: customTooltip.callbacks
                            }
                        },
                        scales: {
                            y: {
                                display: true,
                                grid: { display: false },
                                ticks: {
                                    color: getChartOptions().scales.x.ticks.color,
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    },
                                    padding: 8
                                }
                            },
                            x: {
                                display: true,
                                grid: { display: false },
                                ticks: {
                                    color: getChartOptions().scales.x.ticks.color,
                                    font: { size: 10 }
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn(`No valid data for ${title} chart`);
                canvas.style.display = 'none';
                const message = document.createElement('div');
                message.className = 'flex flex-col items-center justify-center h-full text-center';
                message.innerHTML = `<i class="fas ${id === 'servicesChart' ? 'fa-concierge-bell' : 'fa-box'} text-4xl text-gray-400 mb-4"></i><p class="text-gray-500 dark:text-gray-400">No ${title.toLowerCase()} data available</p>`;
                canvas.parentNode.appendChild(message);
            }
        };

        // Initialize bar charts
        createBarChart('servicesChart',
            safeJsonParse('{{ services_labels|safe }}'),
            safeJsonParse('{{ services_counts|safe }}'),
            'Services');

        createBarChart('productsChart',
            safeJsonParse('{{ item_labels|safe }}'),
            safeJsonParse('{{ item_counts|safe }}'),
            'Products');
    }

    // Initialize charts when DOM is loaded
    document.addEventListener("DOMContentLoaded", function () {
        if (typeof Chart !== 'undefined') {
            initializeCharts();
        } else {
            const checkChart = setInterval(function () {
                if (typeof Chart !== 'undefined') {
                    clearInterval(checkChart);
                    initializeCharts();
                }
            }, 100);
        }
    });
</script>
{% endblock %}



update the above code based on the changes you have made as in the code below


"""
Analytics and dashboard functionality for LaundryApp.

This module contains all analytics, reporting, and dashboard-related functionality
separated from the main admin configuration for better maintainability.
"""

# Standard library imports
import hashlib
import json
import logging
from collections import Counter, defaultdict
from functools import lru_cache
from decimal import Decimal

# Django core imports
from django.db import models
from django.db.models import (
Avg, Count, DecimalField, Q, Sum, Case, When, IntegerField
)
from django.db.models.functions import Coalesce, ExtractMonth, ExtractYear
from django.utils.timezone import now

# Local imports
from .models import Order, OrderItem

# Setup logger
logger = logging.getLogger(__name__)

# --- Constants ---
MONTHS = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
ACTIVE_ORDER_STATUSES = ['pending', 'processing', 'Completed', 'Delivered/picked'] # Statuses that count as active
orders

# Payment status constants
PAYMENT_STATUS_PENDING = 'pending'
PAYMENT_STATUS_PARTIAL = 'partial'
PAYMENT_STATUS_COMPLETE = 'complete'
PAYMENT_STATUS_OVERDUE = 'overdue'


class DashboardAnalytics:
"""
Handles all analytics and dashboard-related functionality for the laundry management system.
"""

def __init__(self, admin_instance):
self.admin_instance = admin_instance

def get_user_shops(self, request):
return self.admin_instance.get_user_shops(request)

def _get_empty_dashboard_data(self):
return {
'order_stats': {
'total_orders': 0, 'pending_orders': 0, 'completed_orders': 0,
'delivered_orders': 0, 'total_revenue': 0, 'avg_order_value': 0
},
'payment_stats': {
'pending_payments': 0,
'partial_payments': 0,
'complete_payments': 0,
'overdue_payments': 0,
'total_pending_amount': 0,
'total_partial_amount': 0,
'total_collected_amount': 0
},
'shop_payment_stats': {}, # This will hold detailed payment stats per shop
'revenue_by_shop': [],
'common_customers': [],
'payment_methods': [],
'top_services': [],
'common_items': [],
'service_types': [],
'line_chart_data': [],
'monthly_order_volume': [],
'shop_a_stats': {
'revenue': 0, 'total_orders': 0, 'pending_orders': 0, 'completed_orders': 0,
'pending_payments': 0, 'partial_payments': 0, 'complete_payments': 0
},
'shop_b_stats': {
'revenue': 0, 'total_orders': 0, 'pending_orders': 0, 'completed_orders': 0,
'pending_payments': 0, 'partial_payments': 0, 'complete_payments': 0
},
}

def _get_payment_status(self, order):
"""
Determine payment status based on order payment information.
"""
# If order has a payment_status field, use it directly
if hasattr(order, 'payment_status') and order.payment_status:
return order.payment_status

# Otherwise, calculate based on amount paid vs total price
total_price = getattr(order, 'total_price', 0) or 0
amount_paid = getattr(order, 'amount_paid', 0) or 0

if amount_paid == 0:
return PAYMENT_STATUS_PENDING
elif amount_paid < total_price: return PAYMENT_STATUS_PARTIAL elif amount_paid>= total_price:
    return PAYMENT_STATUS_COMPLETE
    else:
    return PAYMENT_STATUS_PENDING

    def _calculate_payment_stats_by_shop(self, base_queryset):
    """
    Calculate detailed payment statistics for each shop.
    Returns a dictionary with shop names as keys and payment stats as values.
    """
    shop_payment_stats = defaultdict(lambda: {
    "pending": 0,
    "partial": 0,
    "complete": 0,
    "pending_amount": Decimal("0.00"),
    "partial_amount": Decimal("0.00"),
    "collected_amount": Decimal("0.00"),
    "total_revenue": Decimal("0.00")
    })

    # Get all orders with their shop information
    orders = base_queryset.select_related('shop').only(
    'shop', 'total_price', 'amount_paid', 'order_status'
    )

    for order in orders:
    shop_name = getattr(order, 'shop', 'Unknown Shop')
    if hasattr(shop_name, 'name'):
    shop_name = shop_name.name
    else:
    shop_name = str(shop_name)

    total_price = getattr(order, 'total_price', 0) or 0
    amount_paid = getattr(order, 'amount_paid', 0) or 0

    # Update total revenue for the shop
    shop_payment_stats[shop_name]["total_revenue"] += Decimal(str(total_price))

    # Determine payment status and update counts/amounts
    if amount_paid == 0:
    shop_payment_stats[shop_name]["pending"] += 1
    shop_payment_stats[shop_name]["pending_amount"] += Decimal(str(total_price))
    elif amount_paid < total_price: shop_payment_stats[shop_name]["partial"] +=1
        shop_payment_stats[shop_name]["partial_amount"] +=Decimal(str(total_price - amount_paid))
        shop_payment_stats[shop_name]["collected_amount"] +=Decimal(str(amount_paid)) elif amount_paid>= total_price:
        shop_payment_stats[shop_name]["complete"] += 1
        shop_payment_stats[shop_name]["collected_amount"] += Decimal(str(total_price))

        return dict(shop_payment_stats)

        def _get_base_queryset(self, request, selected_year, selected_month=None, from_date=None, to_date=None,
        payment_status=None):
        """
        Get the base queryset with proper filtering for active orders, user permissions, and payment status.
        """
        base_queryset = Order.objects.filter(order_status__in=ACTIVE_ORDER_STATUSES)

        # Apply year/month if provided
        if selected_year:
        base_queryset = base_queryset.filter(delivery_date__year=selected_year)
        if selected_month:
        base_queryset = base_queryset.filter(delivery_date__month=selected_month)

        # Apply date range filter if provided
        if from_date and to_date:
        base_queryset = base_queryset.filter(delivery_date__range=[from_date, to_date])

        # Apply payment status filtering if provided
        if payment_status:
        if payment_status == PAYMENT_STATUS_PENDING:
        # Orders with no payments or zero amount paid
        base_queryset = base_queryset.filter(
        Q(amount_paid=0) | Q(amount_paid__isnull=True)
        )
        elif payment_status == PAYMENT_STATUS_PARTIAL:
        # Orders with partial payments (amount_paid > 0 but < total_price) base_queryset=base_queryset.filter(
            amount_paid__gt=0, amount_paid__lt=models.F('total_price') ) elif payment_status==PAYMENT_STATUS_COMPLETE: #
            Orders with complete payments (amount_paid>= total_price)
            base_queryset = base_queryset.filter(
            amount_paid__gte=models.F('total_price')
            )
            elif payment_status == PAYMENT_STATUS_OVERDUE:
            # Orders that are overdue
            base_queryset = base_queryset.filter(
            Q(delivery_date__lt=now().date()) &
            (Q(amount_paid__lt=models.F('total_price')) | Q(amount_paid__isnull=True))
            )

            # Apply shop filtering if user is not superuser
            user_shops = self.get_user_shops(request)
            if user_shops is not None:
            if user_shops:
            base_queryset = base_queryset.filter(shop__in=user_shops)
            else:
            base_queryset = Order.objects.none()

            return base_queryset

            def _calculate_payment_stats(self, base_queryset):
            """
            Calculate comprehensive payment statistics from the base queryset.
            """
            # Aggregate payment statistics
            payment_stats = base_queryset.aggregate(
            total_orders=Count('id'),
            pending_payments=Count('id', filter=Q(amount_paid=0) | Q(amount_paid__isnull=True)),
            partial_payments=Count('id', filter=Q(amount_paid__gt=0, amount_paid__lt=models.F('total_price'))),
            complete_payments=Count('id', filter=Q(amount_paid__gte=models.F('total_price'))),
            total_pending_amount=Coalesce(
            Sum(
            Case(
            When(Q(amount_paid=0) | Q(amount_paid__isnull=True), then=models.F('total_price')),
            default=0,
            output_field=DecimalField()
            )
            ), 0, output_field=DecimalField()
            ),
            total_partial_amount=Coalesce(
            Sum(
            Case(
            When(Q(amount_paid__gt=0) & Q(amount_paid__lt=models.F('total_price')),
            then=models.F('total_price') - models.F('amount_paid')),
            default=0,
            output_field=DecimalField()
            )
            ), 0, output_field=DecimalField()
            ),
            total_collected_amount=Coalesce(Sum('amount_paid'), 0, output_field=DecimalField()),
            total_revenue=Coalesce(Sum('total_price'), 0, output_field=DecimalField())
            )

            # Calculate overdue payments (orders with delivery date passed but not fully paid)
            overdue_stats = base_queryset.filter(
            delivery_date__lt=now().date()
            ).aggregate(
            overdue_payments=Count('id', filter=Q(amount_paid__lt=models.F('total_price'))),
            total_overdue_amount=Coalesce(
            Sum(
            Case(
            When(Q(amount_paid__lt=models.F('total_price')),
            then=models.F('total_price') - models.F('amount_paid')),
            default=0,
            output_field=DecimalField()
            )
            ), 0, output_field=DecimalField()
            )
            )

            payment_stats.update(overdue_stats)

            return payment_stats

            @lru_cache(maxsize=32)
            def _get_common_items_data(self, order_ids):
            order_item_data = OrderItem.objects.filter(order_id__in=order_ids)
            all_items = []
            for item in order_item_data.only('itemname'):
            if item.itemname:
            item_list = [i.strip() for i in item.itemname.split(',') if i.strip()]
            all_items.extend(item_list)
            item_counter = Counter(all_items)
            return [{'itemname': item, 'count': count} for item, count in item_counter.most_common(5)]

            def get_dashboard_data(self, request, selected_year, selected_month=None, from_date=None, to_date=None,
            payment_status=None):
            """
            Fetch comprehensive dashboard data with optimized queries and shop-based filtering.
            Supports year/month filtering, from-to date range, and payment status filtering.
            """
            try:
            base_queryset = self._get_base_queryset(request, selected_year, selected_month, from_date, to_date,
            payment_status)

            if not base_queryset.exists():
            return self._get_empty_dashboard_data()

            # Get order statistics
            order_stats = base_queryset.aggregate(
            total_orders=Count('id'),
            pending_orders=Count('id', filter=Q(order_status='pending')),
            completed_orders=Count('id', filter=Q(order_status='Completed')),
            delivered_orders=Count('id', filter=Q(order_status='Delivered/picked')),
            total_revenue=Coalesce(Sum('total_price'), 0, output_field=DecimalField()),
            avg_order_value=Coalesce(Avg('total_price'), 0, output_field=DecimalField())
            )

            # Get payment statistics
            payment_stats = self._calculate_payment_stats(base_queryset)

            # Get detailed payment statistics by shop
            shop_payment_stats = self._calculate_payment_stats_by_shop(base_queryset)

            # Shop-specific statistics with payment info
            shop_a_stats = base_queryset.filter(shop='Shop A').aggregate(
            revenue=Coalesce(Sum('total_price'), 0, output_field=DecimalField()),
            total_orders=Count('id'),
            pending_orders=Count('id', filter=Q(order_status='pending')),
            completed_orders=Count('id', filter=Q(order_status='Completed')),
            pending_payments=Count('id', filter=Q(amount_paid=0) | Q(amount_paid__isnull=True)),
            partial_payments=Count('id', filter=Q(amount_paid__gt=0, amount_paid__lt=models.F('total_price'))),
            complete_payments=Count('id', filter=Q(amount_paid__gte=models.F('total_price')))
            )

            shop_b_stats = base_queryset.filter(shop='Shop B').aggregate(
            revenue=Coalesce(Sum('total_price'), 0, output_field=DecimalField()),
            total_orders=Count('id'),
            pending_orders=Count('id', filter=Q(order_status='pending')),
            completed_orders=Count('id', filter=Q(order_status='Completed')),
            pending_payments=Count('id', filter=Q(amount_paid=0) | Q(amount_paid__isnull=True)),
            partial_payments=Count('id', filter=Q(amount_paid__gt=0, amount_paid__lt=models.F('total_price'))),
            complete_payments=Count('id', filter=Q(amount_paid__gte=models.F('total_price')))
            )

            # Additional analytics data
            revenue_by_shop = list(base_queryset.values('shop').annotate(
            total_revenue=Sum('total_price')
            ).order_by('-total_revenue'))

            common_customers = list(base_queryset.values(
            'customer__name', 'customer__phone'
            ).annotate(
            order_count=Count('id'),
            total_spent=Sum('total_price')
            ).order_by('-order_count')[:5])

            payment_methods = list(base_queryset.values('payment_type').annotate(
            count=Count('id')
            ).order_by('-count'))

            order_ids = list(base_queryset.values_list('id', flat=True))

            top_services = list(OrderItem.objects.filter(
            order_id__in=order_ids
            ).values('servicetype').annotate(
            count=Count('id')
            ).order_by('-count')[:5])

            common_items = self._get_common_items_data(tuple(order_ids))

            service_types = list(OrderItem.objects.filter(
            order_id__in=order_ids
            ).values('servicetype').annotate(
            count=Count('id')
            ).order_by('-count'))

            line_chart_data = []
            monthly_order_volume = []

            if not selected_month and not (from_date and to_date):
            user_shops = self.get_user_shops(request)
            if user_shops is None:
            shops = [choice[0] for choice in Order._meta.get_field('shop').choices]
            else:
            shops = user_shops

            for shop in shops:
            monthly_data = base_queryset.filter(shop=shop).annotate(
            month=ExtractMonth('delivery_date')
            ).values('month').annotate(
            revenue=Coalesce(Sum('total_price'), 0, output_field=DecimalField())
            ).order_by('month')

            revenue_by_month = {item['month']: float(item['revenue']) for item in monthly_data}
            monthly_values = [revenue_by_month.get(month, 0) for month in range(1, 13)]

            if any(monthly_values):
            color_seed = shop.encode('utf-8')
            hex_color = hashlib.md5(color_seed).hexdigest()[0:6]
            line_chart_data.append({
            'label': shop,
            'data': monthly_values,
            'borderColor': f'#{hex_color}',
            'fill': False,
            'months': MONTHS
            })

            monthly_order_volume = [
            base_queryset.filter(delivery_date__month=month).count()
            for month in range(1, 13)
            ]

            return {
            'order_stats': order_stats,
            'payment_stats': payment_stats,
            'shop_payment_stats': shop_payment_stats, # Add detailed shop payment stats
            'revenue_by_shop': revenue_by_shop,
            'common_customers': common_customers,
            'payment_methods': payment_methods,
            'top_services': top_services,
            'common_items': common_items,
            'service_types': service_types,
            'line_chart_data': line_chart_data,
            'monthly_order_volume': monthly_order_volume,
            'shop_a_stats': shop_a_stats,
            'shop_b_stats': shop_b_stats,
            }

            except Exception as e:
            logger.error(f"Error in get_dashboard_data: {e}")
            return self._get_empty_dashboard_data()

            def sanitize_for_json(self, value):
            if isinstance(value, str):
            cleaned = ''.join(char for char in value if ord(char) >= 32 or char in '\t\n\r')
            cleaned = cleaned.replace('\\', '\\\\').replace('"', '\\"').replace('\n', '\\n').replace('\r',
            '\\r').replace('\t', '\\t')
            return cleaned
            elif isinstance(value, (int, float)):
            return value
            elif value is None:
            return None
            else:
            return self.sanitize_for_json(str(value))

            def prepare_dashboard_context(self, request, data, selected_year, selected_month=None, from_date=None,
            to_date=None, payment_status=None):
            years = Order.objects.filter(
            order_status__in=ACTIVE_ORDER_STATUSES
            ).annotate(
            year=ExtractYear('delivery_date')
            ).values_list('year', flat=True).distinct().order_by('year')

            sanitized_revenue_by_shop = [
            {'shop': self.sanitize_for_json(item['shop']), 'total_revenue': item['total_revenue']}
            for item in data['revenue_by_shop']
            ]

            sanitized_top_services = [
            {'servicetype': self.sanitize_for_json(item['servicetype']), 'count': item['count']}
            for item in data['top_services']
            ]

            sanitized_common_items = [
            {'itemname': self.sanitize_for_json(item['itemname']), 'count': item['count']}
            for item in data['common_items']
            ]

            sanitized_payment_methods = [
            {'payment_type': self.sanitize_for_json(item['payment_type']), 'count': item['count']}
            for item in data['payment_methods']
            ]

            sanitized_service_types = [
            {'servicetype': self.sanitize_for_json(item['servicetype']), 'count': item['count']}
            for item in data['service_types']
            ]

            sanitized_line_chart_data = []
            for series in data['line_chart_data']:
            sanitized_series = series.copy()
            sanitized_series['label'] = self.sanitize_for_json(series['label'])
            sanitized_line_chart_data.append(sanitized_series)

            context = {
            'title': 'Business Dashboard',
            'current_year': selected_year,
            'selected_month': selected_month,
            'from_date': from_date,
            'to_date': to_date,
            'payment_status': payment_status,
            'years': list(years),

            # Order statistics
            'total_revenue': data['order_stats']['total_revenue'],
            'total_orders': data['order_stats']['total_orders'],
            'pending_orders': data['order_stats']['pending_orders'],
            'completed_orders': data['order_stats']['completed_orders'],
            'delivered_orders': data['order_stats']['delivered_orders'],
            'avg_order_value': data['order_stats']['avg_order_value'],

            # Payment statistics
            'pending_payments': data['payment_stats']['pending_payments'],
            'partial_payments': data['payment_stats']['partial_payments'],
            'complete_payments': data['payment_stats']['complete_payments'],
            'overdue_payments': data['payment_stats'].get('overdue_payments', 0),
            'total_pending_amount': data['payment_stats']['total_pending_amount'],
            'total_partial_amount': data['payment_stats']['total_partial_amount'],
            'total_collected_amount': data['payment_stats']['total_collected_amount'],
            'total_overdue_amount': data['payment_stats'].get('total_overdue_amount', 0),

            # Detailed shop payment statistics - THIS IS WHAT YOU NEED
            'shop_payment_stats': data['shop_payment_stats'],

            # Shop A statistics
            'shop_a_revenue': data['shop_a_stats']['revenue'],
            'shop_a_total_orders': data['shop_a_stats']['total_orders'],
            'shop_a_pending_orders': data['shop_a_stats']['pending_orders'],
            'shop_a_completed_orders': data['shop_a_stats']['completed_orders'],
            'shop_a_pending_payments': data['shop_a_stats']['pending_payments'],
            'shop_a_partial_payments': data['shop_a_stats']['partial_payments'],
            'shop_a_complete_payments': data['shop_a_stats']['complete_payments'],

            # Shop B statistics
            'shop_b_revenue': data['shop_b_stats']['revenue'],
            'shop_b_total_orders': data['shop_b_stats']['total_orders'],
            'shop_b_pending_orders': data['shop_b_stats']['pending_orders'],
            'shop_b_completed_orders': data['shop_b_stats']['completed_orders'],
            'shop_b_pending_payments': data['shop_b_stats']['pending_payments'],
            'shop_b_partial_payments': data['shop_b_stats']['partial_payments'],
            'shop_b_complete_payments': data['shop_b_stats']['complete_payments'],

            # Chart data
            'pie_chart_labels': json.dumps([item['shop'] for item in sanitized_revenue_by_shop]),
            'pie_chart_values': json.dumps([float(item['total_revenue']) for item in sanitized_revenue_by_shop]),

            'line_chart_data': json.dumps(sanitized_line_chart_data),

            'services_labels': json.dumps([item['servicetype'] for item in sanitized_top_services]),
            'services_counts': json.dumps([item['count'] for item in sanitized_top_services]),

            'item_labels': json.dumps([item['itemname'] for item in sanitized_common_items]),
            'item_counts': json.dumps([item['count'] for item in sanitized_common_items]),

            'payment_method_labels': json.dumps([item['payment_type'] for item in sanitized_payment_methods]),
            'payment_method_counts': json.dumps([item['count'] for item in sanitized_payment_methods]),

            'service_type_labels': json.dumps([item['servicetype'] for item in sanitized_service_types]),
            'service_type_counts': json.dumps([item['count'] for item in sanitized_service_types]),

            'monthly_order_volume': json.dumps(data['monthly_order_volume']),
            'common_customers': data['common_customers'],
            }

            return context


            def should_count_order(order_status):
            return order_status in ACTIVE_ORDER_STATUSES


            from django.db.models.signals import post_save
            from django.dispatch import receiver

            @receiver(post_save, sender=Order)
            def clear_analytics_cache_on_order_change(sender, instance, **kwargs):
            try:
            dashboard_analytics = DashboardAnalytics(None)
            dashboard_analytics._get_common_items_data.cache_clear()
            except Exception as e:
            logger.error(f"Error clearing analytics cache: {e}")